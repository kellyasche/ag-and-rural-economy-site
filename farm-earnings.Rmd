---
title: "Farm earnings"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

<br>

# Summary of farm earnings

**Definition of farm earnings:** Farm labor and proprietors’ income is comprised of the net income of sole proprietors, partners, and hired laborers arising directly from the current production of agricultural commodities, either livestock or crops. It includes net farm proprietors’ income and the wages and salaries, pay-in-kind, and other labor income of hired farm laborers; but specifically excludes the income of farm corporations. (Bureau of Economic Analysis).

An analysis of farm earnings highlights a couple of trends;

* Farm earnings across the state peaked between 2010 - 2013. In 2018, farm earnings are lower in every single county than in previous years. In some cases, farm earnings are at levels earned in the early 2000s.

* In 2018 (most recent year of data collection), there were 33 counties that have lower total earnings than during the peak years of crop prices. All other counties are experiencing their highest earnings in history. All 33 counties are located on the western and southern sides of Minnesota where agriculture plays a larger role in the local economy.


The table below provides the 14 of those 33 counties that the analysis identified as being most impacted by the downturn in farm earnings. Of the counties that seem to most impacted by farm earnings:

* all of them have had their total earnings drop by more than 15% since the peak farm years;
* all of them have had their contributions from farm earnings to total earnings drop by more than 15 percentage points;
* all of them have had their drop in farm earnings make up a majority of the total losses across all industries;
* 8 of them are entirely rural, 5 are a town/rural mix and 1 has a urban/town/rural mix; 
* 13 of them are located in the Southwest or Northwest planning regions; and,
* 11 of them are located in EDRs 1, 4, 6W, or 8.

<br>

```{r most impacted counties table, cache = TRUE}
impacted.counties.table <- read_csv("Data/Earnings/counties-most-impacted-table.csv")

datatable(impacted.counties.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatPercentage(7) %>%
  formatPercentage(9) %>%
  formatCurrency(8, "")

```

<br>
 
# Analysis

This analysis examines the impact farm earnings has on total earnings across Minnesota. We do this through the following sections;

**Change in farm earnings vs. total earnings since 2001**: We will examine the trends in farm earnings and identify any regions whose *total* earnings shows similar trends. This would mean that farm earnings has an out sized impact on the total earnings for the region.

**Farm earnings as a % of total earnings**: It's likely that farm earnings as a percentage of total earnings increased during the crop commodity boom and similarly decreased. However, there will be certain regions that have significantly higher percentages during low and high times. We want to identify those areas. 

**Peak farm earnings vs. peak total earnings**: We already expect that farm earnings likely peaked between 2010 and 2013. However, the economy has been growing across the state despite the Ag economy downturn. Regions that aren't heavily reliant on Ag should see their total earnings continue to grow, thus their peak year should be the most recent data year - 2018. In cases where farm earnings play a larger role, we would expect to see their total earnings peak between 2010 - 2013. We want to begin identifying those counties.

**Counties most disrupted by farm earnings**: Through the above analysis, we should begin to get the main characteristics of a county where farm earnings is having a larger impact on total earnings - the most likely planning region and EDRs the counties are located in, as well as some measurements and thresholds of their farm and total earnings. This section will seek to identify those exact counties.

<br>

## Change in farm earnings vs. total earnings since 2001 {.tabset}

The charts below provide the change in farm earnings and total earnings by indexing the values to their 2001 levels. The trend to look for is how the fluctuations in farm earnings "appear" in the total earnings chart. If total earnings show a similar bump to farm earnings, it's likely that farm earnings has a significant influence in that region's economy.

The overall trend is that the farm earnings "bump" only appears in a few select regions and in regions that have a lot of "entirely rural" counties in them.

In addition, these "bumps" that do appear in total earnings has significantly impacted the earnings-performance of these groups/regions. For example, the entirely rural county group's 2018 total earnings equals the value they had in 2010. This is also true for the Southwest region. In particular, EDRs 8 and 6W have total earnings equal to 2010 values.

```{r prep farm earnings and total earnings, include = FALSE, cache=TRUE}
farm.earnings.county <- read_csv("Data/Earnings/Master-farm-total-earnings-county-2001-2018.csv") %>%
  mutate(farm.earnings = 1000 * farm.earnings,
         total.earnings = 1000 * total.earnings,
         pct.farm.earnings = farm.earnings / total.earnings) %>%
  group_by(GeoName, countyfp) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001]) %>%
  ungroup()

farm.earnings.ruca <- farm.earnings.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban")) 

farm.earnings.edr <- farm.earnings.county %>%
  group_by(year, edr, planning.region) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

farm.earnings.pr <- farm.earnings.county %>%
  group_by(year, planning.region) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

<br>

### RUCA

The indexed level of farm earnings across all RUCA groups shows a significant bump from 2010 - 2012 and levels dropping back down to 2001 levels or lower by 2018. Not surprisingly, the largest growth in earnings occurred in counties that are entirely rural or have a town/rural mix. Interestingly, the only significant bump in *total earnings* occurs in the entirely rural county group while all the other RUCA groups keep a pretty consistent growth line. The entirely rural county group highlights the fact that farm earnings drove the high performance in total earnings while also driving it downward.

<br>

```{r index farm earnings ruca, cache=TRUE}
fe.index.ruca <- ggplot(farm.earnings.ruca, aes(year, index.farm.earnings, color = Dem_Desc)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.ruca,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  te.index.ruca <- ggplot(farm.earnings.ruca, aes(year, index.total.earnings, color = Dem_Desc)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.ruca,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.ruca, te.index.ruca), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

### Planning Regions

When broken down by planning regions, Southwest and Northwest Minnesota seem to be the most impacted in the downturn in farm earnings. Indexes from farm earnings shows a similar bump between 2008 - 2013 across all of the regions except for the seven county metro. When comparing *total earnings* across the planning regions, those bumps are seen in the Southwest and Northwest regions with similar declines after farm earnings peaked in 2012. The Southwest region looks to be hit the hardest with 2018 total earnings equal to that of 2010 levels.

<br>

```{r index farm earnings pr, cache=TRUE}
fe.index.pr <- ggplot(farm.earnings.pr, aes(year, index.farm.earnings, color = planning.region)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed\nto 2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.pr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10),
          legend.text = element_text(size = 10))
  
  te.index.pr <- ggplot(farm.earnings.pr, aes(year, index.total.earnings, color = planning.region)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.pr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10),
          legend.text = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.pr, te.index.pr), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

### EDRs

Breaking it down further, the EDRs in the Southwest region that seem to be most influenced by farm earnings is EDR 6W - Upper Minnesota Valley and EDR 8 - Southwest. The EDRs in the Northwest region of the state most influenced by farm earnings looks to be EDR4 - West Central, and EDR 1 - Northwest.

<br>

```{r index farm earnings edr, fig.height= 12, cache=TRUE}
  fe.index.edr <- ggplot(filter(farm.earnings.edr, planning.region != "Minnesota"), aes(year, index.farm.earnings, color = edr)) +
    facet_wrap(~planning.region, ncol = 1) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.edr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 6),
          legend.text = element_text(size = 6),
          text = element_text(size = 10))
  
  te.index.edr <- ggplot(filter(farm.earnings.edr, planning.region!= "Minnesota"), aes(year, index.total.earnings, color = edr)) +
    facet_wrap(~planning.region, ncol = 1) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.edr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 6),
          legend.text = element_text(size = 6),
          text = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.edr, te.index.edr), height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

## Farm earnings as a percent of total earnings {.tabset}

The charts below provide farm earnings as a percentage of total earnings each year. The trend to see here is how much that percentage has changed over time.

Overall, the most concerning trend is that the farm earnings as a percentage of total earnings in 2018 are at their lowest levels since 2001. Although this seems to be the case across nearly all regions, it's the regions where they typically had higher percentages of their total earnings come from farming that are now not much higher than other regions that never had higher percentages. 

For example, the entirely rural county group had consistent growth in farm earnings since 2001, and typically had farm earnings make up 15% or more of their total earnings. The sudden decline in farm earnings has dropped them back down to 10% or lower. Compare that to town/rural mix county group where farm earnings peaked at 10% and is now at 3.5%. It just isn't as impactful in a positive or negative sense.

<br>

### RUCA

Not surprisingly, our most rural counties have the highest percentage of their total earnings come from farming. During peak crop prices (2010 - 2012), farm earnings made up more than 30% of total earnings in our entirely rural counties.

<br>

```{r farm earnings pct of total earnings ruca, cache=TRUE}
fe.pct.te.ruca <- ggplot(farm.earnings.ruca, aes(year, pct.farm.earnings, color = Dem_Desc)) +
          geom_smooth(se = FALSE, size = 2) +
          geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
          geom_hline(yintercept = 0, color = "black") +
          labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.ruca,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom")
          
girafe( ggobj = fe.pct.te.ruca, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### Planning regions

Not surprisingly, the Southwest and Northwest regions are influenced the most from farm earnings. The Southwest in particular has 10% or more of their total earnings from farm earnings during a more typical year and increased to between 15% and 35% when crop commodity prices were booming.

<br>

```{r farm earnings pct of total earnings pr, cache=TRUE}
fe.pct.te.pr <- ggplot(farm.earnings.pr, aes(year, pct.farm.earnings, color = planning.region)) +
          geom_smooth(se = FALSE, size = 2) +
          geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
          geom_hline(yintercept = 0, color = "black") +
          labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.pr,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom")
          
girafe( ggobj = fe.pct.te.pr, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDRs

The Northwest is a bit less dramatic overall, likely due to sugar beets being a more stable commodity than corn and soybeans and having a more diverse economy overall. However, EDR 1 has had significant fluctuation in the percentage that farm earnings comprise of total earnings in the region. It peaked in 2013 when farm earnings were 23.4% of total earnings in the region. By 2017 the earnings have dropped to 4.5%.

Everywhere else, the earnings are pretty minimal except for EDR 6E in the Central planning region. Between 5% - 15% of total earnings come from farming there.

<br>

```{r farm earnings pct of total earnings edr, fig.height=12, cache=TRUE}
fe.pct.te.edr <- ggplot(filter(farm.earnings.edr, planning.region != "Minnesota"), aes(year, pct.farm.earnings, color = edr)) +
  geom_smooth(se = FALSE, size = 2) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.edr,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom",
                text = element_text(size = 10))
          
girafe( ggobj = fe.pct.te.edr, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

<br>

## Peak farm earnings vs. peak total earnings {.tabset}

The following maps compare the years that total earnings peaked for each county as well as the years that farm earnings peaked.

For the most part, farm earnings peaked between 2010 - 2013 across the state with no county have their farm earnings peaking after 2015. On the other hand, total earnings tells a different story. A majority of counties in Minnesota have had their total earnings peak with the most recent data release year of 2018, meaning that the decrease in farm earnings did not entirely disrupt the overall growth in earnings. However, there were 33 counties, all of which are located on the western and southern side of the state, that had their total earnings peak between 2012 and 2014. This tells us that those counties are more reliant on farm earnings than other counties.

<br>

### County map - peak year of total earnings<br/>vs. farm earnings

The following map provides a comparison of trends in farm earnings and total earnings to get a better handle on the influence of farm earnings in a county's total earnings. What we expect is that total earnings will have peaked within the last few years since a counties economy should grow every year. However, since farm earnings peaked between 2010 and 2013, it's important to see which of Minnesota's counties had their total earnings peak during those years.

The map on the right makes it pretty obvious that farm earnings peaked between 2012 and 2013. What's interesting is to see that many of the counties on the western border had their total earnings peak during this time while the other counties had their total earnings continue to grow despite lower farm earnings. Overall, 33 counties in Minnesota reported total earnings in 2018 at levels below previous years. 

```{r prep county map peak year of total and farm earnings, include  = FALSE, cache=TRUE}
total.earnings.peak.year.county <- farm.earnings.county %>%
  group_by(GeoName, countyfp) %>%
  top_n(wt = total.earnings, n = 1) %>%
  ungroup() %>%
  mutate(year.bins = cut(year,
                         breaks = c(2001,2009, 2011, 2013, 2015, 2017, 2018),
                         labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  rename(te.peak.year = 4) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

farm.earnings.peak.year.county <- farm.earnings.county %>%
  group_by(GeoName, countyfp) %>%
  top_n(wt = farm.earnings, n = 1) %>%
  ungroup() %>%
  distinct(countyfp, .keep_all = TRUE) %>%
  mutate(year.bins = cut(year,
                         breaks = c(2001,2009, 2011, 2013, 2015, 2017, 2018),
                         labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  rename(fe.peak.year = 4) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))
```

```{r county map peak year of total and farm earnings, fig.width=9}
te.peak.year.map <- ggplot(filter(total.earnings.peak.year.county, GeoName != "Minnesota")) +
  geom_sf_interactive(aes(fill = year.bins, tooltip = paste(GeoName, "\nPeak year: ", te.peak.year, "\nFarm earnings as a percent of total earnings: ", percent(pct.farm.earnings), sep = ""), data_id = GeoName, geometry = geometry)) +
  scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black"))+
  theme_sf+
  labs(title="Total earnings peak year") +
  theme(text = element_text(size = 12))

te.peak.year.map.legend <- get_legend(te.peak.year.map)

fe.peak.year.map <- ggplot(filter(farm.earnings.peak.year.county, GeoName != "Minnesota")) +
  geom_sf_interactive(aes(fill = year.bins, tooltip = paste(GeoName, "\nPeak year: ", fe.peak.year, "\nFarm earnings as a percent of total earnings: ", percent(pct.farm.earnings), sep = ""), data_id = GeoName, geometry = geometry)) +
  scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black", "orange"))+
  theme_sf+
  labs(title="Farm earnings peak year") +
  theme(text = element_text(size = 12))

girafe(ggobj = plot_grid(te.peak.year.map + theme(legend.position = "none"), te.peak.year.map.legend, fe.peak.year.map + theme(legend.position = "none"), ncol = 3, rel_widths = c(3,1,3), rel_heights = c(3,3,3)), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))

```

### County maps - change in earnings<br/>from peak farm years

What we're looking for here is the extent of change in total earnings since the year in which a county's farm earnings peaked. This will help us identify which counties have been most impacted. 

Not surprisingly, some of the largest decreases in total earnings has occurred in counties in the southwestern and western parts of the state. Lac qui Parle county has experienced the largest decrease in total earnings since the peak farm year of 2013 with a drop of 40%.

<br>

```{r prep pct change in total earnings since peak farm, include = FALSE, cache=TRUE}
te.2018.county <- farm.earnings.county %>%
  filter(year == 2018) %>%
  select(3,6) %>%
  rename(total.earnings.2018 = 2)

te.change.since.farm.peak <- farm.earnings.peak.year.county %>%
  left_join(te.2018.county, by = "countyfp") %>%
  select(2,3,4,5,6,11,15,14) %>%
  mutate(te.pct.change = (total.earnings.2018 - total.earnings) / total.earnings,
         te.pct.change.bins = cut(te.pct.change,
                                  breaks = c(-1, -.25, -.1, 0, .1, .25, 1),
                                  labels = c("Greater than -25%", "-25% to -10%", "-10% to 0%", "0% to 10%", "10% to 25%", "Greater than 25%")))
names(te.change.since.farm.peak)
```

```{r maps of pct change in total earnings since peak farm}
te.pct.change.county <- ggplot(filter(te.change.since.farm.peak, GeoName != "Minnesota")) +
    geom_sf_interactive(aes(fill = te.pct.change.bins, tooltip = paste(GeoName, "\nYear of peak farm earnings: ", fe.peak.year, "\nTotal earnings that year: ", dollar(total.earnings), "\nTotal earnings in 2018: ", dollar(total.earnings.2018), "\nPercent change in total earnings: ", percent(te.pct.change), sep = ""), data_id = GeoName, geometry = geometry)) +
    scale_fill_manual(values = c("#f03b20", "#feb24c", "#ffeda0", "#C7EF99", "#6AC400", "#076324"))+
    theme_sf+
    labs(title="Percent change of total earnings\nsince year of peak farm earnings") +
  theme()
  
girafe( ggobj = te.pct.change.county, width_svg = 6) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties most disrupted by farm earnings

There are 33 counties in Minnesota that have less total earnings in 2018 than during the peak farm year. The next step is to try and isolate which counties are being most influenced by farm earnings.

The charts below compare two measurements;

* the drop in total earnings between the year they experienced the largest farm earnings and 2018, and

* the drop in the level at which farm earnings contributes to total earnings during that same time frame. 

What we are looking for is whether the counties are in similar positions across both charts. Essentially, do counties that are experiencing high drops in their total earnings also experience a significant drop in the amount that farm earnings contributes to their total earnings. 

These charts show that, yes, most counties tend to be in the same positions across each. Counties such as Lac qui Parle, Traverse, Faribault, Norman, Kittson, Renville, Murray, and Lincoln all had drops of 20% or more in their total earnings AND experienced a 20 percentage point or more drop in the amount of farm earnings contributes to their total earnings.

Other counties, such as Douglas, Lyon, McLeod, Dodge, Red Lake, and Polk experienced less significant drops in their total earnings and their contributions from farm earnings was relatively minor compared to other counties.

Interestingly, there are some counties that have experienced the opposite of each of these scenarios. Counties such as Marshall and Watonwan experienced significant declines in their contributions from farm earnings, yet their drop in total earnings was relatively minor. This means that these counties have earnings from other industries that are growing and buffering the drop in farm earnings.

Other counties such as Waseca and Stevens experienced high drops in their total earnings yet the drop in their contributions from farm earnings wasn't as significant. This means that there are a few counties that are having a few other industries contributing to the drop in total earnings besides just farm earnings.

Note: you can hover over the points to get more detailed information. In addition, not only will that particular point be highlighted, but the correspondent point will be highlighted on the other chart for you to see it's position in comparison. You can also use the tools located in the topleft position of the chart to zoom in, making it easier to hover over the points.

<br>

```{r prep change in farm earnings as pct of total earnings, include = FALSE, cache = TRUE}

fe.te.2018.county <- farm.earnings.county %>%
  filter(year == 2018) %>%
  rename(farm.earnings.2018 = 5,
         total.earnings.2018 = 6) %>% 
  select(3,5,6)

fe.te.peak.2018.county <- farm.earnings.peak.year.county %>%
  rename(farm.earnings.peak = 5,
         total.earnings.peak = 6) %>%
  left_join(fe.te.2018.county, by = "countyfp") %>%
  mutate(change.fe = farm.earnings.2018 - farm.earnings.peak,
         pct.change.fe = change.fe / farm.earnings.peak,
         change.te = total.earnings.2018 - total.earnings.peak,
         pct.change.te = change.te / total.earnings.peak) %>%
  select(2,3,4,5,15,17,18,6,16,19,20,8:10)

fe.te.peak.2018.negative.county <- fe.te.peak.2018.county %>%
  filter(change.te < 0) %>%
  mutate(pct.fe.of.te.peak = farm.earnings.peak / total.earnings.peak,
         pct.fe.of.te.2018 = farm.earnings.2018 / total.earnings.2018,
         change.pct.fe.of.te = 100 * (pct.fe.of.te.2018 - pct.fe.of.te.peak),
         GeoName = str_replace(GeoName, ", MN", ""))

names(fe.te.peak.2018.negative.county)
```

```{r point chart change in fe as pct of te, fig.width=8}

change.pct.te.plot <- ggplot(fe.te.peak.2018.negative.county, aes(x = 2018, y = pct.change.te, color = pct.change.te)) +
  geom_hline(yintercept = 0, size = 2, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = GeoName, tooltip = paste(GeoName, "\nYear farm earnings peaked: ", fe.peak.year, "\nFarm earnings during peak year: ", dollar(farm.earnings.peak), "\nTotal earnings during peak year: ", dollar(total.earnings.peak), "\nFarm earnings as percent of total\nearnings during peak year: ", percent(pct.fe.of.te.peak), "\nFarm earnings in 2018: ", dollar(farm.earnings.2018), "\nTotal earnings in 2018: ", dollar(total.earnings.2018), "\nFarm earnings as percent of total\nearnings in 2018: ", percent(pct.fe.of.te.2018), "\nChange in total earnings\nsince peak year: ", percent(pct.change.te), sep = ""))) +
  geom_label_repel(size = 3,aes(x = 2018, y = pct.change.te, label = paste(GeoName, ", ", percent(pct.change.te), sep = ""), color = pct.change.te)) +
  labs(x= "", y = "Percentage points", color="", title = "Change in farm earnings as a percent of\ntotal earnings from peak farm year")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 1)) +
  theme_line+
  scale_color_gradient(low = "#de2d26",
                       high = "black") +
  theme(legend.position = "none",
        text = element_text(size = 12))


change.fe.pct.te.plot <- ggplot(fe.te.peak.2018.negative.county, aes(x = 2018, y = change.pct.fe.of.te, color = change.pct.fe.of.te)) +
    geom_hline(yintercept = 0, size = 2, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = GeoName, tooltip = paste(GeoName, "\nYear farm earnings peaked: ", fe.peak.year, "\nFarm earnings during peak year: ", dollar(farm.earnings.peak), "\nTotal earnings during peak year: ", dollar(total.earnings.peak), "\nFarm earnings as percent of total\nearnings during peak year: ", percent(pct.fe.of.te.peak), "\nFarm earnings in 2018: ", dollar(farm.earnings.2018), "\nTotal earnings in 2018: ", dollar(total.earnings.2018), "\nFarm earnings as percent of total earnings in 2018: ", percent(pct.fe.of.te.2018), "\nPercentage point change in farm earnings as percent of total earnings: ", comma(change.pct.fe.of.te), sep = ""))) +
  geom_label_repel(size = 3, aes(x = 2018, y = change.pct.fe.of.te, label = paste(GeoName, ", ", comma(change.pct.fe.of.te), sep = ""), color = change.pct.fe.of.te)) +
  labs(x= "", y = "Percentage change", color="", title = "Change in farm earnings as a percent of\ntotal earnings from peak farm year")+
  scale_y_continuous(labels=scales::comma)+
  scale_x_continuous(breaks = seq(1900, 2050, 1)) +
  theme_line+
  scale_color_gradient(low = "#de2d26",
                       high = "black") +
  theme(legend.position = "none",
        text = element_text(size = 12))


girafe( ggobj = plot_grid(change.pct.te.plot, change.fe.pct.te.plot), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))
```

Our next step is to look a bit deeper in the counties that are most obviously having the total earnings impacted by farm earnings. To do this, we will filter out the counties that are either having other industries make up for the loss in farm earnings, or have other industries that are impacting total earnings more than farm earnings.

For the chart below we are only using counties that have experienced a drop in their total earnings of 15% or more since their peak farm year as well as a drop of 15 *percentage points* or more in their farm earnings. That leaves us with 14 counties; Faribault, Grant, Jackson, Kittson, Lac qui Parle, Lincoln, Murray, Norman, Redwood, Renville, Sibley, Stevens, Traverse, and Yellow Medicine.

Farm earnings isn't the only "industry" in which earnings have decreased in each of these counties. So, our next step is to see how much farm earnings has impacted the overall loss across all industries. To do that, we are going to sum the loss of all industries where a loss is identified since peak farm years, and divide that by the loss in farm earnings to get a sense of the impact farm earnings has had on the overall drop in total earnings.

It's likely that farm earnings has impacted all of these counties to some extent. However, it's quite clear that counties such as Traverse, Murray, Norman, Renville, Yellow Medicine, Kittson, and Grant are significantly impacted by farm earnings. In fact, of all the industries that have experienced a drop in earnings, farm earnings made up 90% of more of that loss in each of these counties.

<br>

```{r prep farm earnings pct industry loss, include = FALSE, cache= TRUE}
te.fe.drop.county <- fe.te.peak.2018.negative.county %>%
  filter(pct.change.te < -.15 & change.pct.fe.of.te < -15) %>%
  select(1,2,3)

earnings.industry <- read_csv("Data/Earnings/bea-earnings-by-industry-2001-2018.csv") %>%
  mutate(countyfp = str_sub(GeoFIPS, 3, 5))

earnings.industry.2018.county <- earnings.industry %>%
  filter(!LineCode %in% c(35, 82)) %>%
  select(27,7,26) %>%
  rename(earnings.2018 = 3) %>%
  mutate(earnings.2018 = as.numeric(earnings.2018) * 1000)

earnings.industry.peak.county <- earnings.industry %>%
  filter(!LineCode %in% c(35, 82)) %>%
  gather(key = "year", value = "earnings.peak", 9:26) %>%
  mutate(earnings.peak = as.numeric(earnings.peak) * 1000,
         year = as.integer(year)) %>%
  select(9,10,7,11)

earnings.industry.peak.2018.drop.county <- te.fe.drop.county %>%
  left_join(earnings.industry.2018.county, by = c("countyfp")) %>%
  left_join(earnings.industry.peak.county, by = c("countyfp", "fe.peak.year" = "year", "Description")) %>%
  mutate(change.earnings = earnings.2018 - earnings.peak) %>%
  filter(change.earnings < 0) %>%
  group_by(GeoName, countyfp) %>%
  summarise(farm.earnings.change = sum(change.earnings[Description == "Farm earnings"], na.rm = TRUE),
            industry.loss.earnings.change = sum(change.earnings, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(pct.fe.of.total.loss = farm.earnings.change / industry.loss.earnings.change)
names(earnings.industry.peak.2018.drop.county)
```

```{r point chart farm earnings loss pct of industry loss, fig.width=8}
earnings.industry.peak.2018.drop.county.plot <- ggplot(earnings.industry.peak.2018.drop.county, aes(x = 2018, y = pct.fe.of.total.loss, color = pct.fe.of.total.loss)) +
  geom_point_interactive(size = 3, aes(data_id = GeoName, tooltip = paste(GeoName, "\nChange in farm earnings since peak year: ", dollar(farm.earnings.change), "\nChange in earnings of all industries that experienced a loss: ", dollar(industry.loss.earnings.change), "\nFarm earnings loss as a percent of total loss: ", percent(pct.fe.of.total.loss), sep = ""))) +
  geom_label_repel(aes(x = 2018, y = pct.fe.of.total.loss, label = paste(GeoName, ", ", percent(pct.fe.of.total.loss), sep = ""), color = pct.fe.of.total.loss)) +
  labs(x= "", y = "%", color="", title = "Farm earnings loss as a percent of the total loss in all industries")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 1)) +
  theme_line+
  scale_color_gradient(high = "#de2d26",
                       low = "black") +
  theme(legend.position = "none")


girafe( ggobj = earnings.industry.peak.2018.drop.county.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```

<br>

This analysis provides us with the following characteristics of geographic areas that are likely most impacted by the drop in farm earnings:

* is an entirely rural county or has a town/rural mix;
* located in Southwest or Northwest Minnesota;
* located in the following EDRs; 1 - Northwest, 4 - West Central, 6W - Upper MN Valley, and 8 - Southwest;
* one of 33 counties who have experienced their highest levels of total earnings before 2018;
* have had their total earnings drop by 15% or more since farm earnings peaked, likely between 2010 - 2013;
* have had their farm earnings as a percentage of total earnings drop by 15 points or more since farm earnings peaked; and
* the drop in farm earnings as a percentage of the total loss across all industries is 50% or higher.

The table below provides the 14 counties that nearly fit all of these characteristics. Of the counties that seem to most impacted by farm earnings:

* all of them have had their total earnings drop by more than 15% since the peak farm years;
* all of them have had their contributions from farm earnings to total earnings drop by more than 15 percentage points;
* all of them have had their drop in farm earnings make up a majority of the total losses across all industries;
* 8 of them are entirely rural, 5 are a town/rural mix and 1 has a urban/town/rural mix; 
* 13 of them are located in the Southwest or Northwest planning regions; and,
* 11 of them are located in EDRs 1, 4, 6W, or 8.

<br>

```{r impacted counties table, cache = TRUE}
impacted.counties.match <- earnings.industry.peak.2018.drop.county %>%
  select(2,3,4,5)

te.peak.year <- farm.earnings.county %>%
  group_by(GeoName, countyfp) %>%
  top_n(n = 1, total.earnings) %>%
  ungroup() %>%
  rename(te.peak.year = 4) %>%
  select(3,4)

impacted.counties <- fe.te.peak.2018.negative.county %>%
  right_join(impacted.counties.match, by = "countyfp") %>%
  left_join(te.peak.year, by = "countyfp") %>%
  select(1,12,14,13,21,3,11,17,20) %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", "")) %>%
  rename(County = 1,
         RUCA = 2,
         "Planning Region" = 3,
         EDR = 4,
         "Total earnings - peak year" = 5,
         "Farm earning - peak year" = 6,
         "Total earnings - % change" = 7,
         "Farm earnings as % of total earnings - change" = 8,
         "Farm earnings drop as % of loss across all industries" = 9)

datatable(impacted.counties, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatPercentage(7) %>%
  formatPercentage(9) %>%
  formatCurrency(8, "")
  
```
