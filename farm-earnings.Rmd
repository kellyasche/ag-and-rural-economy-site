---
title: "Farm earnings"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

<br>

# Summary of farm earnings

**Definition of farm earnings:** Farm labor and proprietors’ income is comprised of the net income of sole proprietors, partners, and hired laborers arising directly from the current production of agricultural commodities, either livestock or crops. It includes net farm proprietors’ income and the wages and salaries, pay-in-kind, and other labor income of hired farm laborers; but specifically excludes the income of farm corporations. (Bureau of Economic Analysis).

An analysis of farm earnings highlights a couple of trends;

* Farm earnings across the state peaked between 2010 - 2013. In 2018, farm earnings are lower in every single county than in previous years. In some cases, farm earnings are at levels earned in the early 2000s.

* In 2018 (most recent year of data collection), there were 33 counties that have lower total earnings than during the peak years of crop prices. All other counties are experiencing their highest earnings in history. All 33 counties are located on the western and southern sides of Minnesota where agriculture plays a larger role in the local economy.

* It's likely that all 33 counties are influenced by the ag economy. However, 7 counties seem to have their total earning trends impacted more by farm earnings. They are; Waseca, Stevens, Lac qui Parle, Faribault, Kittson, Norman, and Murray counties. All of these counties have had declines in their total earnings that closely resemble the declines in farm earnings. The other counties are experiencing declines in their total earnings, but not nearly to the degree that their loss in farm earnings would indicate.

<br>
 
# Analysis

<br>

## Change in farm earnings vs. total earnings since 2001 {.tabset}

The charts below provide the change in farm earnings and total earnings by indexing the values to their 2001 levels. The trend to look for is how the fluctuations in farm earnings "appear" in the total earnings chart. If total earnings show a similar bump to farm earnings, it's likely that farm earnings has a significant influence in that region's economy.

The overall trend is that the farm earnings "bump" only appears in a few select regions and in regions that have a lot of "entirely rural" counties in them.

```{r prep farm earnings and total earnings, include = FALSE, cache=TRUE}
farm.earnings.county <- read_csv("Data/Earnings/Master-farm-total-earnings-county-2001-2018.csv") %>%
  mutate(farm.earnings = 1000 * farm.earnings,
         total.earnings = 1000 * total.earnings,
         pct.farm.earnings = farm.earnings / total.earnings) %>%
  group_by(GeoName, countyfp) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001]) %>%
  ungroup()

farm.earnings.ruca <- farm.earnings.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban")) 

farm.earnings.edr <- farm.earnings.county %>%
  group_by(year, edr, planning.region) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

farm.earnings.pr <- farm.earnings.county %>%
  group_by(year, planning.region) %>%
  summarise(total.earnings = sum(total.earnings),
            farm.earnings = sum(farm.earnings)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(index.farm.earnings = (farm.earnings - farm.earnings[year==2001]) / farm.earnings[year == 2001],
         index.total.earnings = (total.earnings - total.earnings[year == 2001]) / total.earnings[year == 2001]) %>%
  ungroup() %>%
  mutate(pct.farm.earnings = farm.earnings / total.earnings,
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

<br>

### RUCA

The indexed level of farm earnings across all RUCA groups shows a significant bump from 2010 - 2012 and levels dropping back down to 2001 levels or lower by 2018. Not suprisingly, the largest growth in earnings occured in counties that are entirely rural or have a town/rural mix. Interestingly, the only significant bump in *total earnings* occurs in the entirely rural county group while all the other RUCA groups keep a pretty consistent growth line.

<br>

```{r index farm earnings ruca, cache=TRUE}
fe.index.ruca <- ggplot(farm.earnings.ruca, aes(year, index.farm.earnings, color = Dem_Desc)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.ruca,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  te.index.ruca <- ggplot(farm.earnings.ruca, aes(year, index.total.earnings, color = Dem_Desc)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.ruca,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.ruca, te.index.ruca), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

### Planning Regions

When broken down by planning regions, Southwest and Northwest Minnesota seem to be the most impacted in the downturn in farm earnings. Indexes from farm earnings shows a similar bump between 2008 - 2013 across all of the regions except for the seven county metro. When comparing *total earnings* across the planning regions, those bumps are seen in the Southwest and Northwest regions with similar declines after farm earnings peaked in 2012. The Southwest region looks to be hit the hardest.

<br>

```{r index farm earnings pr, cache=TRUE}
fe.index.pr <- ggplot(farm.earnings.pr, aes(year, index.farm.earnings, color = planning.region)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed\nto 2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.pr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  te.index.pr <- ggplot(farm.earnings.pr, aes(year, index.total.earnings, color = planning.region)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.pr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.pr, te.index.pr), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

### EDRs

Breaking it down further, the EDRs in the Southwest region that seem to be most influenced by farm earnings is EDR 6W - Upper Minnesota Valley and EDR 8 - Southwest. The EDRs in the Northwest region of the state most influenced by farm earnings looks to be EDR4 - West Central, and EDR 1 - Northwest.

<br>

```{r index farm earnings edr, fig.height= 12, cache=TRUE}
  fe.index.edr <- ggplot(filter(farm.earnings.edr, planning.region != "Minnesota"), aes(year, index.farm.earnings, color = edr)) +
    facet_wrap(~planning.region, ncol = 1) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.farm.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nFarm earnings indexed to 2001 levels: ", percent(index.farm.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Farm earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.edr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 6),
          legend.text = element_text(size = 6),
          text = element_text(size = 10))
  
  te.index.edr <- ggplot(filter(farm.earnings.edr, planning.region!= "Minnesota"), aes(year, index.total.earnings, color = edr)) +
    facet_wrap(~planning.region, ncol = 1) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = index.total.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), "\nTotal earnings indexed to 2001 levels: ", percent(index.total.earnings), sep = ""))) +
    geom_hline(yintercept = 0, color = "black") +
    labs(x="", y = "", color="", title = "Total earnings indexed to\n2001 levels", caption = "BEA - Local Area Employment and Wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.edr,
                       guide = guide_legend(ncol = 2)) +
    theme(legend.position = "bottom",
          axis.text.x = element_text(size = 6),
          legend.text = element_text(size = 6),
          text = element_text(size = 10))
  
  girafe(ggobj = plot_grid(fe.index.edr, te.index.edr), height_svg = 10) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))
```

## Farm earnings as a percent of total earnings {.tabset}

The charts below provide farm earnings as a percentage of total earnings each year. The trend to see here is how much that percentage has changed over time.

Overall, the most concerning trend is that the farm earnings as a percentage of total earnings in 2018 are at their lowest levels since 2001. This seems to be the case across nearly all regions.

<br>

### RUCA

Not suprisingly, our most rural counties have the highest percentage of their total earnings come from farming. During peak crop prices (2010 - 2012), farm earnings made up more than 30% of total earnings in our entirely rural counties.

<br>

```{r farm earnings pct of total earnings ruca, cache=TRUE}
fe.pct.te.ruca <- ggplot(farm.earnings.ruca, aes(year, pct.farm.earnings, color = Dem_Desc)) +
          geom_smooth(se = FALSE, size = 2) +
          geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(Dem_Desc, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
          geom_hline(yintercept = 0, color = "black") +
          labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.ruca,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom")
          
girafe( ggobj = fe.pct.te.ruca, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### Planning regions

Not surprisingly, the Southwest and Northwest regions are influenced the most from farm earnings. The Southwest in particular has 10% or more of their total earnings from farm earnings during a more typical year and increased to between 15% and 35% when crop commodity prices were booming.

<br>

```{r farm earnings pct of total earnings pr, cache=TRUE}
fe.pct.te.pr <- ggplot(farm.earnings.pr, aes(year, pct.farm.earnings, color = planning.region)) +
          geom_smooth(se = FALSE, size = 2) +
          geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(planning.region, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
          geom_hline(yintercept = 0, color = "black") +
          labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.pr,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom")
          
girafe( ggobj = fe.pct.te.pr, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDRs

The Northwest is a bit less dramatic overall, likely due to sugar beets being a more stable commodity than corn and soybeans and having a more diverse economy overall. However, EDR 1 has had significant fluctuation in the percentage that farm earnings comprise of total earnings in the region. It peaked in 2013 when farm earnings were 23.4% of total earings in the region. By 2017 the earnings have dropped to 4.5%.

Everywhere else, the earnings are pretty minimal except for EDR 6E in the Central planning region. Between 5% - 15% of total earnings come from farming there.

<br>

```{r farm earnings pct of total earnings edr, fig.height=12, cache=TRUE}
fe.pct.te.edr <- ggplot(filter(farm.earnings.edr, planning.region != "Minnesota"), aes(year, pct.farm.earnings, color = edr)) +
  geom_smooth(se = FALSE, size = 2) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 3, aes(data_id = pct.farm.earnings, tooltip = paste(edr, ", ", year, "\nTotal earnings: ", dollar(total.earnings), "\nTotal farm earnings: ", dollar(farm.earnings), "\nPercent of earnings from farm: ", percent(pct.farm.earnings), sep = ""))) +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", color="", title = "Farm earnings as a percent of total earnings", caption = "BEA - Local Area Employment and Wages")+
          scale_y_continuous(labels=scales::percent)+
          scale_x_continuous(breaks = seq(1900, 2050, 2)) +
          theme_line+
          scale_color_manual(values= color.edr,
                             guide = guide_legend(ncol = 3)) +
          theme(legend.position = "bottom",
                text = element_text(size = 10))
          
girafe( ggobj = fe.pct.te.edr, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

<br>

## Peak farm earnings vs. peak total earnings {.tabset}

The following maps compare the years that total earnings peaked for each county as well as the years that farm earnings peaked.

For the most part, farm earnings peaked between 2010 - 2013 across the state with no county have their farm earnings peaking after 2015. On the other hand, total earnings tells a different story. A majority of counties in Minnesota have had their total earnings peak with the most recent data release year of 2018, meaning that the decrease in farm earnings did not entirely disrupt the overall growth in earnings. However, there were 33 counties, all of which are located on the wester and southern side of the state, that had their total earnings peak between 2012 and 2014. This tells us that those counties are more reliant on farm earnings than other counties.

<br>

### County map - peak year of total earnings<br/>vs. farm earnings

The following map provides a comparison of trends in farm earnings and total earnings to get a better handle on the influence of farm earnings in a county's total earnings. What we expect is that total earnings will have peaked within the last few years since a counties economy should grow every year. However, since farm earnings peaked between 2010 and 2013, it's important to see which of Minnesota's counties had their total earnings peak during those years.

The map on the right makes it pretty obvious that farm earnings peaked between 2012 and 2013. What's interesting is to see that many of the counties on the western border had their total earnings peak during this time while the other counties had their total earnings continue to grow despite lower farm earnings.

```{r prep county map peak year of total and farm earnings, include  = FALSE, cache=TRUE}
total.earnings.peak.year.county <- farm.earnings.county %>%
  group_by(GeoName, countyfp) %>%
  top_n(wt = total.earnings, n = 1) %>%
  ungroup() %>%
  mutate(year.bins = cut(year,
                         breaks = c(2001,2009, 2011, 2013, 2015, 2017, 2018),
                         labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  rename(te.peak.year = 4) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

farm.earnings.peak.year.county <- farm.earnings.county %>%
  group_by(GeoName, countyfp) %>%
  top_n(wt = farm.earnings, n = 1) %>%
  ungroup() %>%
  distinct(countyfp, .keep_all = TRUE) %>%
  mutate(year.bins = cut(year,
                         breaks = c(2001,2009, 2011, 2013, 2015, 2017, 2018),
                         labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  rename(fe.peak.year = 4) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))
```

```{r county map peak year of total and farm earnings, fig.width=9}
te.peak.year.map <- ggplot(filter(total.earnings.peak.year.county, GeoName != "Minnesota")) +
  geom_sf_interactive(aes(fill = year.bins, tooltip = paste(GeoName, "\nPeak year: ", te.peak.year, "\nFarm earnings as a percent of total earnings: ", percent(pct.farm.earnings), sep = ""), data_id = GeoName, geometry = geometry)) +
  scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black"))+
  theme_sf+
  labs(title="Total earnings peak year") +
  theme(text = element_text(size = 12))

te.peak.year.map.legend <- get_legend(te.peak.year.map)

fe.peak.year.map <- ggplot(filter(farm.earnings.peak.year.county, GeoName != "Minnesota")) +
  geom_sf_interactive(aes(fill = year.bins, tooltip = paste(GeoName, "\nPeak year: ", fe.peak.year, "\nFarm earnings as a percent of total earnings: ", percent(pct.farm.earnings), sep = ""), data_id = GeoName, geometry = geometry)) +
  scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black", "orange"))+
  theme_sf+
  labs(title="Farm earnings peak year") +
  theme(text = element_text(size = 12))

girafe(ggobj = plot_grid(te.peak.year.map + theme(legend.position = "none"), te.peak.year.map.legend, fe.peak.year.map + theme(legend.position = "none"), ncol = 3, rel_widths = c(3,1,3), rel_heights = c(3,3,3)), width_svg = 8) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                  opts_sizing(rescale = FALSE))

```

### County maps - change in earnings<br/>from peak farm years

What we're looking for here is the extent of change in total earnings since the year in which a county's farm earnings peaked. This will help us identify which counties have been most impacted. 

Not suprisingly, some of the largest decreases in total earnings has occured in counties in the southwestern and western parts of the state. Lac qui Parle county has experienced the larged decrease in total earnings since the peak farm year of 2013 with a drop of 40%.

<br>

```{r prep pct change in total earnings since peak farm, include = FALSE, cache=TRUE}
te.2018.county <- farm.earnings.county %>%
  filter(year == 2018) %>%
  select(3,6) %>%
  rename(total.earnings.2018 = 2)

te.change.since.farm.peak <- farm.earnings.peak.year.county %>%
  left_join(te.2018.county, by = "countyfp") %>%
  select(2,3,4,5,6,11,15,14) %>%
  mutate(te.pct.change = (total.earnings.2018 - total.earnings) / total.earnings,
         te.pct.change.bins = cut(te.pct.change,
                                  breaks = c(-1, -.25, -.1, 0, .1, .25, 1),
                                  labels = c("Greater than -25%", "-25% to -10%", "-10% to 0%", "0% to 10%", "10% to 25%", "Greater than 25%")))
names(te.change.since.farm.peak)
```

```{r maps of pct change in total earnings since peak farm}
te.pct.change.county <- ggplot(filter(te.change.since.farm.peak, GeoName != "Minnesota")) +
    geom_sf_interactive(aes(fill = te.pct.change.bins, tooltip = paste(GeoName, "\nYear of peak farm earnings: ", fe.peak.year, "\nTotal earnings that year: ", dollar(total.earnings), "\nTotal earnings in 2018: ", dollar(total.earnings.2018), "\nPercent change in total earnings: ", percent(te.pct.change), sep = ""), data_id = GeoName, geometry = geometry)) +
    scale_fill_manual(values = c("#f03b20", "#feb24c", "#ffeda0", "#C7EF99", "#6AC400", "#076324"))+
    theme_sf+
    labs(title="Percent change of total earnings\nsince year of peak farm earnings") +
  theme()
  
girafe( ggobj = te.pct.change.county, width_svg = 6) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties most disrupted by farm earnings

Below is a table list the change in farm earnings and total earnings for the 33 counties who had a lower total earnings in 2018 than in the year of their peak farm earnings. It's sorted by the percent change in total earnings since the peak farm year, with the highest percentage provided at the top (Lac qui Parle). 

The counties that we should be most worried about are near the top of the table, where the 

<br>

```{r table of counties with decreasing total earnings}
fe.2018 <- farm.earnings.county %>%
  filter(year == 2018) %>%
  select(3,5) %>%
  rename(farm.earnings.2018 = 2)

te.decrease.county <- te.change.since.farm.peak %>%
  left_join(fe.2018, by = "countyfp") %>%
  filter(te.pct.change < 0) %>%
  arrange(te.pct.change) %>%
  select(1,3,4,5,11,7,9,10) %>%
  mutate(`Change in total earnings` = total.earnings.2018 - total.earnings,
         `Change in farm earnings` = farm.earnings.2018 - farm.earnings,
         `Percent change in farm earnings` = (farm.earnings.2018 - farm.earnings) / farm.earnings,
         GeoName = str_replace(GeoName, ", MN", ""),
         fe.pct.te.peak = farm.earnings / total.earnings,
         fe.pct.te.2018 = farm.earnings.2018 / total.earnings.2018) %>%
  select(1,2,3,5,10,11,4,6,9,7,12,13) %>%
  rename(County = 1,
         "Peak year of farm earnings" = 2,
         "Farm earnings in peak year" = 3,
         "Farm earnings in 2018" = 4,
         "Change in farm earnings" = 5,
         "% change in farm earnings" = 6,
         "Total earnings from peak year" = 7,
         "Total earnings in 2018" = 8,
         "Change in total earnings" = 9,
         "% change in total earnings" = 10,
         "Farm earnings as % of total earnings in peak year" = 11,
         "Farm earnings as % of total earnings in 2018" = 12) %>%
  mutate("Change in farm earnings as % of total earnings (pct points)" = (`Farm earnings as % of total earnings in 2018` - `Farm earnings as % of total earnings in peak year`) * 100)
```


```{r table of decreasing counties}
datatable(te.decrease.county, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 10)) %>%
  formatStyle(columns = c(1:10), fontSize = "90%") %>%
  formatCurrency(3:5, "$") %>%
  formatCurrency(7:9, "$") %>%
  formatPercentage(6) %>%
  formatPercentage(10) %>%
  formatPercentage(11) %>%
  formatPercentage(12) %>% 
  formatCurrency(13, "", interval = 3, ",'")
  

```