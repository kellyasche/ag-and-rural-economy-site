---
title: "Ag wages per employment"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         edr = str_replace(edr, "  ", " "))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))


color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

color.ag.ind <- c("Crop Production" = "#a6cee3", "Animal Production and Aquaculture" = "#1f78b4", "Support Activities for Crop Production" = "#b2df8a", "Support Activities for Animal Production" = "#33a02c", "Food Manufacturing" = "#fb9a99", "Agricultural Implement Manufacturing" = "#e31a1c", "Farm Product Raw Material Merchant Wholesalers" = "#fdbf6f", "Farm Supplies Merchant Wholesalers" = "#ff7f00", "Pesticide, Fertilizer, and Other Agricultural Chemical Manufacturing" = "#cab2d6", "Total, All Industries" = "black", "NA" = "white")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master wage file, include = FALSE, cache = TRUE}
ag.ind.wages.county <- read_csv("Data/Earnings/Master-ag-related-ind-wages-counties.csv")

ag.ind.wages.pr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""))

ag.ind.wages.edr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-edr.csv") %>%
  left_join(edr.pr, by = "edr") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

```{r prep master ag employment objects, include=FALSE, cache=TRUE}
master.ag.emp.county <- read_csv("Data/Employment/Master-agrelated-emp-county.csv")

master.ag.emp.comb.county <- master.ag.emp.county %>%
  group_by(periodyear, Name, countyfp, Dem_Desc, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.ruca <- read_csv("Data/Employment/Master-agrelated-emp-ruca.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

master.ag.emp.comb.ruca <- master.ag.emp.ruca %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.pr <- read_csv("Data/Employment/Master-agrelated-emp-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.ag.emp.comb.pr <- master.ag.emp.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()


master.ag.emp.edr <- read_csv("Data/Employment/Master-agrelated-emp-edr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.ag.emp.comb.edr <- master.ag.emp.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

```

```{r master combined wages and employment, include=FALSE, cache=TRUE}
ag.wages.emp.county <- ag.ind.wages.county %>%
  left_join(master.ag.emp.county[,c(1,2,5,6)], by = c("countyfp", "periodyear", "naicstitle")) %>%
  mutate(wages.emp = wages / emp)

ag.wages.emp.ruca <- ag.wages.emp.county %>%
  group_by(periodyear, Dem_Desc, naicstitle) %>%
  summarise(wages = sum(wages, na.rm = TRUE),
            emp = sum(emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(wages.emp = wages / emp,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

ag.wages.emp.pr <- ag.ind.wages.pr %>%
  left_join(master.ag.emp.pr[,c(1,2,3,5)], by = c("planning.region", "periodyear", "naicstitle")) %>%
  mutate(wages.emp = wages / emp,
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

ag.wages.emp.edr <- ag.ind.wages.edr %>%
  left_join(master.ag.emp.edr[,c(1,2,3,5)], by = c("edr", "periodyear", "naicstitle")) %>%
  mutate(wages.emp = wages / emp,
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```


<br>

# Summary

Overall, the highest wages per employment values are located in our most metropolitan areas where they are 32% to 45% higher than other types of areas. When breaking it down by region, the highest wages per employment are by far found in the seven county metro. By 2018, the wage per employment in ag-related industries was $71,678 compared to $47,067 to $51,697 in the other regions of the state. Outside of the metro, the higest wage are, not supringsly, found in Southwest Minnesota.

When breaking it down by ag-related industry, the highest wages per employment values are found, by far, in the farm product raw material merchant wholesaler ($100,492) and farm supplies merchant wholesaler ($84,826). However, these only make up 

<br>

# Definitions

**Definition of ag-related industries**: This analysis cobbles together various NAICS codes that are directly related to "ag-related employment". This includes the following industries;

```{r ag-related industry list}
agrelated.ind.list <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  distinct(naicstitle) %>%
  rename(`Ag-related NAICS categories` = 1)

kable(agrelated.ind.list, format = "html", align = "c") %>%
    kable_styling(bootstrap_options = "striped") %>%
    column_spec(1, width = "10em")

```

<br>

# Analysis

* Wages per employment of all ag-related industries
  + RUCA
  + PR
  + EDR
  + 2018 County
  
* Wages per employment by each ag-related industry
  + RUCA
  + PR
  + EDR
  + 2018 County
  
* Where are the highest paying industries most concentrated?

<br>

## Wages per employment of ag-related industries combined {.tabset}

It's clear that the highest wages per employment are located in our most metropolitan counties in the state. In fact, the highest wages per employment are located in Hennepin and Ramsey Counties. Wages per employment in these counties and other entirely urban counties across the state are between 30% and 50% higher than the rest of the state.

In Southwest Minnesota, the highest wages are clustered in and around Blue Earth County and Lyons County. In the Northwest, the wages are typically a bit higher than Southwest. Perhaps this is due to the different crops being marketed and sold?

<br>

```{r prep ag wages per emp combined, include=FALSE, cache=TRUE}

ag.wages.emp.comb.ruca <- ag.wages.emp.ruca %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"]),
            total.wages = sum(wages[naicstitle == "Total, All Industries"]),
            ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup() %>%
  mutate(ag.wages.per.emp = ag.wages / ag.emp,
         total.wages.per.emp = total.wages / total.emp)

ag.wages.emp.comb.pr <- ag.wages.emp.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"]),
            total.wages = sum(wages[naicstitle == "Total, All Industries"]),
            ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup() %>%
  mutate(ag.wages.per.emp = ag.wages / ag.emp,
         total.wages.per.emp = total.wages / total.emp)

ag.wages.emp.comb.edr <- ag.wages.emp.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"]),
            total.wages = sum(wages[naicstitle == "Total, All Industries"]),
            ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup() %>%
  mutate(ag.wages.per.emp = ag.wages / ag.emp,
         total.wages.per.emp = total.wages / total.emp)

ag.wages.emp.comb.county <- ag.wages.emp.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"]),
            total.wages = sum(wages[naicstitle == "Total, All Industries"]),
            ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup() %>%
  mutate(ag.wages.per.emp = ag.wages / ag.emp,
         total.wages.per.emp = total.wages / total.emp,
         ag.wages.per.emp = ifelse(areaname == "Mahnomen", NA, ag.wages.per.emp)) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```


### RUCA

It's pretty clear to see that the highest paying jobs in ag-related industries are located in our entirely urban counties. By 2018, wages in ag-related industries were $66,862 per employment. This was 32% to 45% more than the other county groups.

<br>

```{r chart ag wages per employment combined ruca}

ag.wages.emp.comb.ruca.plot <- ggplot(ag.wages.emp.comb.ruca, aes(periodyear, ag.wages.per.emp, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.per.emp, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nTotal wages in ag-related industries: ", dollar(ag.wages), "\nTotal employment in ag-related industries: ", comma(ag.emp), "\nAg wages per employment: ", dollar(ag.wages.per.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag wages per employment")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = ag.wages.emp.comb.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

When broken down by planning regions, the seven county metro has the highest paying jobs. The $71,868 earned there is about 38% to 79% higher. Interestingly, the Southwest region has the 2nd highest wages per employment even though it has a large number of entirely rural counties. What this indicates is that the more urban counties in the region are earning significantly more wages than the rural counties, which drives up the wages in that region. So the disparities are still between urban-ness and rural-ness.

<br>

```{r chart ag wages per employment combined pr}

ag.wages.emp.comb.pr.plot <- ggplot(ag.wages.emp.comb.pr, aes(periodyear, ag.wages.per.emp, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.per.emp, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nTotal wages in ag-related industries: ", dollar(ag.wages), "\nTotal employment in ag-related industries: ", comma(ag.emp), "\nAg wages per employment: ", dollar(ag.wages.per.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag wages per employment")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = ag.wages.emp.comb.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```


### EDR

The breakdown by EDR shows that EDRs in Southwest typically have higher wages per employment when there are larger metros within the edr. For example, EDR 9 - South Central has Blue Earth County, which is an entirely urban county. This EDR also has the highest wages per employment in that region.

A similar situation is in the Central region where EDR 6E and 7W have the highest wages. These contain counties such as Stearns and Kandiyohi which are considered more urban than other counties in the planning region.

The Northwest is a bit different due to the varying ecosystem in that planning region. There, we would expect EDR 2 - Headwaters to be lower since that region doesn't typically have agriculture as a primary activity nearby.

<br>

```{r chart ag wages per employment combined edr, fig.height=9}

ag.wages.emp.comb.edr.plot <- ggplot(ag.wages.emp.comb.edr, aes(periodyear, ag.wages.per.emp, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.per.emp, tooltip = paste(edr, "\nYear: ", periodyear, "\nTotal wages in ag-related industries: ", dollar(ag.wages), "\nTotal employment in ag-related industries: ", comma(ag.emp), "\nAg wages per employment: ", dollar(ag.wages.per.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag wages per employment")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

girafe(ggobj = ag.wages.emp.comb.edr.plot, height_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### 2018 county map

This map highlights the concentration of the highest paying jobs are located in the seven-county metro, Blue Earth County and Martin County. 

In the Southwest region, the highest wages per employment are clustered in and around Lyons County, including Yellow Medicine, Redwood Falls, and Lac qui Parle counties.
 
Up in the Northwest region, the highest wages per employment are more spread out. It goes from Stevens and Grant Counties and then directly along the western border, skipping over Norman, and seeing high wages North of there.

<br>

```{r map 2018 ag wages per employment}
ag.wages.emp.comb.county.plot <- ggplot(filter(ag.wages.emp.comb.county, periodyear == 2018)) +
  geom_sf_interactive(aes(fill = ag.wages.per.emp, tooltip = paste(areaname, "\nYear: ", periodyear, "\nTotal wages in ag-related industries: ", dollar(ag.wages), "\nTotal employment in ag-related industries: ", comma(ag.emp), "\nWages per employment: ", dollar(ag.wages.per.emp), sep = ""), data_id = areaname, geometry = geometry)) +
  scale_fill_gradient(low = "white",
                      high = "#076324")+
  theme_sf+
  labs(title="2018 ag wages per employment") +
  theme(text = element_text(size = 10))

girafe(ggobj = ag.wages.emp.comb.county.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))


```

<br>

## Ag-related industry with highest wage per employment and number of employed

The two merchant wholesaler industries have the highest wages per employment by far compared to the other industries while also employing a modest number. Food manufacturing is by the highest number of employed, but is also one of the lowest paying per employment.

One important aspect to keep in mind that some of these industries likely employ only part-time of the year. For example, support activities for crop production likely only employ during planting and harvesting times of the year. Thus, their wages earned are going to be significantly lower.

<br>

```{r prep each industry wage per employment statewide, include=FALSE, cache=TRUE}

ag.wages.per.emp.ind.mn <- read_csv("Data/Employment/qcew-ag-related-industries-mn.csv") %>%
  select(1,2,5,28,30) %>%
  rename(emp = empYear,
         wages = totwageYear) %>%
  group_by(periodyear, naicstitle) %>%
  summarise(wages = sum(wages, na.rm = TRUE),
            emp = sum(emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(wages.per.emp = wages / emp)
```

```{r chart each industry wages per employment statewide}

ag.wages.per.emp.ind.mn.plot <- ggplot(filter(ag.wages.per.emp.ind.mn, periodyear == 2018), aes(emp, wages.per.emp, color = naicstitle)) +
  geom_label_repel(size = 2, aes(x = emp, y = wages.per.emp, label = naicstitle), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.per.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nWages per employed: ", dollar(wages.per.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::comma) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom")

girafe(ggobj = ag.wages.per.emp.ind.mn.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))


```

<br>

## Concentration of ag-related industries {.tabset}

Summary here

<br>

```{r prep concentration of ag-related industries, include=FALSE, cache=TRUE}

ag.ind.conc.ruca <- ag.wages.emp.ruca %>%
  group_by(periodyear, naicstitle) %>%
  mutate(pct.ind.emp = emp / sum(emp)) %>%
  ungroup()

ag.ind.conc.pr <- ag.wages.emp.pr %>%
  group_by(periodyear, naicstitle) %>%
  mutate(pct.ind.emp = emp / sum(emp)) %>%
  ungroup()

ag.ind.conc.edr <- ag.wages.emp.edr %>%
  group_by(periodyear, naicstitle) %>%
  mutate(pct.ind.emp = emp / sum(emp)) %>%
  ungroup()

```

### RUCA

Analysis here

<br>

```{r chart ag ind concentration, fig.height=8}
ag.ind.conc.ruca.plot <- ggplot(filter(ag.ind.conc.ruca, periodyear == 2018), aes(pct.ind.emp, wages.emp, color = Dem_Desc)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = pct.ind.emp, tooltip = paste(Dem_Desc, "\nNAICS: ", naicstitle, "\nEmployment in industry: ", comma(emp), "\nTotal wages earned in industry: ", dollar(wages), "\nWages per employment: ", dollar(wages.emp), "\nPercent of industry employment located in this region: ", percent(pct.ind.emp), sep = "")), show.legend = FALSE) +
  geom_label_repel(size = 3, aes(label = Dem_Desc), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent of industry employment located in each region by wage per employment earned")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 12))

girafe(ggobj = ag.ind.conc.ruca.plot, height_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Analysis here

<br>

### EDR

Analysis here

<br>



## Location of highest paying ag-related industries {.tabset}

Not surprisingly, the two merchant wholesaler industries provide the highest wages per employment within each of the regions. The highest is of course in the seven county metro. The location where this industry makes up a larger percentage compared to other ag-related industries is also the seven county metro, as well as entirely rural counties, EDR 6W - Upper Minnesota Valley, and EDR 1 - Northwest. 

Food manufacturing makes up, by far, the highest percentage of ag-related employment in each region. Nearly all other ag-related industries make up less than 10% of ag-related employment except for support services for crop production in Southwest Minnesota, where it's one of the higher employment industries out of all ag-related industries.

<br>

```{r prep ag wages and employment by industry, include=FALSE, cache=TRUE}

ag.wages.emp.pct.ruca <- ag.wages.emp.ruca %>%
  group_by(periodyear, Dem_Desc) %>%
  mutate(pct.emp = emp / sum(emp[naicstitle != "Total, All Industries"])) %>%
  ungroup()

ag.wages.emp.pct.pr <- ag.wages.emp.pr %>%
  group_by(periodyear, planning.region) %>%
  mutate(pct.emp = emp / sum(emp[naicstitle != "Total, All Industries"])) %>%
  ungroup()

ag.wages.emp.pct.edr <- ag.wages.emp.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  mutate(pct.emp = emp / sum(emp[naicstitle != "Total, All Industries"])) %>%
  ungroup()

ag.wages.emp.pct.county <- ag.wages.emp.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  mutate(pct.emp = emp / sum(emp[naicstitle != "Total, All Industries"])) %>%
  ungroup() %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))


```

### RUCA

When comparing the wages per employment and the percentage of employment each industry comprises of ag-related industries a couple of trends become clear.

The highest paying jobs tend to be in the two merchant wholesalers. Interestingly, the wages per employment in that industry are significantly higher in the entirely urban counties than everywhere else. These industries have the highest percentage of ag-related industry employment in our entirely urban and entirely rural counties (15% - 20%). 

Interestingly, food manufacturing makes up the highest percentage of ag-related employment in all county groups except for our entirely rural group where it doesn't even count towards a half of a percent to employment. In the other county groups its around 60% of ag-related employment.

Where entirely rural counties tend to have larger percentages is in crop production, animal production, and merchant wholesalers.

<br>

```{r charts ag wages and emp ruca, fig.height=8}

ag.wages.emp.pct.ruca.plot <- ggplot(filter(ag.wages.emp.pct.ruca, periodyear == 2018, naicstitle != "Total, All Industries"), aes(pct.emp, wages.emp, color = Dem_Desc)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 3, aes(x = pct.emp, y = wages.emp, label = Dem_Desc), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

girafe(ggobj = ag.wages.emp.pct.ruca.plot, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Interestingly, regions outside of the seven county metro have very similar percentages and wages per employment within each industry. This makes sense since these regions have a fairly decent distribution of entirely rural and entirely urban counties in them, thus any patterns that emerge within those categorizations even out across the region. 

The only place where this is not the case is the two merchant wholesalers industries. These have significantly higher wages per employment and percentage of ag-related employment in the seven county metro compared to the other regions.

<br>

```{r charts ag wages and emp pr, fig.height=8}

ag.wages.emp.pct.pr.plot <- ggplot(filter(ag.wages.emp.pct.pr, periodyear == 2018, naicstitle != "Total, All Industries"), aes(pct.emp, wages.emp, color = planning.region)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 3, aes(x = pct.emp, y = wages.emp, label = planning.region), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

girafe(ggobj = ag.wages.emp.pct.pr.plot, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR {.tabset}

The same story in the EDRs as in the planning regions. The two merchant wholesalers industries continues to have the highest wages per employment within each region. Unfortunately, those industries don't make up a high percentage of ag-related employment except for the twin cities metro, EDR 6W - Upper Minnesota Valley, and EDR 1 - Northwest. In the EDRs outside of the seven county metro, the wage per employment is significantly lower when compared to the metro.

<br>

#### Northwest

```{r charts ag wages and emp nw edr, fig.height=10}

ag.wages.emp.pct.nwedr.plot <- ggplot(filter(ag.wages.emp.pct.edr, periodyear == 2018, naicstitle != "Total, All Industries", planning.region == "Northwest"), aes(pct.emp, wages.emp, color = edr)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 2, aes(x = pct.emp, y = wages.emp, label = edr), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

  girafe(ggobj = ag.wages.emp.pct.nwedr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```

#### Central

```{r charts ag wages and emp central edr, fig.height=10}

ag.wages.emp.pct.cedr.plot <- ggplot(filter(ag.wages.emp.pct.edr, periodyear == 2018, naicstitle != "Total, All Industries", planning.region == "Central"), aes(pct.emp, wages.emp, color = edr)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 2, aes(x = pct.emp, y = wages.emp, label = edr), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

  girafe(ggobj = ag.wages.emp.pct.cedr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```

#### Southwest

```{r charts ag wages and emp sw edr, fig.height=10}

ag.wages.emp.pct.swedr.plot <- ggplot(filter(ag.wages.emp.pct.edr, periodyear == 2018, naicstitle != "Total, All Industries", planning.region == "Southwest"), aes(pct.emp, wages.emp, color = edr)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 2, aes(x = pct.emp, y = wages.emp, label = edr), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

  girafe(ggobj = ag.wages.emp.pct.swedr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```

#### Southeast

```{r charts ag wages and emp se edr, fig.height=10}

ag.wages.emp.pct.seedr.plot <- ggplot(filter(ag.wages.emp.pct.edr, periodyear == 2018, naicstitle != "Total, All Industries", planning.region == "Southeast"), aes(pct.emp, wages.emp, color = edr)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 2, aes(x = pct.emp, y = wages.emp, label = edr), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

  girafe(ggobj = ag.wages.emp.pct.seedr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```

#### Seven County Mpls-St Paul

```{r charts ag wages and emp tc edr, fig.height=10}

ag.wages.emp.pct.tcedr.plot <- ggplot(filter(ag.wages.emp.pct.edr, periodyear == 2018, naicstitle != "Total, All Industries", planning.region == "Seven County Mpls-St Paul"), aes(pct.emp, wages.emp, color = edr)) +
  facet_wrap(~naicstitle, ncol = 2) +
  geom_label_repel(size = 2, aes(x = pct.emp, y = wages.emp, label = edr), show.legend = FALSE) +
  geom_point_interactive(size = 2, aes(data_id = wages.emp, tooltip = paste("NAICS: ", naicstitle, "\nNumber employed: ", comma(emp), "\nPercent of total employment: ", percent(pct.emp), "\nWages per employed: ", dollar(wages.emp), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Wages per employment and number employed in ag-related industries")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(labels=scales::percent) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom",
        text = element_text(size = 8))

  girafe(ggobj = ag.wages.emp.pct.tcedr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE),
                 opts_zoom(max = 5))

```


<br>

## County map of most prominent ag-related industry - 2018

The maps below provide the highest and 2nd highest ag-related industry in each county.

Food production is obviously a major employment industry in agriculture. It's in the top 2 highest employment industry for a large majority of counties across the state and makes up 50% or more of ag-related employment across nearly all of these counties.

The two merchant wholesaler industries pop up in Hennepin and Ramsey County as well as in a large contingent of counties in Southwest Minnesota. It's also prominent in a few counties in NW Minnesota. 

<br>

```{r prep industry employment rank, include=FALSE, cache=TRUE}

ag.ind.rank.county <- ag.wages.emp.pct.county %>%
  filter(periodyear == 2018) %>%
  group_by(areaname, countyfp) %>%
  arrange(desc(pct.emp)) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  select(2,3,6,5,11,12,13,15) %>%
  complete(rank, countyfp) %>%
  group_by(countyfp) %>%
  fill(areaname) %>%
  ungroup() %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(naicstitle = as.factor(naicstitle),
         rank = rank - 1)

```

```{r maps industry employment rank, fig.height=7}

ag.ind.rank.county.1.plot <- ggplot(filter(ag.ind.rank.county, rank == 1)) +
  geom_sf_interactive(aes(fill = naicstitle, tooltip = paste(areaname, "\nNAICS: ", naicstitle, "\nRank: ", rank, "\nTotal wages earned: ", dollar(wages), "\nEmployment: ", comma(emp), "\nPercent of ag-related employment: ", percent(pct.emp), "\nWages per employment: ", dollar(wages.emp), sep = ""), data_id = areaname, geometry = geometry)) +
  scale_fill_manual(values = c("Crop Production" = "#a6cee3", "Animal Production and Aquaculture" = "#1f78b4", "Support Activities for Crop Production" = "#b2df8a", "Support Activities for Animal Production" = "#33a02c", "Food Manufacturing" = "#fb9a99", "Agricultural Implement Manufacturing" = "#e31a1c", "Farm Product Raw Material Merchant Wholesalers" = "#fdbf6f", "Farm Supplies Merchant Wholesalers" = "#ff7f00", "Pesticide, Fertilizer, and Other Agricultural Chemical Manufacturing" = "#cab2d6", "Total, All Industries" = "black", "NA" = "white"),
                    guide = guide_legend(ncol = 2),
                    drop = FALSE,
                    breaks = c("Crop Production", "Animal Production and Aquaculture", "Support Activities for Crop Production", "Support Activities for Animal Production", "Food Manufacturing", "Agricultural Implement Manufacturing", "Farm Product Raw Material Merchant Wholesalers", "Farm Supplies Merchant Wholesalers", "Pesticide, Fertilizer, and Other Agricultural Chemical Manufacturing"))+
  theme_sf+
  labs(title="Ag-industry with 2nd highest employment") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

ag.ind.rank.county.2.plot <- ggplot(filter(ag.ind.rank.county, rank == 2)) +
  geom_sf_interactive(aes(fill = naicstitle, tooltip = paste(areaname, "\nNAICS: ", naicstitle, "\nRank: ", rank, "\nTotal wages earned: ", dollar(wages), "\nEmployment: ", comma(emp), "\nPercent of ag-related employment: ", percent(pct.emp), "\nWages per employment: ", dollar(wages.emp), sep = ""), data_id = areaname, geometry = geometry)) +
  scale_fill_manual(values = color.ag.ind,
                    guide = guide_legend(ncol = 2))+
  theme_sf+
  labs(title="Ag-industry with highest employment") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

ag.ind.rank.county.1.plot.legend <- get_legend(ag.ind.rank.county.1.plot + theme(legend.box.margin = margin(0,0,0,0)))

ag.ind.rank.county.1.plot.legend.bottom <- plot_grid(NULL, ag.ind.rank.county.1.plot.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))


girafe(ggobj = plot_grid(ag.ind.rank.county.1.plot + theme(legend.position = "none"), ag.ind.rank.county.2.plot + theme(legend.position = "none"), NULL, ag.ind.rank.county.1.plot.legend.bottom, ncol = 2, rel_heights = c(1,.4)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```


