---
title: "Ag wages"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

<link rel="stylesheet" href="styles.css" type="text/css">


```{r loading jon docs and shapefiles, cache = TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master wage file, include = FALSE, cache = TRUE}
ag.ind.wages.county <- read_csv("Data/Earnings/Master-ag-related-ind-wages-counties.csv")

ag.ind.wages.pr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""))

ag.ind.wages.edr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-edr.csv") %>%
  left_join(edr.pr, by = "edr") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

<br>

# Summary

The analysis below highlights two points;

1. the downturn in crop commodity prices does not seem to impact ag-related industry wages, and
2. wages earned from ag-related industries play a relatively minor role in most regions across the state. 

A large majority of counties experiencing a decline in ag-related wages did not translate into lower total wages earned. For these counties, it potentially means a couple of things;

* ag-related wages didn't contribute a significant amount to the total wages earned in the county; or,
* declines in ag-related wages were made up by increases in wages in other industries.

However, there were three EDRs where wages from ag-related industry contributed 10% or more to total wages in the region at some point between 2001 and 2018. Those EDRs were;

* EDR 6W - Upper MN Valley,
* EDR 8 - Southwest, and 
* EDR 9 - South Central. 

When we filter down even further we find that within those EDRs there are 14 counties where 10% of their total wages originated from ag-related industries at some point since 2003. Those 14 counties are;

**6W - Upper MN Valley**

* Swift
* Lac qui Parle

**8 - Southwest**

* Cottonwood
* Lyon
* Murray
* Pipestone
* Redwood
* Rock

**9 - South Central**

* Brown
* Faribault
* Le Sueur
* Martin
* Sibley
* Watonwan

When examining those 14 counties in more detail, a large majority of the counties have not had their total wages impacted by ag-related industries. There is plenty of fluctuation in the trends of wages earned in ag-related industries, both up and down. However, these bumps and valleys rarely show up in the total wages earned charts.

There are a few counties that definitely seem to be impacted positively from ag-related industries. Both **Sibley** and **Watonwan** County have experienced significant growth in their wages from ag-related industries while also experiencing significant total wage growth. By 2018, wages from ag-related industries made up 38% of total wages in Sibley, 34% in Watowan.

On the flip side, there is one county that clearly seems to be impacted negatively by downturns in the ag-related industries. **Lac qui Parle** seems the most impacted in state. By 2018, wages earned in ag-related industries have dropped to 66% of what they were in 2003 and fell from making up 20% of the total wages in the region to 6%. In addition, their growth in total wages has stagnated since 2011.  

<br>

# Definitions

**Definition of ag-related industries**: This analysis cobbles together various NAICS codes  are directly related to "ag-related wages". This includes the following industries;

```{r ag-related industry list}
agrelated.ind.list <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  distinct(naicstitle) %>%
  rename(`Ag-related NAICS categories` = 1)

kable(agrelated.ind.list, format = "html", align = "c") %>%
    kable_styling(bootstrap_options = "striped") %>%
    column_spec(1, width = "10em")

```

<br>

# Analysis

This analysis examines the impact wages earned in ag-related industries impacts the total wages across Minnesota. We do this through the following sections;

**Change in ag-related wages vs. total wages**: We will examine the trends in ag-related wages and identify any regions whose total wages shows similar trends. This would mean that ag-related wages an out sized impact on the total wages for the region.

**Ag-related wages as a % of total wages**: It’s unknown whether ag-related wages as a percentage of total wages increased during the crop commodity boom and similarly decreased. We want to see if this actually occurred and, if so, which regions seem to have the most significant percentages.

**Peak ag wages vs. peak total wages**: If an increase in ag-related wages appears during the crop commodity boom and is followed by a decrease in the subsequent years, we will want to compare the peak year of these wages with the peak year of total wages. However, the economy has been growing across the state despite the Ag economy downturn. Regions that aren’t heavily reliant on Ag should see their total wages continue to grow, thus their peak year should be the most recent data year - 2018. In cases where ag-related wages play a larger role, we would expect to see their total wages peak between 2010 - 2013. We want to begin identifying those counties.

**Counties most disrupted by ag-related wages**: Through the above analysis, we should begin to get the main characteristics of a county where ag-related wages are having a larger impact on total wages - the most likely planning region and EDRs the counties are located in, as well as some measurements and thresholds of their ag-related and total wages This section will seek to identify those exact counties.

<br>

## Change in ag-related wages vs. total wages {.tabset}

The charts below provide the change in ag-related wages and total wages by indexing the values to their 2001 levels. The trend to look for is how the fluctuations in wages earned from ag-related industries “appear” in the total wages from all industries chart. If total wages show a similar trend to ag-related wages, it’s likely that ag-related wages has a significant influence in that region’s economy.

The overall trend is that the most consistent growth in wages occurred in town/rural mix, urban/town/rural mix, and entirely urban counties. Regionally, Northwest, Central and Southwest Minnesota experienced growth in ag-related industries that surpassed growth in total wages from all industries.

In particular, EDRs 7W - Central, 6E - Southwest Central, 4 - West Central, 5 - North Central, and 9 - South Central all experienced growth in ag-related wages higher than total growth of all wages in their regions.

Interestingly, EDR 8 - Southwest and EDR 6W - Upper MN Valley all experienced declines in their growth in ag-related wages.

I am uncertain as to what is going on in Northeast Minnesota since they have experienced an overall decline in wages earned in ag-related industries since 2001. My guess is that these wages are pretty small and so any type of plant or company closure can have a big impact on the numbers. We will find out more when we look at ag-related wages as a percentage of total earnings.

<br>

```{r prep ag  wages and total wages index, include = FALSE, cache=TRUE}
ag.total.wages.ruca <- ag.ind.wages.county %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

ag.total.wages.pr <- ag.ind.wages.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

ag.total.wages.edr <- ag.ind.wages.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

### RUCA

There are two distinct patterns here that are dependent on the type of RUCA group. The entirely rural group and, to lesser extent, the town/rural county group saw some rather big decreases in ag wages in the early 2000's, a recovery between 2006 and 2015 (during the crop commodity boom), and a subsequent downturn since then. The other county groups, entirely urban, urban/town/rural mix, and the town/rural mix have experienced significant growth in ag-related wages. In fact, total wages earned in ag-related industries has grown by nearly 200% while total wages has grown by about 175%. 

One other interesting element concerning the ag-related wages is that most of the growth occurred during the Great Recession. 

One last interesting nuance is the slight downturn in ag-related wages earned over the last few years in the entirely urban county group.

There isn't a lot of evidence that ag-related wages has impacted total wages in any of the RUCA groups. As expected, total wages plateaued during the Great Recession and has experienced growth since 2012. The entirely rural RUCA group does seem to be lagging behind a bit in total wage growth compared to the other regions. 

<br>

```{r charts ag wages and total wages index ruca, fig.width=8}
ag.wages.index.ruca.plot <- ggplot(ag.total.wages.ruca, aes(periodyear, ag.wages.index, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.index, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nTotal ag-related wages: ", dollar(ag.wages), "\nAg wages as a % of 2001 levels: ", percent(ag.wages.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag-related wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 4)) +
  theme(text = element_text(size = 10),
        plot.margin = unit(c(0,0,0,0), "cm"))


total.wages.index.ruca.plot <- ggplot(ag.total.wages.ruca, aes(periodyear, total.wages.index, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = total.wages.index, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nTotal wages: ", dollar(total.wages), "\nTotal wages as a % of 2001 levels: ", percent(total.wages.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.5, 2, .5)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca) +
  theme(legend.position = "none",
        text = element_text(size = 10),
        plot.margin = unit(c(0,0,0,0), "cm"))

ag.wages.index.ruca.legend <- get_legend(ag.wages.index.ruca.plot + theme(legend.direction = "horizontal", legend.justification = "right", legend.box.just = "right"))

ag.wages.index.ruca.legend.bottom <- plot_grid(NULL, ag.wages.index.ruca.legend, NULL)


girafe( ggobj = plot_grid(ag.wages.index.ruca.plot + theme(legend.position = "none"), total.wages.index.ruca.plot+theme(legend.position = "none"),  ag.wages.index.ruca.legend.bottom, nrow = 2, rel_heights = c(2,1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

There has been stead growth among all of the planning regions outside of the seven county metro. Northeast and Central Minnesota have all experienced over 200% wage growth in ag-related industries and were seemingly unfazed by the Great Recession. Growth in wages earned from ag-related industries surpassed overall growth in wages in Northwest, Southwest, and Central Minnesota. The growth in the seven-county metro has stagnated over the last 5 years or so and doesn't match the trend for *total* wages earned in all industries.

Interestingly, wages earned in ag-related industries in the Northeast region have declined since 2001. I'm not entirely certain why, but my suspicion is that Northeast doesn't have a huge percentage of their wages gathered from ag-related industries so one company closing can have a large impact on wages earned in that industry. 

Total wages, again, follow an expected trend of continued growth with a slight plateau between 2008 - 2012. 

<br>

```{r charts ag wages and total wages index pr, fig.width=8}
ag.wages.index.pr.plot <- ggplot(ag.total.wages.pr, aes(periodyear, ag.wages.index, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.index, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nTotal ag-related wages: ", dollar(ag.wages), "\nAg wages as a % of 2001 levels: ", percent(ag.wages.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag-related wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.5, 2.5, .5)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 4)) +
  theme(text = element_text(size = 10),
        plot.margin = unit(c(0,0,0,0), "cm"))


total.wages.index.pr.plot <- ggplot(ag.total.wages.pr, aes(periodyear, total.wages.index, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = total.wages.index, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nTotal wages: ", dollar(total.wages), "\nTotal wages as a % of 2001 levels: ", percent(total.wages.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.5, 2.5, .5)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr) +
  theme(legend.position = "none",
        text = element_text(size = 10),
        plot.margin = unit(c(0,0,0,0), "cm"))

ag.wages.index.pr.legend <- get_legend(ag.wages.index.pr.plot + theme(legend.direction = "horizontal", legend.justification = "right", legend.box.just = "right"))

ag.wages.index.pr.legend.bottom <- plot_grid(NULL, ag.wages.index.pr.legend, NULL)


girafe( ggobj = plot_grid(ag.wages.index.pr.plot + theme(legend.position = "none"), total.wages.index.pr.plot+theme(legend.position = "none"),  ag.wages.index.pr.legend.bottom, nrow = 2, rel_heights = c(2,1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDRs

Ag-related wages across EDRs highlights similar trends to the RUCA and Planning Region charts. For some EDRS in Central, Northwest, and Southwest Minnesota, growth in wages earned in ag-related industries has grown more than *total* growth across all industries. In particular, EDRs 7W - Central, 6E - Southwest Central, 4 - West Central, 5 - North Central, and 9 - South Central all experienced growth in ag-related wages higher than total growth of all wages in their regions. 

EDR 8 - Southwest and EDR 6W - Upper MN Valley all experienced declines in their growth in ag-related wages.

Total wages from all industries experienced the same trends as the other regional breakdowns - steady growth with a plateau during the Great Recession. The ag-related wages seem to have little impact on the trends of the total wages from all industries.

<br>

```{r charts ag wages and total wages index edr, fig.height=12}
ag.wages.index.edr.plot <- ggplot(ag.total.wages.edr, aes(periodyear, ag.wages.index, color = edr)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = ag.wages.index, tooltip = paste(edr, "\nYear: ", periodyear, "\nTotal ag-related wages: ", dollar(ag.wages), "\nAg wages as a % of 2001 levels: ", percent(ag.wages.index), sep = ""))) +
  facet_wrap(~planning.region, ncol = 1) +
  labs(x="", y = "", color="", title = "Ag-related wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.5, 2.5, .5)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(text = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        legend.text = element_text(size = 6),
        plot.margin = unit(c(0,0,0,0), "cm"),
        plot.title = element_text(size = 9))


total.wages.index.edr.plot <- ggplot(ag.total.wages.edr, aes(periodyear, total.wages.index, color = edr)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~planning.region, ncol = 1) +
  geom_point_interactive(size = 3, aes(data_id = total.wages.index, tooltip = paste(edr, "\nYear: ", periodyear, "\nTotal wages: ", dollar(total.wages), "\nTotal wages as a % of 2001 levels: ", percent(total.wages.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total wages indexed to 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.5, 2.5, .5)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr) +
  theme(legend.position = "none",
        text = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        plot.margin = unit(c(0,0,0,0), "cm"),
        plot.title = element_text(size = 10))

ag.wages.index.edr.legend <- get_legend(ag.wages.index.edr.plot + theme(legend.direction = "horizontal", legend.justification = "right", legend.box.just = "right"))

ag.wages.index.edr.legend.bottom <- plot_grid(NULL, ag.wages.index.edr.legend, NULL)


girafe( ggobj = plot_grid(ag.wages.index.edr.plot + theme(legend.position = "none"), total.wages.index.edr.plot+theme(legend.position = "none"),  ag.wages.index.edr.legend.bottom, nrow = 2, rel_heights = c(2,1)), height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

## Ag-related wages as a percent of total wages{.tabset}

Overall, ag-related wages don't make up a significant percentage of the total wages across regions. In fact, contributions from ag-related wages to the total wage in most regions is near 5%. However, that isn't the case when we drill down a little deeper. From here on forward, we can just ignore the Northeast and Seven County metro regions since ag-related wages make up 1% or less of the total wages earned in each region.

It's not surprising that the largest percentages are in our entirely rural and town/rural mix counties. The Southwest region has, by far, the largest percentage of wages earned in ag-related industries, nearing 15% over the last few years.

At the EDR level, EDR 6E in Central Minnesota, EDR 9 in Southwest Minnesota, and EDRs 1 and 4 in Northwest Minnesota all have ag-related industries contributing 10% or more to the total wages in their region with steady growth.

On the other hand, EDRs 6W and 8 have significant percentages but have been declining over the last few years. The counties in these EDRs are the likely culprits providing the downturn in the RUCA charts.

<br>

### RUCA

One of the more interesting elements here is that overall, Ag-related wages don't make up a significant portion of the total wages. In fact, it only breaches 8% once even for the entirely rural county group (2013).

Not surprisingly, Ag-related wages contribute to the total wages at a higher rate in more rural areas. Also, the fluctuation in the percentage within the entirely rural county group mimics the same pattern when the wages were indexed in the previous section of this page. For whatever reason Ag-related wages took a tip in the early 2000s, recovered during the peak of farm commodity prices, and is now taking another dip. 

The other county groups stay relatively consistent.

<br>

```{r chart ag wages pct total wages ruca}
aw.pct.tw.ruca.plot <- ggplot(ag.total.wages.ruca, aes(periodyear, aw.pct.tw, color = Dem_Desc)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = aw.pct.tw, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nAg-related wages: ", dollar(ag.wages), "\nTotal wages: ", dollar(total.wages), "\nAg wages as a percent of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "Ag-related wages earned as a % of total wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.ruca,
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom")
  
girafe( ggobj = aw.pct.tw.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Southwest Minnesota has the most significant portion of their total wages contributed by Ag-related industries. Over the last 5 years, wages earned from Ag-related industries has consistently contributed nearly 15% of the total wages in the region. 

Interestingly, none of the regions highlight any sort of dip in percentages over the last few years meaning that trend is definitely concentrated in our most rural counties. That trend is then diluted by some of the other more urban counties and doesn't show up in the planning regions. The EDRs might give us a bit more insight.

<br>

```{r chart ag wages pct total wages pr}
aw.pct.tw.pr.plot <- ggplot(ag.total.wages.pr, aes(periodyear, aw.pct.tw, color = planning.region)) +
    geom_smooth(se = FALSE, size = 2) +
    geom_point_interactive(size = 3, aes(data_id = aw.pct.tw, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nAg-related wages: ", dollar(ag.wages), "\nTotal wages: ", dollar(total.wages), "\nAg wages as a percent of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "Ag-related wages earned as a % of total wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.pr,
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom")
  
girafe( ggobj = aw.pct.tw.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```


### EDRs

A few things to note here. 

Ag-related wages earned in EDR 6E - Southwest Central significantly contributes to total wages. By 2018, wages from these industries contributed nearly 15% to the total wages in that region.

Ag-related wages in EDR 4 - West Central and EDR 1 - Northwest have similar contributions to total wages with percentages nearing 10%. In addition, for EDR 6E, EDR 4, and EDR 1, the percentage continues a slow but steady increase over the last 5 years.

Southwest Minnesota is a different story. EDR 8 - Southwest and EDR 6W - Upper MN Valley have experienced a sizable drop in contributions from Ag-related wages. Interestingly, EDR 9 in that region has seen consistent growth in contributions from Ag-related wages to the total wages.

<br>

```{r chart ag wages pct total wages edr, fig.height=8}
aw.pct.tw.edr.plot <- ggplot(ag.total.wages.edr, aes(periodyear, aw.pct.tw, color = edr)) +
    geom_smooth(se = FALSE, size = 2) +
  facet_wrap(~planning.region, ncol = 2) +
    geom_point_interactive(size = 3, aes(data_id = aw.pct.tw, tooltip = paste(edr, "\nYear: ", periodyear, "\nAg-related wages: ", dollar(ag.wages), "\nTotal wages: ", dollar(total.wages), "\nAg wages as a percent of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "Ag-related wages earned as a % of total wages")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_manual(values= color.edr,
                       guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 8),
          legend.text = element_text(size = 8))
  
girafe( ggobj = aw.pct.tw.edr.plot, height_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

## Peak ag-related wages vs. peak total wages{.tabset}

The following maps compare the years that total wages and ag wages peaked for each county as well as the change in wages earned that has occurred since the peak year.

The maps clearly indicate that there are counties in Southwest Minnesota that have experienced a decline in ag-related wages. A majority of counties in Southwest Minnesota have experienced a 10% or more drop in their wages earned in ag-related industries. 

However, the maps do not show strong evidence that declines in ag-related wages have impacted overall total wages in any of the counties. The counties that show, perhaps, the biggest influence from ag wages are Lac qui Parle, Faribault, and Waseca.


<br>

### Peak year of ag-related wages vs. total wages

The year that ag-related wages earned peaked varies considerably across Western Minnesota. One trend to note is that there is a lot more 2016-2018 peak years across Central and Northwest Minnesota compared to Southwest Minnesota. 

When comparing across the maps, it's not very evident that the declines occurring in ag-related wages has had any impact on total wages since nearly every county has had their total wages peak in 2017 or 2018. The counties that may have been impacted the most are Lac qui Parle, Faribault, and Waseca.

```{r prep peak year of ag and total wages, include=FALSE, cache=TRUE}
aw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = ag.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
  mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

tw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = total.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
    mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```

```{r map ag wages and total wages peak year, fig.width=8}
aw.peak.year.plot <- ggplot(aw.peak.year) +
    geom_sf_interactive(aes(fill = peak.year.bins, tooltip = paste(areaname, "\nYear of peak ag-related wages earned: ", periodyear), data_id = areaname, geometry = geometry)) +
    scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black"))+
    theme_sf+
    labs(title="Year of peak ag-related wages earned") +
  theme(text = element_text(size = 10))

tw.peak.year.plot <- ggplot(tw.peak.year) +
    geom_sf_interactive(aes(fill = peak.year.bins, tooltip = paste(areaname, "\nYear of peak total wages earned: ", periodyear), data_id = areaname, geometry = geometry)) +
    scale_fill_manual(breaks = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"),
                      values = c("Before 2010" = "white", "2010-2011" = "red", "2012-2013" = "red3", "2014-2015" = "red4", "2016-2017" = "grey", "2018" = "black"))+
    theme_sf+
    labs(title="Year of peak total wages earned") +
  theme(text = element_text(size = 10))

aw.peak.year.legend <- get_legend(aw.peak.year.plot)
  
girafe( ggobj = plot_grid(aw.peak.year.plot + theme(legend.position = "none"), aw.peak.year.legend, tw.peak.year.plot + theme(legend.position = "none"), rel_widths = c(1,.5,1), ncol = 3), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))


```

### Change in ag wages since peak year

The map below focuses on the counties within EDRs that were identified as having a sizable percentage of their total wages come from ag-related industries. The colors provide the percentage *point* change in ag wages as a percent of total wages from the year that ag wages peaked. 

What becomes quickly apparent is that counties in Southwest Minnesota have been impacted the most. A majority of counties have experienced a drop of 10% or more in wages earned in ag-related industries.

The counties that looked to have their total wages impacted the most by ag-related wages was Lac qui Parle, Faribault and Waseca. Sure enough, in this map those counties have experienced considerable decline in their ag wages. Lac qui Parle reported wages earned from ag industries 69% lower than in 2010, Waseca 73% lower than in 2013, and Waseca was 3% lower than in 2017. 

Since the year that ag-wages peaked varies considerably, it can be a bit challenging to discern how much of an impact this is having on the overall economy since impacts can depend on the quickness of change. For example, Lyon County experienced a 32% decrease in their wages since their peak year. However, their peak year was in 2002. Compare that to Lac qui Parle where they have experienced a 69% drop in wages earned from ag-related industries since their peak year, which was in 2010. That's a much more abrupt change.

<br>

```{r prep change in ag wages since peak year, include=FALSE, cache=TRUE}

aw.2018 <- ag.ind.wages.county %>%
  filter(periodyear == 2018) %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  rename(ag.wages.2018 = ag.wages,
         total.wages.2018 = total.wages)

aw.earned.peak <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(aw.peak.year[,c(1,3)], by = c("countyfp", "periodyear")) %>%
  left_join(aw.2018[,c(3,5,6)], by = "countyfp") %>%
  mutate(aw.pct.tw.peak = ag.wages / total.wages,
         aw.pct.tw.2018 = ag.wages.2018 / total.wages.2018,
         change.aw.pct.tw = 100* (aw.pct.tw.2018 - aw.pct.tw.peak),
         change.aw.peak.2018 = (ag.wages.2018 - ag.wages)/ag.wages)


aw.earned.peak.select.edrs <- aw.earned.peak %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(change.aw.peak.2018.bins = cut(change.aw.peak.2018,
                                     breaks = c(-1, -.5, -.3, -.1, -.01, 1),
                                     labels = c("-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))) %>%
  mutate(change.aw.peak.2018.bins = ifelse(edr %in% c("EDR  1 - Northwest", "EDR  4 - West Central", "EDR  6E- Southwest Central", "EDR  6W- Upper Minnesota Valley", "EDR  8 - Southwest", "EDR  9 - South Central"), as.character(change.aw.peak.2018.bins), NA),
         change.aw.peak.2018.bins = fct_relevel(change.aw.peak.2018.bins, "-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))

```

```{r map pct point change in ag wages since peak, fig.width=8}
aw.earned.peak.select.edrs.plot <- ggplot(aw.earned.peak.select.edrs) +
    geom_sf_interactive(aes(fill = change.aw.peak.2018.bins, tooltip = paste(areaname, "\nPeak year of ag wages earned: ", periodyear, "\nAg wages as % of total wages during peak year: ", percent(aw.pct.tw.peak), "\nAg wages as % of total wages in 2018: ", percent(aw.pct.tw.2018), "\nPercent change in ag wages since peak year: ", percent(change.aw.peak.2018), sep = ""), data_id = areaname, geometry = geometry)) +
    scale_fill_manual(values = c("#a50f15", "#de2d26", "#fb6a4a", "#fcae91", "grey"))+
    theme_sf+
    labs(title="Change in ag wages since the peak year in\nselect EDRs") +
  theme(text = element_text(size = 12))
  
girafe( ggobj = aw.earned.peak.select.edrs.plot, width_svg = 6) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties most disrupted by ag-related wages{.tabset}

The previous sections highlighted the fact that wages from ag-related industries play a relatively minor role in most regions across the state. Southwest Minnesota was the only planning region that consistently show up in previous charts showing a rather significant portion of their total wages originating from ag-related industries. Therefore, we are going to focus on counties in that region where total wages earned originating from ag-related industries were 10% or higher at some point between 2001 and 2018.

**6W - Upper MN Valley**

* Swift
* Lac qui Parle

**8 - Southwest**

* Cottonwood
* Lyon
* Murray
* Pipestone
* Redwood
* Rock

**9 - South Central**

* Brown
* Faribault
* Le Sueur
* Martin
* Sibley
* Watonwan

The charts below provide the ag-related wages and total wages indexed to 2003 levels to see if any of the trends match across the charts. This will help us identify which counties are most impacted by ag-related industries.

Overall, a large majority of the counties have not had their total wages impacted by ag-related industries. There is plenty of fluctuation in the trends of wages earned in ag-related industries, both up and down. However, these bumps and valleys rarely show up in the total wages earned charts.

There are a few counties that definitely seem to be impacted positively from ag-related industries. Both Sibley and Watonwan County have experienced significant growth in their wages from ag-related industries while also experiencing significant total wage growth. By 2018, wages from ag-related industries made up 38% of total wages in Sibley, 34% in Watowan.

On the flip side, there is one county that clearly seems to be impacted negatively by downturns in the ag-related industries. Lac qui Parle seems the most impacted in state. By 2018, wages earned in ag-related industries have dropped to 66% of what they were in 2003 and fell from making up 20% of the total wages in the region to 6%. In addition, their growth in total wages has stagnated since 2011.  




<br>

### EDR 6W - Upper MN Valley

The impact from the drop in ag-related wages earned in Lac qui Parle may have impacted the total wages as total wages in general have plateaued around the same time that wages in ag-related industries tanked. 

On the other hand, the drop in ag related wages in Swift County has not impacted the total wage growth at all since growth continued despite the drop in ag-related wages earned. 
 

<br>

```{r prep ag wage trends for counties with highest percentage, include=FALSE, cache=TRUE}
aw.sig.counties.match <- ag.ind.wages.county %>%
  filter(planning.region == "Southwest Minnesota") %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages) %>%
  filter(aw.pct.tw > .099999) %>%
  distinct(areaname, countyfp)

aw.tw.index <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(aw.sig.counties.match, by = c("countyfp", "areaname")) %>%
  filter(periodyear > 2002) %>%
  group_by(areaname, countyfp) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2003],
         total.wages.index = total.wages / total.wages[periodyear == 2003]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages) %>%
  gather(key = "wage.type", value = "index", 7:8) %>%
  mutate(wage.type = str_replace(wage.type, "ag.wages.index", "Ag wages index"),
         wage.type = str_replace(wage.type, "total.wages.index", "Total wages index")) %>%
  group_by(wage.type) %>%
  mutate(data_id = seq(periodyear))

```

```{r charts aw tw index of edr 6w, fig.width=8}
aw.tw.6w.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  6W- Upper Minnesota Valley"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 6W - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.6w.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDR  8 - Southwest

EDR 8 really highlights how little wages from ag-related industries impacts total wages. Rock County has seen it's wages earned from ag-related industries skyrocket over 500% by 2006, making up 12% of total wages in the county. Since then, it has fluctuated around that percentage all the way until 2018. By 2018, ag-related wages are 596% what they were in 2003, yet only make up 8% of the total wages in the county. 

Many of the counties follow this similar pattern. There are some small drops and big increases but nothing that really seems to appear in the trends of total wages.

<br>

```{r charts aw tw index of edr 6, fig.width=8}
aw.tw.8.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  8 - Southwest"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 8 - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.8.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDR  9 - South Central

There are a few counties here where wages earned from ag-related industries likely impacts the total wages of the county.

Sibley is very likely to have experienced it's total wage growth because of the growth in ag-related wages. By 2018, wages earned in ag-related industries grew by 510% since 2003 and made up 38% of the total wages in the county. Total wages for Sibley grew by 179%.

Another County similar to Sibley is Watonwan where they have experienced consistent growth in the wages earned from ag-related industries and their total wages have grown considerably as well. Currently, wages from ag-related industries comprises 34% of the total wages earned.

There is an outlier data point for Faribault that is throwing off the numbers there and not sure what they is due to. 

<br>

```{r charts aw tw index of edr 9, fig.width=8}
aw.tw.9.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  9 - South Central"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 9 - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.9.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```