---
title: "Farm employment"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         edr = str_replace(edr, "  ", " "),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master farm employment objects, include=FALSE, cache=TRUE}
master.farm.emp.county <- read_csv("Data/Employment/bea-farm-total-employment.csv") %>%
  drop_na(LineCode) %>%
  mutate(countyfp = str_sub(GeoFips, 3, 5)) %>%
  left_join(counties.regions, by = "countyfp") %>%
  select(23,24,3:22, 25:28) %>%
  gather(key = "year", value = "employment", 5:22) %>%
  select(-3) %>%
  spread(key = Description, value = employment) %>%
  rename(farm.emp = 8,
         total.emp = 9) %>%
  mutate(year = as.integer(year),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  filter(Name != "Minnesota")

master.farm.emp.ruca <- master.farm.emp.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

master.farm.emp.pr <- master.farm.emp.county %>%
  group_by(planning.region, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.farm.emp.edr <- master.farm.emp.county %>%
  group_by(edr,planning.region, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

<br>

# Summary of farm employment

**Definition of farm employment**: Farm employment is the number of workers engaged in the direct production of agricultural commodities, either livestock or crops; whether as a sole proprietor, partner, or hired laborer. 

<br>

# Analysis



<br>

## Change in farm employment vs. total employment {.tabset}

The charts below provide the change in farm employment and total employment by indexing the values to their 2001 levels. The trend to look for is how the fluctuations in farm employment “appear” in the total employment chart. If a regions employment is impacted by the farm economy, then we should see corresponding "bumps" or trends in the total employment charts that mimic the farm employment charts.

Overall, every region across Minnesota has experienced significant declines in farm employment. In addition, total employment decreases are occurring in our most rural areas of the state. However, it's a bit difficult to know if the decreases in farm and total employment are related since our most rural areas are also experiencing demographic and population shifts resulting in less people in the overall labor force.

The regions that may have areas most impacted by farm employment are located in the Northwest, Central, and Southwest regions of the state. Within those, the EDRs that should be looked at in more detail are;

* EDR 1 - Northwest
* EDR 7E - East Central
* EDR 6E - Southwest Central
* EDR 6W - Upper Minnesota Valley
* EDR 8 - Southwest

```{r prep farm and total emp index, include=FALSE, cache=TRUE}
farm.emp.index.ruca <- master.farm.emp.ruca %>%
  group_by(Dem_Desc) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

farm.emp.index.pr <- master.farm.emp.pr %>%
  group_by(planning.region) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

farm.emp.index.edr <- master.farm.emp.edr %>%
  group_by(edr, planning.region) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

```


<br>

### RUCA

Farm employment has been decreasing all across the state, and at similar rates. The crop commodity boom staved off the decreases, indicated by the plauteaus between 2008 and 2012, but has since decreased through 2018. In 2018 farm employment levels were between 70% and 76% of their 2001 levels.

The non-entirely rural county groups had the opposite pattern in their total employment numbers. Growth plateaued, or even decreased, during the Great Recession/crop commodity boom, and has since increased through 2018. A majority of the growth has occurred in entirely urban areas while lesser in more rural counties. 

On the other hand, the total employment in our entirely rural county group has been on a slow, steady decline. By 2018, the total employed was 95% of their 2001 levels. This is likely do to demographic shifts and less people in the workforce.

It might be challenging to tease out if any of these decreases occurred because of the decline in farm employment.

<br>

```{r charts farm and total emp index ruca, fig.width=8}
farm.emp.index.ruca.plot <- ggplot(farm.emp.index.ruca, aes(year, farm.emp.index, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = farm.emp.index, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.65, 1.3, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

total.emp.index.ruca.plot <- ggplot(farm.emp.index.ruca, aes(year, total.emp.index, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = total.emp.index, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  coord_cartesian(ylim = seq(.65, 1.3, .1)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

farm.emp.index.ruca.legend <- get_legend(farm.emp.index.ruca.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.ruca.legend.bottom <- plot_grid(NULL, farm.emp.index.ruca.legend, NULL, ncol = 3, rel_widths = c(0,1,2))

girafe( ggobj =  plot_grid(farm.emp.index.ruca.plot+theme(legend.position = "none"), total.emp.index.ruca.plot + theme(legend.position = "none"), NULL, farm.emp.index.ruca.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### Planning Region

Similar to the RUCA county groups, farm employment has been on a steady decline since plateauing during the Great Recession. Southwest, Southeast, Central and Northwest planning regions have all had very similar levels of decrease in farm employment.

Total employment in all regions has increase between 1% and 17% since 2001 across Minnesota. Southwest has experienced barely any increases at all since 2001.

<br>

```{r charts farm and total emp index pr, fig.width=8}
farm.emp.index.pr.plot <- ggplot(farm.emp.index.pr, aes(year, farm.emp.index, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = farm.emp.index, tooltip = paste(planning.region, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.3, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

total.emp.index.pr.plot <- ggplot(farm.emp.index.pr, aes(year, total.emp.index, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = total.emp.index, tooltip = paste(planning.region, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  coord_cartesian(ylim = seq(.6, 1.3, .1)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

farm.emp.index.pr.legend <- get_legend(farm.emp.index.pr.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.pr.legend.bottom <- plot_grid(NULL, farm.emp.index.pr.legend, NULL, ncol = 3, rel_widths = c(0,1,2))

girafe( ggobj =  plot_grid(farm.emp.index.pr.plot+theme(legend.position = "none"), total.emp.index.pr.plot + theme(legend.position = "none"), NULL, farm.emp.index.pr.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDR

In the charts below, we are looking for EDRs that have experienced significant declines in farm employment (which is basically all EDRs), and has experienced limited or no growth in their total employment. There are a few EDRs that are worth looking at in more detail as we move forward in this analysis.

In the Northwest region, EDR 1 - Northwest has 68% of 2001 farm employment levels by 2018. In addition, their overall total employment has not increased and are currently at 99% of their 2001 levels.

In the Central region, both EDR 7E - East Central and EDR 6E - Southwest Central, have experienced significant declines in farm employment as well as limited growth in total employment. In 2018, EDR 7E had 6% more employment compared to 2001 and EDR 6E had 4% more.

In the Southwest region, all the EDRs are worth taking a closer look at, but especially 6W - Upper Minnesota Valley and EDR 8 - Southwest where their total employment is 93% and 99% of their 2001 levels, respectively.

<br>

```{r charts farm and total emp index edr, fig.height=12}
farm.emp.index.edr.plot <- ggplot(farm.emp.index.edr, aes(year, farm.emp.index, color = edr)) +
  facet_wrap(~planning.region, ncol = 1) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = farm.emp.index, tooltip = paste(edr, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.3, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        plot.title = element_text(size = 10),
        legend.text = element_text(size = 6))

total.emp.index.edr.plot <- ggplot(farm.emp.index.edr, aes(year, total.emp.index, color = edr)) +
  facet_wrap(~planning.region, ncol = 1) +
  geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  geom_point_interactive(size = 3, aes(data_id = total.emp.index, tooltip = paste(edr, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment as % of 2001 levels: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment as a % of 2001 levels: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  coord_cartesian(ylim = seq(.6, 1.3, .1)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        plot.title = element_text(size = 10))

farm.emp.index.edr.legend <- get_legend(farm.emp.index.edr.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.edr.legend.bottom <- plot_grid(NULL, farm.emp.index.edr.legend, NULL, ncol = 3, rel_widths = c(0,1,2))

girafe( ggobj =  plot_grid(farm.emp.index.edr.plot+theme(legend.position = "none"), total.emp.index.edr.plot + theme(legend.position = "none"), NULL, farm.emp.index.edr.legend.bottom, ncol = 2, rel_heights = c(1,.1)), height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

<br>

## Farm employment as a % of total employment {.tabset}

The charts below provide farm employment as a percentage of total employment each year. The trend to see here is how much that percentage has changed over time.

The percentage of employment in farming has decreased across the state since 2001. The largest decreases have occurred in regions with the highest percentage of employment in farming. 

Not surprisingly, the most significant contributions of farm employment to total employment are found in the Northwest and Southwest regions of the state. In particular, EDR 1 - Northwest, EDR 6W - Upper Minnesota Valley, and EDR 8 - Southwest have 10% or more of their employment in farming. All of these EDRs have experienced drops in their employment from farming of 3 to 5 percentage points since 2001.

We will most likely be looking at counties in those three regions moving forward.

<br>

```{r prep farm emp as % of total emp, include=FALSE, cache=TRUE}
farm.pct.total.emp.ruca <- master.farm.emp.ruca  %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

farm.pct.total.emp.pr <- master.farm.emp.pr %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

farm.pct.total.emp.edr <- master.farm.emp.edr %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

```

### RUCA

Not surprisingly, our entirely rural counties have the highest percentage of total employment in farming. However, it's definitely been decreasing since 2001, especially after the farm commodity boom from 2008 - 2012. Since 2001, farm employment has dropped from 18% of total employment to 13.5%. 

All other county groups have 6% or less of their employment in farming as of 2018.

<br>

```{r charts farm pct total emp ruca}
farm.pct.total.emp.ruca.plot <- ggplot(farm.pct.total.emp.ruca, aes(year, farm.pct.total.emp, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = farm.pct.total.emp, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nTotal employment: ", comma(total.emp), "\nFarm employment as % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = farm.pct.total.emp.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

The Southwest and Northwest are the only regions where farm employment contributes any sort of significance to total employment. By 2018, both regions had about 7.5% of their employment in farming.

<br>

```{r charts farm pct total emp pr}
farm.pct.total.emp.pr.plot <- ggplot(farm.pct.total.emp.pr, aes(year, farm.pct.total.emp, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = farm.pct.total.emp, tooltip = paste(planning.region, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nTotal employment: ", comma(total.emp), "\nFarm employment as % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = farm.pct.total.emp.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR

The EDRs with the highest percentage of employment from farming are EDR 1 - Northwest, EDR 6w - Minnesota River Valley, and EDR 8 - southwest. All of these regions have 10% or more of their employment coming from farming.

<br>

```{r charts farm pct total emp edr, fig.height=8}
farm.pct.total.emp.edr.plot <- ggplot(farm.pct.total.emp.edr, aes(year, farm.pct.total.emp, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = farm.pct.total.emp, tooltip = paste(edr, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nTotal employment: ", comma(total.emp), "\nFarm employment as % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(size = 8),
        text = element_text(size = 12),
        legend.text = element_text(size = 8))

girafe(ggobj = farm.pct.total.emp.edr.plot, height_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties - peak year of total employment vs. percentage of employment in farming

The following maps provide the year in which total employment peaked and the percentage of employment that is in farming in 2018. Since we expect employment to increase every year, most counties should have 2018 as their peak year in employment. For those that don't, we want to see whether they also have a higher percentage of their employment in farming, particularly in the Northwest and Southwest regions of the state.

The maps highlight an overall trend that counties where employment has peaked in the last few years (black) typically do not have a high percentage of their employment in farming (lighter green). The seven county metro, across Central Minnesota along the I-94 corridor and a few areas where large metropolitan areas are present such as Rochester, Mankato, Duluth, and Bemidji all have had their highest employment numbers in the last few years.

On the other hand, some of the counties where employment peaked before 2015 are in counties with 10% or more of their total employment in farming. Counties such as Marshall, Norman, Traverse, and Lincoln all have 20% of more of their employment in farming and have had total employment peak before 2010.

<br>

```{r prep peak year of total employment and % of employment in farming in 2018, include=FALSE, cache=TRUE}

total.emp.peak.year.county <- master.farm.emp.county %>%
  group_by(countyfp, Name) %>%
  top_n(n = 1, wt = total.emp) %>%
  ungroup() %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(year.bins = cut(year,
                         breaks = c(2000, 2005, 2010, 2015, 2020),
                         labels = c("2000-2005", "2006-2010", "2011-2015", "2016-2018" )))

farm.pct.total.emp.2018.county <- master.farm.emp.county %>%
  filter(year == 2018) %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(farm.pct.total.emp.bins = cut(farm.pct.total.emp,
                                       breaks = c(0, .05, .10, .15, .2, .3),
                                       labels = c("Less than 5%", "5%-10%", "10%-15%", "15%-20%", "More than 20%")))

```

```{r charts peak year of total employment and % of employment in farming in 2018, fig.width=8}

total.emp.peak.year.county.plot <- ggplot(total.emp.peak.year.county) +
  geom_sf_interactive(aes(fill = year.bins, tooltip = paste(Name, "\nYear of peak total employment: ", year, "\nTotal employment: ", comma(total.emp), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(values = c("#cb181d", "#fb6a4a", "#fcae91", "black"),
                    guide = guide_legend(nrow = 2))+
  theme_sf+
  labs(title="Year that total employment peaked") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

farm.pct.total.emp.2018.county.plot <- ggplot(farm.pct.total.emp.2018.county) +
  geom_sf_interactive(aes(fill = farm.pct.total.emp.bins, tooltip = paste(Name, "\nFarm employment in 2018: ", comma(farm.emp), "\nTotal employment in 2018: ", comma(total.emp), "\nFarm employment as % of total employment: ", percent(farm.pct.total.emp), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(values = c("#E7F5D9", "#C7EF99", "#90E033", "#5CA81F", "#076324"))+
  theme_sf+
  labs(title="Farm employment as % of total employment in 2018") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

girafe(ggobj = plot_grid(total.emp.peak.year.county.plot, farm.pct.total.emp.2018.county.plot), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties most disrupted by declines in farm employment {.tabset}

The previous sections have provided the following guidance on identifying which counties have been possibly impacted by declines in farm employment;

* are located in the Northwest, Central, or Southwest planning regions;
* have 10% or more of their employment in farming; and
* have had their employment peak before 2016.

Those counties are;

<br>

```{r prep identify most disrupted counties, include=FALSE, cache=TRUE}

disrupted.counties <- master.farm.emp.county %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp) %>%
  left_join(total.emp.peak.year.county[,c(1,7)], by = "countyfp") %>%
  rename(total.emp.peak.year = 11) %>%
  filter(planning.region %in% c("Northwest", "Central", "Southwest"),
         total.emp.peak.year < 2016,
         farm.pct.total.emp > .1,
         year.x == 2018,
         farm.pct.total.emp > .1) %>%
  distinct(countyfp, .keep_all = TRUE) 


```

```{r table identify most disrupted counties}
disrupted.counties.table <- disrupted.counties %>%
  select(2,4,5,6) %>%
  arrange(planning.region, edr)

datatable(disrupted.counties.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE))
```

<br>

The charts below provide the index of farm and total employment of these individual counties to get a closer look any similarities between the two. What we are looking for are similarities in the trend lines. Do the decreases and plateaus in farm employment show up in the trend lines of total employment?

After reviewing, the following counties seem to have the most potential in being impacted by decreases in farm employment;

* Norman
* Marshall
* Mahnoman
* Wilkin
* Grant
* Renville
* Swift
* Yellow Medicine
* Big Stone
* Lac qui Parle
* Lincoln
* Cottonwood
* Redwood
* Faribault

```{r prep farm and total employment index for disrupted counties, include=FALSE, cache=TRUE}

farm.total.emp.index.dis.counties <- master.farm.emp.county %>%
  right_join(disrupted.counties[,c(1)], by = "countyfp") %>%
  group_by(countyfp, Name) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup() %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)
```

<br>

### Northwest

**EDR 1**: Both Norman and Marshall Counties have over 20% of their employment in farming and their trend lines for total employment share some similarities with the farm employment trend lines.

**EDR 2**: Mahnoman County has trend lines that are very similar to each other. However, the county's percentage of employment in farming has hovered between 10% and 13%, so not very significant.

**EDR 4**: Wilkin and Grant County have trend lines that are similar across farm and total employment along with having a high percentage (15% - 20%) in farming. Interestingly, Traverse County have trend lines that are inverse from each other. Increases in farm employment corresponded to decreases in total employment, and vice-versa. I have no explanation for that.

**EDR 5**: Not a whole lot happening here.



<br>

```{r chart farm and total emp index NW, fig.height=10}
farm.emp.index.dis.counties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Northwest"), aes(year, farm.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 6))

total.emp.index.dis.counties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Northwest"), aes(year, total.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        legend.text = element_text(size = 6))

farm.emp.index.dis.counties.legend <- get_legend(farm.emp.index.dis.counties.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.dis.counties.legend.bottom <- plot_grid(NULL, farm.emp.index.dis.counties.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(farm.emp.index.dis.counties.plot+theme(legend.position = "none"), total.emp.index.dis.counties.plot + theme(legend.position = "none"), NULL, farm.emp.index.dis.counties.legend.bottom, ncol = 2, rel_heights = c(1,.1)), height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))



```

### Central

Renville County has experienced a considerable decrease in farm employment and a similar decline in total employment. In addition, farm employment used to make up 17.6% of total employment in 2001 and now only makes up 13.7%.

<br>

```{r chart farm and total emp index C, fig.width=8}
farm.emp.index.dis.ccounties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Central"), aes(year, farm.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 8))

total.emp.index.dis.ccounties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Central"), aes(year, total.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        legend.text = element_text(size = 8))

farm.emp.index.dis.ccounties.legend <- get_legend(farm.emp.index.dis.ccounties.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.dis.ccounties.legend.bottom <- plot_grid(NULL, farm.emp.index.dis.ccounties.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(farm.emp.index.dis.ccounties.plot+theme(legend.position = "none"), total.emp.index.dis.ccounties.plot + theme(legend.position = "none"), NULL, farm.emp.index.dis.ccounties.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Southwest

**EDR 6W**: All of the counties provided in this region may be impacted by declines in farm employment. Some of the potentially hardest hit are Lac qui Parle and Swift.

**EDR 8**: Lincoln, Cottonwood, and Redwood counties all have farm and total employment trendlines that have similarities while also having a higher percentage of their employment from farming.

**EDR 9**: Faribault County has farm and total employment declines that are similar. However, farm employment only makes up around 10% to 12% of total employment so it's hard to say how much of an impact it is having.

<br>

```{r chart farm and total emp index SW, fig.height=10}
farm.emp.index.dis.swcounties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Southwest"), aes(year, farm.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Farm employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 6))

total.emp.index.dis.swcounties.plot <- ggplot(filter(farm.total.emp.index.dis.counties, planning.region == "Southwest"), aes(year, total.emp.index, color = Name)) +
  facet_wrap(~edr, ncol = 1) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = farm.emp.index, tooltip = paste(Name, "\nYear: ", year, "\nFarm employment: ", comma(farm.emp), "\nFarm employment index to 2001: ", percent(farm.emp.index), "\nTotal employment: ", comma(total.emp), "\nTotal employment index to 2001: ", percent(total.emp.index), "\nFarm employment as a % of total employment: ", percent(farm.pct.total.emp), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.6, 1.1, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_discrete(guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 6),
        legend.text = element_text(size = 6))

farm.emp.index.dis.swcounties.legend <- get_legend(farm.emp.index.dis.swcounties.plot + theme(legend.box.margin = margin(0,0,0,0)))

farm.emp.index.dis.swcounties.legend.bottom <- plot_grid(NULL, farm.emp.index.dis.swcounties.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(farm.emp.index.dis.swcounties.plot+theme(legend.position = "none"), total.emp.index.dis.swcounties.plot + theme(legend.position = "none"), NULL, farm.emp.index.dis.swcounties.legend.bottom, ncol = 2, rel_heights = c(1,.1)), height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

