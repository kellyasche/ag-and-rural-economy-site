---
title: "Ag employment"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```


```{r loading jon docs and shapefiles}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master ag employment objects, include=FALSE, cache=TRUE}
master.ag.emp.county <- read_csv("Data/Employment/Master-agrelated-emp-county.csv")

master.ag.emp.comb.county <- master.ag.emp.county %>%
  group_by(periodyear, Name, countyfp, Dem_Desc, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.ruca <- read_csv("Data/Employment/Master-agrelated-emp-ruca.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

master.ag.emp.comb.ruca <- master.ag.emp.ruca %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.pr <- read_csv("Data/Employment/Master-agrelated-emp-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.ag.emp.comb.pr <- master.ag.emp.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()


master.ag.emp.edr <- read_csv("Data/Employment/Master-agrelated-emp-edr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.ag.emp.comb.edr <- master.ag.emp.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()


```

<br>

# Summary of employment in ag-related industries

**Definition of ag-related industries**: This analysis cobbles together various NAICS codes that are directly related to "ag-related employment". This includes the following industries;

```{r ag-related industry list}
agrelated.ind.list <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  distinct(naicstitle) %>%
  rename(`Ag-related NAICS categories` = 1)

kable(agrelated.ind.list, format = "html", align = "c") %>%
    kable_styling(bootstrap_options = "striped") %>%
    column_spec(1, width = "10em")

```

Overall, employment in ag-industries does seem to be impacted by the crop commodity boom, at least as a regional level. The trends show that employment in ag-related industries were decreasing during the beginning 2000s, followed by a significant increase in employment in these industries during the crop commodity boom. Since 2012, however, employment has been decreasing again for most regions, but not all.

In particular, the EDRs in the Northwest and Central parts of the state are continuing to see growth in their employment by ag-related industries. The Southwest Region has been experiencing significant declines in these industries, however.

Analysis provided guidance on the characteristics of a county where they might be most impacted by employment trends in ag-related industries;

They are likely located in the following EDRs;

* Northwest
  + EDR 1 - Northwest
  + EDR 4 - West Central
* Central
  + EDR 6E - South Central
* Southwest
  + EDR 8 - Southwest
  + EDR 6W - Upper Minnesota Valley
  + EDR 9 - South Central

while also having at least 10% of their employment in ag-related industries at some point since 2001.

When applying these filters, we end up 25 counties that fall into two distinct groups; 

* Counties with growing employment in ag-related industries (12 counties)
  + 7 (58%) of the counties are experiencing a increase in their total employment
  + 5 (42%) of the counties are experiencing a decline in their total employment 
* Counties with declining employment in ag-related industries (13 counties)
  + 5 (38%) of the counties are experiencing a increase in their total employment
  + 8 (62%) of the counties are experiencing a decline in their total employment

The following tables provide these counties with a few more details.

<br>

**Counties with growing ag employment**

The table is organized so that the counties with the highest percentage of total employment in ag-related industries is at the top. Overall, this shows a general trend that if a county has experienced significant growth in ag-related industries and currently has 15% or more of the employment in these industries, they will likely also have growth in their total enrollment.

<br>

```{r table up counties summary}
up.counties.summary <- read_csv("Data/Employment/table-up-counties-summary.csv")

datatable(up.counties.summary, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since 2001",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)

```

<br>

**Counties with decreasing ag employment**

This table provides the 13 counties who are experiencing a decline in their ag-related employment, with rows highlighted in red if their total employment in 2018 is lower than in 2001. Not surprisingly, here the higher the percentage of a county’s workforce is in ag-related industries, the more likely they will also have less total employment in 2018 than in 2001.

<br>

```{r table down counties summary}
down.counties.summary <- read_csv("Data/Employment/table-down-counties-summary.csv")

datatable(down.counties.summary, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since peak ag employment year",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)

```


<br>

# Analysis

This analysis examines the impact employment in ag-related industries has on total employment across Minnesota. We will do this through the following sections;

**Change in ag employment vs. total employment since 2001**: We will examine the trends in ag employment and identify any regions whose total employment shows similar trends. This would mean that ag employment has an out sized impact on the total employment for the region.

**Ag employment as a % of total employment**: If there are trends in farm employment that are concerning, it is likely going to have the most impact in counties with a higher percentage of their total employment in ag-related industries. We will seek to identify those regions.

**Counties most impacted by ag employment**: Through the above analysis, we should begin to get the main characteristics of a county where ag employment is having a larger impact on total employment - the most likely planning region and EDRs the counties are located in, as well as some measurements and thresholds of their ag and total employment. This section will seek to identify those exact counties

## Change in ag employment vs. total employment {.tabset}

The charts below provide the change in farm employment and total employment by indexing the values to their 2001 levels. The trend to look for is how the fluctuations in farm employment “appear” in the total employment chart. If a regions employment is impacted by the farm economy, then we should see corresponding “bumps” or trends in the total employment charts that mimic the farm employment charts.

Overall, ag-related industries were definitely impacted by the crop commodity boom. There were significant increases in employment in these industries during that time and then a decline after 2012 in most regions. Interestingly, the largest increases are occurring in counties that are categorized as "town/rural mix". These counties are also not experiencing any sort of employment decline in these industries even after the downturn in crop commodities.

Not surprisingly, employment in ag-related industries are most prominent in Northwest, Central, Southwest, and Southeast Minnesota. Of course, it will be hard to discern what impacts increases and declines in ag-related industries are having on total employment, but evidence shows that there will be counties in the following EDRs that are being impacted the most;

* Northwest
  + EDR 1 - Northwest
  + EDR 4 - West Central
* Central
  + EDR 6E - East Central
* Southwest
  + EDR 6W - Upper Minnesota Valley
  + EDR 8 - Southwest
  + EDR 9 - South Central
  + EDR 10 - Southeast

The regions that may have areas most impacted by farm employment are located in the Northwest, Central, and Southwest regions of the state. Within those, the EDRs that should be looked at in more detail are;

<br>

```{r prep ag and total emp index, include=FALSE, cache=TRUE}
ag.emp.index.ruca <- master.ag.emp.comb.ruca %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()
  
ag.emp.index.pr <- master.ag.emp.comb.pr %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()

ag.emp.index.edr <- master.ag.emp.comb.edr %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()

```

### RUCA

Overall, employment in ag-related industries grew during the crop commodity boom between 2008 and 2012 across all county groups, although never recovering to 2001 levels in entirely rural counties. The large variation from year to year for this county group might be due to low employment levels, making small changes show high percentages. Employment levels are less than 2,000 people in these industries in this county group. We will find out in the next chart below which will provide the percentage of total employment is in ag-related industries for this county group.

Other RUCA county groups have experienced modest growth in these industries, with 2018 employment numbers being between 1% and 16% of 2001 levels. The town/rural county group in particular has seen a lot of employment growth in these industries.

Total employment follows a trend which would be expected during a period of the Great Recession. Employment dropped during that time frame and then has been slowly recovering since 2012. However, the recovery has been slow in our entirely rural counties.  

In addition, none of the total employment trend lines seem to match the trend lines of ag employment, meaning there just might not be much impact here.

<br>

```{r charts ag and total emp index ruca, fig.width=8}
ag.emp.index.ruca.plot <- ggplot(ag.emp.index.ruca, aes(periodyear, ag.emp.index, color = Dem_Desc)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.55, 1.15, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        legend.text = element_text(size = 10))

total.emp.index.ruca.plot <- ggplot(ag.emp.index.ruca, aes(periodyear, total.emp.index, color = Dem_Desc)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.55, 1.15, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10))

ag.emp.index.ruca.legend <- get_legend(ag.emp.index.ruca.plot + theme(legend.box.margin = margin(0,0,0,0)))

ag.emp.index.ruca.legend.bottom <- plot_grid(NULL, ag.emp.index.ruca.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(ag.emp.index.ruca.plot+theme(legend.position = "none"), total.emp.index.ruca.plot + theme(legend.position = "none"), NULL, ag.emp.index.ruca.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```


### Planning Region

The Northeast region is a bit of an outlier here. Employment in ag-related industries is only a few hundred employees, therefore small changes have a big impact on percentages. In fact, employment in ag-related industries only make up .5% of total employment in that region. 

All other regions outside of the seven county metro are experiencing increases in these industries. In particular, the Northwest and Central regions have experience 28% and 26% employment growth in these industries since 2001, respectively.And there is little evidence that the Great Recession had any impact on these industries. In fact, they seemed to grow a bit during that time frame.

As expected, total employment follows a pattern that's been impacted by the Great Recession, with a drop between 2008 and 2012, and increases following that time. It's difficult to say if there are any similarities between these trend lines and the ag-related employment trend lines.

<br>

```{r charts ag and total emp index pr, fig.width=8}

ag.emp.index.pr.plot <- ggplot(ag.emp.index.pr, aes(periodyear, ag.emp.index, color = planning.region)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.25, 1.35, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        legend.text = element_text(size = 10))


total.emp.index.pr.plot <- ggplot(ag.emp.index.pr, aes(periodyear, total.emp.index, color = planning.region)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.25, 1.35, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10))

ag.emp.index.pr.legend <- get_legend(ag.emp.index.pr.plot + theme(legend.box.margin = margin(0,0,0,0)))

ag.emp.index.pr.legend.bottom <- plot_grid(NULL, ag.emp.index.pr.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(ag.emp.index.pr.plot+theme(legend.position = "none"), total.emp.index.pr.plot + theme(legend.position = "none"), NULL, ag.emp.index.pr.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```


### EDR

In the northwest region, EDR 4 - West Central looks to have their total employment impacted by ag-related industries. They have experienced significant growth, 40% higher since 2001, while also experiencing significant growth in their overall employment, 15% since 2001. They also seem to have weathered the Great Recession better than others, perhaps because of the tremendous growth in ag-related industries. As of 2018, employment in ag-related industries represented 7.6% of total employment.

EDR 1 - Northwest, is also an industry that may have experienced some impacts from ag-related industries. These industries represent 7% of their total employment, has experienced 15% growth in these industries, while their total employment has experienced a slight recovery during time of growth in ag-related industries (2012 - 2018).

EDR 5 - North Central has similar trends to EDR 4 and 1, however employment in ag-related industries is less than 5% of the total employment in the region. 

Employment in ag-related industries in EDR 2 - Headwaters only represents 3% or less of total employment and there seems to be little relation.

In the Central region, EDR 6E - East Central has 10% or more of their total employment represented in ag-related industries, has experienced employment growth in these industries, and their total employment seems to have a similar trend line.

Any of the EDRs in Southwest Minnesota could be impacted by ag-related industries. After peaking at 12%, employment in ag-related industries in EDR 6W - Upper Minnesota Valley has decreased significantly and now only represents 7% of total employment. In addition, total employment in that region is at 95% of their total employment in 2001. These trend lines are very similar.

EDR 8 - Southwest peaked at 16% of their total employment in ag-related industries and by 2018 dropped to 14%. It's a little hard to tell whether the total employment trend line is similar, but the fact that they haven't seen any growth is evidence that there is a tie here.

Lastly, Southeast Minnesota has experienced modest growth in their employment in ag-related industries as well as their total employment. By 2018, ag-related industries represented 6% of total employment.

<br>

```{r charts ag and total emp index edr, fig.height=10}

ag.emp.index.edr.plot <- ggplot(ag.emp.index.edr, aes(periodyear, ag.emp.index, color = edr)) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~planning.region, ncol = 1) +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(edr, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.7, 1.5, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.x = element_text(size = 6))


total.emp.index.edr.plot <- ggplot(ag.emp.index.edr, aes(periodyear, total.emp.index, color = edr)) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~planning.region, ncol = 1) +
  geom_smooth(se = FALSE, size = 1) +
  geom_point_interactive(size = 2, aes(data_id = ag.emp.index, tooltip = paste(edr, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Total employment as a % of 2001 levels")+
  scale_y_continuous(labels=scales::percent)+
  coord_cartesian(ylim = seq(.7, 1.5, .1)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title = element_text(size = 10),
        axis.text.x = element_text(size = 6))

ag.emp.index.edr.legend <- get_legend(ag.emp.index.edr.plot + theme(legend.box.margin = margin(0,0,0,0)))

ag.emp.index.edr.legend.bottom <- plot_grid(NULL, ag.emp.index.edr.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe( ggobj =  plot_grid(ag.emp.index.edr.plot+theme(legend.position = "none"), total.emp.index.edr.plot + theme(legend.position = "none"), NULL, ag.emp.index.edr.legend.bottom, ncol = 2, rel_heights = c(1,.1)), height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Ag employment as a % of total employment {.tabset}

The charts below provide employment in ag-related industries as a percentage of total employment each year. The trend to see here is how much that percentage has changed over time.

Overall, the percentages have been relatively consistent, with more significant growth in the town/rural mix county group. There doesn't seem to be any indication that the downturn in crop commodities is impacting these industries except maybe in Southwest Minnesota.

The EDRs with the most significant amount of their employment originating from ag-related industries are;

* Northwest
  + EDR 1 - Northwest: 6.6% with a little growth since 2008
  + EDR 4 - West Central: 7.6% with a little growth since 2008 
* Central
  + EDR 6E - Southwest Central: 12% with a little growth since 2008
* Southwest
  + EDR 6W - Upper Minnesota Valley: 7% with significant decline since 2010
  + EDR 8 - Southwest: 14% with significant decline since 2010
  + EDR 9 - South Central: 9.6% with a little growth since 2010

<br>

### RUCA

Not surprisingly, ag-related industries comprise a larger percentage of total employment the more rural an area is. Interestingly, the percentage increase for all the county groups during the Great Recession, likely because those industries were hiring or not laying off while all other industries were losing employment.

Similar to the previous charts, the town/rural mix county group continues to see high percentages of their employment originate from ag-related industries.

<br>

```{r chart ag emp as % of total emp ruca}
ag.pct.total.emp.ruca.plot <- ggplot(ag.emp.index.ruca, aes(periodyear, ag.pct.total.emp, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.emp.index, tooltip = paste(Dem_Desc, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = ag.pct.total.emp.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Overall, employment in ag-related industries seems to be relatively stable across all regions despite the decline in crop commodities.

The Southwest region has, by far, the highest percentage of total employment originating from ag-related industries. By 2018, these industries represented 11% of total employment.

The Southeast, Northwest, and Central regions all have percentages between 5% and 6%.


<br>

```{r chart ag emp as % of total emp pr}
ag.pct.total.emp.pr.plot <- ggplot(ag.emp.index.pr, aes(periodyear, ag.pct.total.emp, color = planning.region)) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.emp.index, tooltip = paste(planning.region, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom")

girafe(ggobj = ag.pct.total.emp.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR

Just like the previous EDR chart, the EDRs we highlighted there are definitely the ones with the highest percentage of employment coming from ag-related industries. EDR 4 - West Central and EDR 1 - Northwest each have 6% to 7% of their employment coming from ag-related industries with continued growth.

EDR 6E - South Central has 12% of their employment coming from ag-related industries and has stayed relatively stable since 2001.

EDR 8 - Southwest and EDR 6W - Upper Minnesota Valley have decreasing percentage of their total employment coming from ag-related industries. EDR 8 peaked in 2010 with 16.5% of their employment in these industries while EDR 6W peaked that same year with 12%. EDR 9 - South Central has experienced slow, steady growth.

The Southeast has been relatively constant at 6%.

<br>

```{r chart ag emp as % of total emp edr, fig.height=10}

ag.pct.total.emp.edr.plot <- ggplot(ag.emp.index.edr, aes(periodyear, ag.pct.total.emp, color = edr)) +
  facet_wrap(~planning.region, ncol = 1) +
  geom_smooth(se = FALSE, size = 2) +
  geom_point_interactive(size = 3, aes(data_id = ag.emp.index, tooltip = paste(edr, "\nYear: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), "\nPercent change in ag employment since 2001: ", percent(ag.emp.index), "\nPercent change in total employment since 2001: ", percent(total.emp.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Ag employment as a % of total employment")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

girafe(ggobj = ag.pct.total.emp.edr.plot, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

<br>

## Counties employment most impacted by ag-related industries {.tabset}

The previous charts show that we are most likely looking at counties in the following EDRs;

* Northwest
  + EDR 1 - Northwest
  + EDR 4 - West Central
* Central
  + EDR 6E - South Central
* Southwest
  + EDR 8 - Southwest
  + EDR 6W - Upper Minnesota Valley
  + EDR 9 - South Central
* Southeast
  + EDR 10 - Southeast
  
We can further filter our counties that have had 10% or more of their total employment in ag-related industries at some point between 2001 and 2018. This will help us identify which counties are relying on the continued growth of the ag-related industries for employment and others who are impacted by the decline of ag-related industries.

Applying these filters provides us with 25 counties. The following map provides those counties and their 2018 percentage of total employment originating from ag related industries. Counties labeled as "NA" means that at no point since 2001 has their percentage reached the 10% threshold. 

The map on the left highlights a few counties where ag employment is more prominent. Three counties have 20% or more of their employment from these industries; Sibley, Todd, and Watonwan. Two counties have percentages between 15% and 20%; Stevens and Kandiyohi. The majority (12) of these counties have between 10% and 15% of the employment in ag-related industries while the remaining 8 have 10% or less.

The map on the right highlights the counties where employment in ag-industries is continuing to grow. Counties in the Northeast and Central regions of the state are typically seeing growth in these industries while the Southwest are experiencing declines since ag employment peaked before 2015 in most of those counties.

<br>

```{r prep impacted counties and ag peak year, include = FALSE,cache=TRUE}
impacted.counties <- master.ag.emp.comb.county %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp) %>%
  filter(ag.pct.total.emp > .1)  %>%
  distinct(Name, .keep_all = TRUE) %>%
  mutate(impacted.county = "yes")

impacted.counties.trends <- master.ag.emp.comb.county %>%
  left_join(impacted.counties[,c(3,10)], by = "countyfp") %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp,
         ag.emp.index = ag.emp / ag.emp[periodyear == 2001],
         total.emp.index = total.emp / total.emp[periodyear == 2001],
         ag.pct.total.emp.bins = ifelse(impacted.county == "yes", as.character(cut(ag.pct.total.emp,
                                     breaks = c(0, .05, .1, .15, .2, 1),
                                     labels = c("0%-5%", "5%-10%", "10%-15%", "15%-20%", "20%+")), NA)),
         ag.pct.total.emp.bins = fct_relevel(ag.pct.total.emp.bins, "0%-5%", "5%-10%", "10%-15%", "15%-20%", "20%+")) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

ag.peak.year <- impacted.counties.trends %>%
  group_by(Name, countyfp, Dem_Desc, edr, planning.region) %>%
  top_n(n = 1, wt=ag.emp) %>%
  arrange(desc(periodyear)) %>%
  distinct(Name, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(peak.year.bins = ifelse(impacted.county == "yes", as.character(cut(periodyear,
                                                               breaks = c(2000, 2005, 2010, 2015, 2016, 2020),
                                                               labels = c("2001-2005", "2006-2010", "2011-2015", "2015-2016", "2017-2018"))), NA),
         peak.year.bins = fct_relevel(peak.year.bins, "2001-2005", "2006-2010", "2011-2015", "2015-2016", "2017-2018"))


```

```{r map impacted counties and peak year, fig.width=8}
impacted.counties.map <- ggplot(filter(impacted.counties.trends, periodyear == 2018)) +
  geom_sf_interactive(aes(fill = ag.pct.total.emp.bins, tooltip = paste(Name, "\nAg employment as a % of total employment in 2018: ", percent(ag.pct.total.emp), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(values = c("#edf8fb", "#b2e2e2", "#66c2a4", "#2ca25f", "#006d2c"), na.value = "grey")+
  theme_sf+
  labs(title="Ag employment as a % of total employment in 2018") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")


ag.peak.year.map <- ggplot(filter(ag.peak.year)) +
  geom_sf_interactive(aes(fill = peak.year.bins, tooltip = paste(Name, "\nPeak year of ag employment: ", periodyear, "\nAg employment: ", comma(ag.emp), "\nTotal employment: ", comma(total.emp), "\nAg employment as % of total employment: ", percent(ag.pct.total.emp), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(values = c("#edf8fb", "#b2e2e2", "#66c2a4", "#2ca25f", "#006d2c"), na.value = "grey")+
  theme_sf+
  labs(title="Year of peak ag employment") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

girafe(ggobj = plot_grid(impacted.counties.map, ag.peak.year.map), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

What the previous charts highlight is that there are currently two groups of counties - counties that are experiencing growth in their ag employment and counties that are not. The tables below provide two tables, each with counties fitting into that category. Here is how they break down;

* Counties with growing employment in ag-related industries (12 counties)
  + 7 (58%) of the counties are experiencing a increase in their total employment
  + 5 (42%) of the counties are experiencing a decline in their total employment 
* Counties with declining employment in ag-related industries (13 counties)
  + 5 (38%) of the counties are experiencing a increase in their total employment
  + 8 (62%) of the counties are experiencing a decline in their total employment
  

```{r prep impacted county table, include = FALSE, cache=TRUE}

ag.up.counties <- ag.peak.year %>%
  filter(periodyear > 2016,
         impacted.county == "yes")

ag.up.counties.trends <- impacted.counties.trends %>%
  right_join(ag.up.counties[,c(3)], by = "countyfp") %>%
  group_by(Name, countyfp, Dem_Desc, edr, planning.region) %>%
  mutate(ag.emp.pct.change = (ag.emp - ag.emp[periodyear==2001]) / ag.emp[periodyear==2001],
         total.emp.pct.change = (total.emp - total.emp[periodyear == 2001]) / total.emp[periodyear == 2001]) %>%
  ungroup() %>%
  filter(periodyear == 2018) %>%
  select(2,10,15,16) %>% 
  arrange(desc(ag.pct.total.emp)) %>%
  rename("Ag employment as % of total employment in 2018" = 2,
         "Change in ag employment since 2001" = 3,
         "Change in total employment since 2001" = 4) 

ag.down.counties <- ag.peak.year %>%
  filter(periodyear < 2017,
         impacted.county == "yes") %>%
  rename(peak.year = 1,
         ag.emp.peak = 7,
         total.emp.peak = 8)

names(ag.down.counties)

ag.down.counties.trends <- impacted.counties.trends %>%
  right_join(ag.down.counties[,c(3,7,8)], by = "countyfp") %>%
  filter(periodyear == 2018) %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp,
         ag.emp.pct.change.peak = (ag.emp - ag.emp.peak) / ag.emp.peak,
         total.emp.pct.change.peak = (total.emp - total.emp.peak) / total.emp.peak) %>%
  select(2,10,17,18) %>%
  arrange(desc(ag.pct.total.emp)) %>%
  rename("Ag employment as % of total employment in 2018" = 2,
         "Change in ag employment peak ag employment year" = 3,
         "Change in total employment since peak ag employment year" = 4)
```


<br>

### Counties with growth in ag employment
The table is organized so that the counties with the highest percentage of total employment in ag-related industries is at the top. Overall, this shows a general trend that if a county has experienced significant growth in ag-related industries and currently has 15% or more of the employment in these industries, they will likely also have growth in their total enrollment.

<br>

```{r table ag up counties}

datatable(ag.up.counties.trends, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since 2001",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)

```

### Counties with decreasing ag employment

This table provides the 13 counties who are experiencing a decline in their ag-related employment, with rows highlighted in red if their total employment in 2018 is lower than in 2001. Not surprisingly, here the higher the percentage of a county's workforce is in ag-related industries, the more likely they will also have less total employment in 2018 than in 2001.

<br>



```{r table ag down counties}

datatable(ag.down.counties.trends, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since peak ag employment year",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)


```

