---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r master land value and net income objects, include=FALSE, cache=TRUE}
master.netinc.county <- read_csv("Data/Income and expenses/Master-farm-income-expenses.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  left_join(counties.regions[,c(1,2)], by = "countyfp") %>%
  filter(Name != "Minnesota")

master.lv.county <- read_csv("Data/Land values/Master-ag-land-values.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  rename(year = Year) %>%
  filter(County != "Minnesota") %>%
  rename(Name = County)

```

```{r prep net income and land values index, include=FALSE, cache=TRUE}
net.income.acre.ruca <- master.netinc.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.ruca <- master.lv.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.pr <- master.netinc.county %>%
  group_by(planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.pr <- master.lv.county %>%
  group_by(planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.edr <- master.netinc.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(edr, planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.edr <- master.lv.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

```

## Changes in net income vs. changes in land values since year of peak net incomes {.tabset}

Summary here

<br>

```{r prep year of peak net income, include=FALSE, cache=TRUE}
net.inc.peak.year.ruca <- net.income.acre.ruca %>%
  group_by(Dem_Desc) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.ruca <- land.value.acre.ruca %>%
  right_join(net.inc.peak.year.ruca[,c(1,2)], by = c("Dem_Desc", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.ruca <- net.income.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.ruca <- land.value.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.ruca <- net.inc.change.peak.year.ruca %>%
  left_join(land.value.change.peak.year.ruca[,c(1,4,5,9,10,11)], by = "Dem_Desc") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))


net.inc.peak.year.pr <- net.income.acre.pr %>%
  group_by(planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.pr <- land.value.acre.pr %>%
  right_join(net.inc.peak.year.pr[,c(1,2)], by = c("planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.pr <- net.income.acre.pr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.pr<- land.value.acre.pr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.pr <- net.inc.change.peak.year.pr %>%
  left_join(land.value.change.peak.year.pr[,c(1,4,5,9,10,11)], by = "planning.region") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"),
         planning.region = str_replace(planning.region, "Seven County Mpls-St Paul", "Seven County\nMpls-St Paul"))



net.inc.peak.year.edr <- net.income.acre.edr %>%
  group_by(edr, planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 3,
         net.income.peak = 4,
         total.acre.peak = 5,
         net.income.acre.peak = 6)

land.value.peak.year.edr <- land.value.acre.edr %>%
  right_join(net.inc.peak.year.edr[,c(1,2,3)], by = c("edr", "planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 3,
         total.acres.peak = 4,
         total.value.peak = 5,
         land.value.acre.peak = 6)

net.inc.change.peak.year.edr <- net.income.acre.edr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.edr<- land.value.acre.edr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.edr <- net.inc.change.peak.year.edr %>%
  left_join(land.value.change.peak.year.edr[,c(1,2,5, 6,10,11,12)], by = c("edr", "planning.region")) %>%
  gather(key = "income.land", value = "pct.change", 12, 17) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))

```

### RUCA

Net farm income peaked in 2013 in entirely rural counties and since that time net income has decreased by 80%, while land values have only decreased 3.4%. 

The rest of the county groups had their net farm income per acre peak in 2012 and since that time have had their net incomes drop a similar amount to entirely rural counties while land value per acre is 25% to 30% higher in 2018 than in 2012. 

<br>

```{r chart change in net inc and land value since peak year rucA}

net.inc.land.value.change.peak.year.ruca.plot <- ggplot(net.inc.land.value.change.peak.year.ruca, aes(x = Dem_Desc, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 3,aes(data_id = Dem_Desc, tooltip = paste(Dem_Desc, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank())+
        scale_color_manual(values = c("#8c510a", "#076324"))


girafe(ggobj = net.inc.land.value.change.peak.year.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Ovearll, net farm income per acre peaked between 2012 - 2014 for all planning regions and have decreased between 70% and 95%. Across most regions, land values per acre are still 2% to 40% higher than they were during the peak farm income years. Land values have decreased, however, in Southwest Minnesota where they are 8% of the value they were in 2013, the peak farm income year.


<br>

```{r chart change in net inc and land value since peak year pr}

net.inc.land.value.change.peak.year.pr.plot <- ggplot(net.inc.land.value.change.peak.year.pr, aes(x = planning.region, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 3,aes(data_id = planning.region, tooltip = paste(planning.region, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank())+
        scale_color_manual(values = c("#8c510a", "#076324"))


girafe(ggobj = net.inc.land.value.change.peak.year.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR

Analysis

<br>

```{r chart change in net inc and land value since peak year edr, fig.height=10}

net.inc.land.value.change.peak.year.edr.plot <- ggplot(net.inc.land.value.change.peak.year.edr, aes(x = edr, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  facet_wrap(~planning.region, ncol = 2, scales = "free_x") +
  geom_point_interactive(size = 3,aes(data_id = edr, tooltip = paste(edr, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank())+
        scale_color_manual(values = c("#8c510a", "#076324"))

girafe(ggobj = net.inc.land.value.change.peak.year.edr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```