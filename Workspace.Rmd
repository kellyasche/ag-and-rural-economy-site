---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master wage file, include = FALSE, cache = TRUE}
ag.ind.wages.county <- read_csv("Data/Earnings/Master-ag-related-ind-wages-counties.csv")

ag.ind.wages.pr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""))

ag.ind.wages.edr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-edr.csv") %>%
  left_join(edr.pr, by = "edr") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

```{r prep ag  wages and total wages index, include = FALSE, cache=TRUE}
ag.total.wages.ruca <- ag.ind.wages.county %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

ag.total.wages.pr <- ag.ind.wages.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

ag.total.wages.edr <- ag.ind.wages.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

## Peak ag-related wages vs. peak total wages{.tabset}

The following maps compare the years that total wages and ag wages peaked for each county as well as the change in wages earned that has occurred since the peak year.

The maps clearly indicate that there are counties in Southwest Minnesota that have experienced a decline in ag-related wages. A majority of counties in Southwest Minnesota have experienced a 10% or more drop in their wages earned in ag-related industries. 

However, the maps do not show strong evidence that declines in ag-related wages have impacted overall total wages in any of the counties. The counties that show, perhaps, the biggest influence from ag wages are Lac qui Parle, Faribault, and Waseca.


<br>

### Peak year of ag-related wages vs. total wages

The year that ag-related wages earned peaked varies considerably across Western Minnesota. One trend to note is that there is a lot more 2016-2018 peak years across Central and Northwest Minnesota compared to Southwest Minnesota. 

When comparing across the maps, it's not very evident that the declines occurring in ag-related wages has had any impact on total wages since nearly every county has had their total wages peak in 2017 or 2018. The counties that may have been impacted the most are Lac qui Parle, Faribault, and Waseca.

```{r prep peak year of ag and total wages, include=FALSE, cache=TRUE}
aw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = ag.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
  mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

tw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = total.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
    mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```

```{r map ag wages and total wages peak year, fig.width=8}
aw.peak.year.plot <- ggplot(aw.peak.year) +
    geom_sf_interactive(aes(fill = peak.year.bins, tooltip = paste(areaname, "\nYear of peak ag-related wages earned: ", periodyear), data_id = areaname, geometry = geometry)) +
    scale_fill_manual(values = c("white", "red", "red3", "red4", "grey", "black"))+
    theme_sf+
    labs(title="Year of peak ag-related wages earned") +
  theme(text = element_text(size = 10))

tw.peak.year.plot <- ggplot(tw.peak.year) +
    geom_sf_interactive(aes(fill = peak.year.bins, tooltip = paste(areaname, "\nYear of peak total wages earned: ", periodyear), data_id = areaname, geometry = geometry)) +
    scale_fill_manual(breaks = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"),
                      values = c("Before 2010" = "white", "2010-2011" = "red", "2012-2013" = "red3", "2014-2015" = "red4", "2016-2017" = "grey", "2018" = "black"))+
    theme_sf+
    labs(title="Year of peak total wages earned") +
  theme(text = element_text(size = 10))

aw.peak.year.legend <- get_legend(aw.peak.year.plot)
  
girafe( ggobj = plot_grid(aw.peak.year.plot + theme(legend.position = "none"), aw.peak.year.legend, tw.peak.year.plot + theme(legend.position = "none"), rel_widths = c(1,.5,1), ncol = 3), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))


```

### Change in ag wages since peak year

The map below focuses on the counties within EDRs that were identified as having a sizable percentage of their total wages come from ag-related industries. The colors provide the percentage *point* change in ag wages as a percent of total wages from the year that ag wages peaked. 

What becomes quickly apparent is that counties in Southwest Minnesota have been impacted the most. A majority of counties have experienced a drop of 10% or more in wages earned in ag-related industries.

The counties that looked to have their total wages impacted the most by ag-related wages was Lac qui Parle, Faribault and Waseca. Sure enough, in this map those counties have experienced considerable decline in their ag wages. Lac qui Parle reported wages earned from ag industries 69% lower than in 2010, Waseca 73% lower than in 2013, and Waseca was 3% lower than in 2017. 

Since the year that ag-wages peaked varies considerably, it can be a bit challenging to discern how much of an impact this is having on the overall economy since impacts can depend on the quickness of change. For example, Lyon County experienced a 32% decrease in their wages since their peak year. However, their peak year was in 2002. Compare that to Lac qui Parle where they have experienced a 69% drop in wages earned from ag-related industries since their peak year, which was in 2010. That's a much more abrupt change.

<br>

```{r prep change in ag wages since peak year, include=FALSE, cache=TRUE}

aw.2018 <- ag.ind.wages.county %>%
  filter(periodyear == 2018) %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  rename(ag.wages.2018 = ag.wages,
         total.wages.2018 = total.wages)

aw.earned.peak <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(aw.peak.year[,c(1,3)], by = c("countyfp", "periodyear")) %>%
  left_join(aw.2018[,c(3,5,6)], by = "countyfp") %>%
  mutate(aw.pct.tw.peak = ag.wages / total.wages,
         aw.pct.tw.2018 = ag.wages.2018 / total.wages.2018,
         change.aw.pct.tw = 100* (aw.pct.tw.2018 - aw.pct.tw.peak),
         change.aw.peak.2018 = (ag.wages.2018 - ag.wages)/ag.wages)


aw.earned.peak.select.edrs <- aw.earned.peak %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(change.aw.peak.2018.bins = cut(change.aw.peak.2018,
                                     breaks = c(-1, -.5, -.3, -.1, -.01, 1),
                                     labels = c("-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))) %>%
  mutate(change.aw.peak.2018.bins = ifelse(edr %in% c("EDR  1 - Northwest", "EDR  4 - West Central", "EDR  6E- Southwest Central", "EDR  6W- Upper Minnesota Valley", "EDR  8 - Southwest", "EDR  9 - South Central"), as.character(change.aw.peak.2018.bins), NA),
         change.aw.peak.2018.bins = fct_relevel(change.aw.peak.2018.bins, "-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))

```

```{r map pct point change in ag wages since peak, fig.width=8}
aw.earned.peak.select.edrs.plot <- ggplot(aw.earned.peak.select.edrs) +
    geom_sf_interactive(aes(fill = change.aw.peak.2018.bins, tooltip = paste(areaname, "\nPeak year of ag wages earned: ", periodyear, "\nAg wages as % of total wages during peak year: ", percent(aw.pct.tw.peak), "\nAg wages as % of total wages in 2018: ", percent(aw.pct.tw.2018), "\nPercent change in ag wages since peak year: ", percent(change.aw.peak.2018), sep = ""), data_id = areaname)) +
    scale_fill_manual(values = c("#a50f15", "#de2d26", "#fb6a4a", "#fcae91", "grey"))+
    theme_sf+
    labs(title="Change in ag wages since the peak year in\nselect EDRs") +
  theme(text = element_text(size = 12))
  
girafe( ggobj = aw.earned.peak.select.edrs.plot, width_svg = 6) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```