---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master farm employment objects, include=FALSE, cache=TRUE}
master.farm.emp.county <- read_csv("Data/Employment/bea-farm-total-employment.csv") %>%
  drop_na(LineCode) %>%
  mutate(countyfp = str_sub(GeoFips, 3, 5)) %>%
  left_join(counties.regions, by = "countyfp") %>%
  select(23,24,3:22, 25:28) %>%
  gather(key = "year", value = "employment", 5:22) %>%
  select(-3) %>%
  spread(key = Description, value = employment) %>%
  rename(farm.emp = 8,
         total.emp = 9) %>%
  mutate(year = as.integer(year),
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  filter(Name != "Minnesota")

master.farm.emp.ruca <- master.farm.emp.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

master.farm.emp.pr <- master.farm.emp.county %>%
  group_by(planning.region, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.farm.emp.edr <- master.farm.emp.county %>%
  group_by(edr,planning.region, year) %>%
  summarise(farm.emp = sum(farm.emp, na.rm = TRUE),
            total.emp = sum(total.emp, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

```{r prep farm and total emp index, include=FALSE, cache=TRUE}
farm.emp.index.ruca <- master.farm.emp.ruca %>%
  group_by(Dem_Desc) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

farm.emp.index.pr <- master.farm.emp.pr %>%
  group_by(planning.region) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

farm.emp.index.edr <- master.farm.emp.edr %>%
  group_by(edr, planning.region) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup()

```


```{r prep farm emp as % of total emp, include=FALSE, cache=TRUE}
farm.pct.total.emp.ruca <- master.farm.emp.ruca  %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

farm.pct.total.emp.pr <- master.farm.emp.pr %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

farm.pct.total.emp.edr <- master.farm.emp.edr %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)

```

```{r prep peak year of total employment and % of employment in farming in 2018, include=FALSE, cache=TRUE}

total.emp.peak.year.county <- master.farm.emp.county %>%
  group_by(countyfp, Name) %>%
  top_n(n = 1, wt = total.emp) %>%
  ungroup() %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(year.bins = cut(year,
                         breaks = c(2000, 2005, 2010, 2015, 2020),
                         labels = c("2000-2005", "2006-2010", "2011-2015", "2016-2018" )))

farm.pct.total.emp.2018.county <- master.farm.emp.county %>%
  filter(year == 2018) %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(farm.pct.total.emp.bins = cut(farm.pct.total.emp,
                                       breaks = c(0, .05, .10, .15, .2, .3),
                                       labels = c("Less than 5%", "5%-10%", "10%-15%", "15%-20%", "More than 20%")))

```

<br>

## Counties most disrupted by declines in farm employment {.tabset}

The previous sections have provided the following guidance on identifying which counties have been possibly impacted by declines in farm employment;

* are located in the Northwest, Central, or Southwest planning regions;
* have 10% or more of their employment in farming; and
* have had their employment peak before 2016.

Those counties are;

<br>

```{r prep identify most disrupted counties, include=FALSE, cache=TRUE}

disrupted.counties <- master.farm.emp.county %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp) %>%
  left_join(total.emp.peak.year.county[,c(1,7)], by = "countyfp") %>%
  rename(total.emp.peak.year = 11) %>%
  filter(planning.region %in% c("Northwest", "Central", "Southwest"),
         total.emp.peak.year < 2016,
         farm.pct.total.emp > .1,
         year.x == 2018,
         farm.pct.total.emp > .1) %>%
  distinct(countyfp, .keep_all = TRUE) 


```

```{r table identify most disrupted counties}
disrupted.counties.table <- disrupted.counties %>%
  select(2,4,5,6) %>%
  arrange(planning.region, edr)

kable(format = "html", disrupted.counties.table, escape = F) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE) 
```

```{r prep farm and total employment index for disrupted counties, include=FALSE, cache=TRUE}

farm.total.emp.index.dis.counties <- master.farm.emp.county %>%
  right_join(disrupted.counties[,c(1)], by = "countyfp") %>%
  group_by(countyfp, Name) %>%
  mutate(farm.emp.index = farm.emp / farm.emp[year == 2001],
         total.emp.index = total.emp / total.emp[year == 2001]) %>%
  ungroup() %>%
  mutate(farm.pct.total.emp = farm.emp / total.emp)
```

<br>

This table provides the change in farm and total employment from 2001 to 2018 as well as the percentage that total employment is comprised of farm employment in 2018. This can provide a bit more information on the counties.

```{r prep farm and total emp declines disrupted counties, include=FALSE, cache=TRUE}

farm.total.emp.index.dis.counties.table <- farm.total.emp.index.dis.counties %>%
  group_by(countyfp, Name) %>%
  mutate(farm.emp.change = (farm.emp - farm.emp[year==2001]) / farm.emp[year==2001],
         total.emp.change = (total.emp - total.emp[year==2001]) / total.emp[year==2001]) %>%
  ungroup() %>%
  filter(year == 2018) %>%
  select(2,4,5,6,12,13,14) %>%
  rename("RUCA" = 2,
         "Planning Region" = 4,
         "Farm employment as % of total" = 5,
         "Change in farm employment since 2001" = 6,
         "Change in total employment since 2001" = 7)
```

```{r table disrupted counties}
datatable(farm.total.emp.index.dis.counties.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatPercentage(5:7)
```



