---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master ag employment objects, include=FALSE, cache=TRUE}
master.ag.emp.county <- read_csv("Data/Employment/Master-agrelated-emp-county.csv")

master.ag.emp.comb.county <- master.ag.emp.county %>%
  group_by(periodyear, Name, countyfp, Dem_Desc, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.ruca <- read_csv("Data/Employment/Master-agrelated-emp-ruca.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

master.ag.emp.comb.ruca <- master.ag.emp.ruca %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()

master.ag.emp.pr <- read_csv("Data/Employment/Master-agrelated-emp-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

master.ag.emp.comb.pr <- master.ag.emp.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()


master.ag.emp.edr <- read_csv("Data/Employment/Master-agrelated-emp-edr.csv") %>%
  mutate(planning.region = str_replace(planning.region, ", MN", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

master.ag.emp.comb.edr <- master.ag.emp.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.emp = sum(emp[naicstitle != "Total, All Industries"]),
            total.emp = sum(emp[naicstitle == "Total, All Industries"])) %>%
  ungroup()


```

```{r ag-related industry list}
agrelated.ind.list <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  distinct(naicstitle) %>%
  rename(`Ag-related NAICS categories` = 1)

```

```{r prep ag and total emp index, include=FALSE, cache=TRUE}
ag.emp.index.ruca <- master.ag.emp.comb.ruca %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()
  
ag.emp.index.pr <- master.ag.emp.comb.pr %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()

ag.emp.index.edr <- master.ag.emp.comb.edr %>%
  mutate(ag.emp.index = ag.emp / ag.emp[periodyear==2001],
         total.emp.index = total.emp / total.emp[periodyear==2001],
         ag.pct.total.emp = ag.emp / total.emp) %>%
  ungroup()

```

```{r prep impacted counties and ag peak year, include = FALSE,cache=TRUE}
impacted.counties <- master.ag.emp.comb.county %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp) %>%
  filter(ag.pct.total.emp > .1)  %>%
  distinct(Name, .keep_all = TRUE) %>%
  mutate(impacted.county = "yes")

impacted.counties.trends <- master.ag.emp.comb.county %>%
  left_join(impacted.counties[,c(3,10)], by = "countyfp") %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp,
         ag.emp.index = ag.emp / ag.emp[periodyear == 2001],
         total.emp.index = total.emp / total.emp[periodyear == 2001],
         ag.pct.total.emp.bins = ifelse(impacted.county == "yes", as.character(cut(ag.pct.total.emp,
                                     breaks = c(0, .05, .1, .15, .2, 1),
                                     labels = c("0%-5%", "5%-10%", "10%-15%", "15%-20%", "20%+")), NA)),
         ag.pct.total.emp.bins = fct_relevel(ag.pct.total.emp.bins, "0%-5%", "5%-10%", "10%-15%", "15%-20%", "20%+")) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

ag.peak.year <- impacted.counties.trends %>%
  group_by(Name, countyfp, Dem_Desc, edr, planning.region) %>%
  top_n(n = 1, wt=ag.emp) %>%
  arrange(desc(periodyear)) %>%
  distinct(Name, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(peak.year.bins = ifelse(impacted.county == "yes", as.character(cut(periodyear,
                                                               breaks = c(2000, 2005, 2010, 2015, 2016, 2020),
                                                               labels = c("2001-2005", "2006-2010", "2011-2015", "2015-2016", "2017-2018"))), NA),
         peak.year.bins = fct_relevel(peak.year.bins, "2001-2005", "2006-2010", "2011-2015", "2015-2016", "2017-2018"))


```

<br>

## Placeholder {.tabset}

What the previous charts highlight is that there are currently two groups of counties - counties that are experiencing growth in their ag employment and counties that are not. The tables below provide two tables, each with counties fitting into that category. Here is how they break down;

* Counties with growing employment in ag-related industries (12 counties)
  + 7 (58%) of the counties are experiencing a increase in their total employment
  + 5 (42%) of the counties are experiencing a decline in their total employment 
* Counties with declining employment in ag-related industries (13 counties)
  + 5 (38%) of the counties are experiencing a increase in their total employment
  + 8 (62%) of the counties are experiencing a decline in their total employment
  

```{r prep impacted county table, include = FALSE, cache=TRUE}

ag.up.counties <- ag.peak.year %>%
  filter(periodyear > 2016,
         impacted.county == "yes")

ag.up.counties.trends <- impacted.counties.trends %>%
  right_join(ag.up.counties[,c(3)], by = "countyfp") %>%
  group_by(Name, countyfp, Dem_Desc, edr, planning.region) %>%
  mutate(ag.emp.pct.change = (ag.emp - ag.emp[periodyear==2001]) / ag.emp[periodyear==2001],
         total.emp.pct.change = (total.emp - total.emp[periodyear == 2001]) / total.emp[periodyear == 2001]) %>%
  ungroup() %>%
  filter(periodyear == 2018) %>%
  select(2,10,15,16) %>% 
  arrange(desc(ag.pct.total.emp)) %>%
  rename("Ag employment as % of total employment in 2018" = 2,
         "Change in ag employment since 2001" = 3,
         "Change in total employment since 2001" = 4) 

ag.down.counties <- ag.peak.year %>%
  filter(periodyear < 2017,
         impacted.county == "yes") %>%
  rename(peak.year = 1,
         ag.emp.peak = 7,
         total.emp.peak = 8)

names(ag.down.counties)

ag.down.counties.trends <- impacted.counties.trends %>%
  right_join(ag.down.counties[,c(3,7,8)], by = "countyfp") %>%
  filter(periodyear == 2018) %>%
  mutate(ag.pct.total.emp = ag.emp / total.emp,
         ag.emp.pct.change.peak = (ag.emp - ag.emp.peak) / ag.emp.peak,
         total.emp.pct.change.peak = (total.emp - total.emp.peak) / total.emp.peak) %>%
  select(2,10,17,18) %>%
  arrange(desc(ag.pct.total.emp)) %>%
  rename("Ag employment as % of total employment in 2018" = 2,
         "Change in ag employment peak ag employment year" = 3,
         "Change in total employment since peak ag employment year" = 4)
```


<br>

### Counties with growth in ag employment
The table is organized so that the counties with the highest percentage of total employment in ag-related industries is at the top. Overall, this shows a general trend that if a county has experienced significant growth in ag-related industries and currently has 15% or more of the employment in these industries, they will likely also have growth in their total enrollment.

<br>

```{r table ag up counties}

datatable(ag.up.counties.trends, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since 2001",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)

```

### Counties with decreasing ag employment

This table provides the 13 counties who are experiencing a decline in their ag-related employment, with rows highlighted in red if their total employment in 2018 is lower than in 2001. Not surprisingly, here the higher the percentage of a county's workforce is in ag-related industries, the more likely they will also have less total employment in 2018 than in 2001.

<br>



```{r table ag down counties}

datatable(ag.down.counties.trends, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE,
                         pageLength = 15)) %>%
  formatStyle("Change in total employment since peak ag employment year",
              target = "row",
              backgroundColor = styleInterval(c(-1, 0), c("red", "red", "transparent"))) %>%
  formatPercentage(2:4)

```
