---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r prep master wage file, include = FALSE, cache = TRUE}
ag.ind.wages.county <- read_csv("Data/Earnings/Master-ag-related-ind-wages-counties.csv")

ag.ind.wages.pr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-pr.csv") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", ""))

ag.ind.wages.edr <- read_csv("Data/Earnings/Master-ag-related-ind-wages-edr.csv") %>%
  left_join(edr.pr, by = "edr") %>%
  mutate(planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

```

```{r prep ag  wages and total wages index, include = FALSE, cache=TRUE}
ag.total.wages.ruca <- ag.ind.wages.county %>%
  group_by(periodyear, Dem_Desc) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(Dem_Desc) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"))

ag.total.wages.pr <- ag.ind.wages.pr %>%
  group_by(periodyear, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"))

ag.total.wages.edr <- ag.ind.wages.edr %>%
  group_by(periodyear, edr, planning.region) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(edr) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2001],
         total.wages.index = total.wages / total.wages[periodyear == 2001]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages,
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

```

```{r prep peak year of ag and total wages, include=FALSE, cache=TRUE}
aw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = ag.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
  mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

tw.peak.year <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp) %>%
  summarise(total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(areaname, countyfp) %>%
  top_n(n=1, wt = total.wages) %>%
  ungroup() %>%
  distinct(areaname, .keep_all = TRUE) %>%
    mutate(peak.year.bins = cut(periodyear,
                              breaks = c(2000, 2009, 2011, 2013, 2015, 2017, 2020),
                              labels = c("Before 2010", "2010-2011", "2012-2013", "2014-2015", "2016-2017", "2018"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```

```{r prep change in ag wages since peak year, include=FALSE, cache=TRUE}

aw.2018 <- ag.ind.wages.county %>%
  filter(periodyear == 2018) %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  rename(ag.wages.2018 = ag.wages,
         total.wages.2018 = total.wages)

aw.earned.peak <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(aw.peak.year[,c(1,3)], by = c("countyfp", "periodyear")) %>%
  left_join(aw.2018[,c(3,5,6)], by = "countyfp") %>%
  mutate(aw.pct.tw.peak = ag.wages / total.wages,
         aw.pct.tw.2018 = ag.wages.2018 / total.wages.2018,
         change.aw.pct.tw = 100* (aw.pct.tw.2018 - aw.pct.tw.peak),
         change.aw.peak.2018 = (ag.wages.2018 - ag.wages)/ag.wages)


aw.earned.peak.select.edrs <- aw.earned.peak %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE")) %>%
  mutate(change.aw.peak.2018.bins = cut(change.aw.peak.2018,
                                     breaks = c(-1, -.5, -.3, -.1, -.01, 1),
                                     labels = c("-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))) %>%
  mutate(change.aw.peak.2018.bins = ifelse(edr %in% c("EDR  1 - Northwest", "EDR  4 - West Central", "EDR  6E- Southwest Central", "EDR  6W- Upper Minnesota Valley", "EDR  8 - Southwest", "EDR  9 - South Central"), as.character(change.aw.peak.2018.bins), NA),
         change.aw.peak.2018.bins = fct_relevel(change.aw.peak.2018.bins, "-50% or less", "-50% to -30%", "-30% to -10%", "-10% to -1%", "No change"))

```

<br>

## Counties most disrupted by ag-related wages{.tabset}

The previous sections highlighted the fact that wages from ag-related industries play a relatively minor role in most regions across the state. Therefore, we are going to focus on EDRs 6W - Upper MN Valley, 8 - Southwest, and 9 - South Central. We will filter the counties further by only including ones whose 10% of total wages originated from ag-related industries at some point since 2003. This leaves us with 14 counties to examine;

**6W - Upper MN Valley**

* Swift
* Lac qui Parle

**8 - Southwest**

* Cottonwood
* Lyon
* Murray
* Pipestone
* Redwood
* Rock

**9 - South Central**

* Brown
* Faribault
* Le Sueur
* Martin
* Sibley
* Watonwan

The charts below provide the ag-related wages and total wages indexed to 2003 levels to see if any of the trends match across the charts. This will help us identify which counties are most impacted by ag-related industries.

Overall, a large majority of the counties have not had their total wages impacted by ag-related industries. There is plenty of fluctuation in the trends of wages earned in ag-related industries, both up and down. However, these bumps and valleys rarely show up in the total wages earned charts.

There are a few counties that definitely seem to be impacted positively from ag-related industries. Both Sibley and Watonwan County have experienced significant growth in their wages from ag-related industries while also experiencing significant total wage growth. By 2018, wages from ag-related industries made up 38% of total wages in Sibley, 34% in Watowan.

On the flip side, there is one county that clearly seems to be impacted negatively by downturns in the ag-related industries. Lac qui Parle seems the most impacted in state. By 2018, wages earned in ag-related industries have dropped to 66% of what they were in 2003 and fell from making up 20% of the total wages in the region to 6%. In addition, their growth in total wages has stagnated since 2011.  




<br>

### EDR 6W - Upper MN Valley

The impact from the drop in ag-related wages earned in Lac qui Parle may have impacted the total wages as total wages in general have plateaued around the same time that wages in ag-related industries tanked. 

On the other hand, the drop in ag related wages in Swift County has not impacted the total wage growth at all since growth continued desipte the drop in ag-related wages earned. 
 

<br>

```{r prep ag wage trends for counties with highest percentage, include=FALSE, cache=TRUE}
aw.sig.counties.match <- ag.ind.wages.county %>%
  filter(planning.region == "Southwest Minnesota") %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages) %>%
  filter(aw.pct.tw > .099999) %>%
  distinct(areaname, countyfp)

aw.tw.index <- ag.ind.wages.county %>%
  group_by(periodyear, areaname, countyfp, edr) %>%
  summarise(ag.wages = sum(wages[naicstitle != "Total, All Industries"], na.rm = TRUE),
            total.wages = sum(wages[naicstitle == "Total, All Industries"], na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(aw.sig.counties.match, by = c("countyfp", "areaname")) %>%
  filter(periodyear > 2002) %>%
  group_by(areaname, countyfp) %>%
  mutate(ag.wages.index = ag.wages / ag.wages[periodyear == 2003],
         total.wages.index = total.wages / total.wages[periodyear == 2003]) %>%
  ungroup() %>%
  mutate(aw.pct.tw = ag.wages / total.wages) %>%
  gather(key = "wage.type", value = "index", 7:8) %>%
  mutate(wage.type = str_replace(wage.type, "ag.wages.index", "Ag wages index"),
         wage.type = str_replace(wage.type, "total.wages.index", "Total wages index")) %>%
  group_by(wage.type) %>%
  mutate(data_id = seq(periodyear))

```

```{r charts aw tw index of edr 6w, fig.width=8}
aw.tw.6w.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  6W- Upper Minnesota Valley"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 6W - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.6w.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDR  8 - Southwest

EDR 8 really highlights how little wages from ag-related industries impacts total wages. Rock County has seen it's wages earned from ag-related industries skyrocket over 500% by 2006, making up 12% of total wages in the county. Since then, it has fluctuated around that percentage all the way until 2018. By 2018, ag-related wages are 596% what they were in 2003, yet only make up 8% of the total wages in the county. 

Many of the counties follow this similar pattern. There are some small drops and big increases but nothing that really seems to appear in the trends of total wages.

<br>

```{r charts aw tw index of edr 6, fig.width=8}
aw.tw.8.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  8 - Southwest"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 8 - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.8.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```

### EDR  9 - South Central

There are a few counties here where wages earned from ag-related industries likely impacts the total wages of the county.

Sibley is very likely to have experienced it's total wage growth because of the growth in ag-related wages. By 2018, wages earned in ag-related industries grew by 510% since 2003 and made up 38% of the total wages in the county. Total wages for Sibley grew by 179%.

Another County similar to Sibley is Watonwan where they have experienced consistent growth in the wages earned from ag-related industries and their total wages have grown considerably as well. Currently, wages from ag-related industries comprises 34% of the total wages earned.

There is an outlier data point for Faribault that is throwing off the numbers there and not sure what they is due to. 

<br>

```{r charts aw tw index of edr 9, fig.width=8}
aw.tw.9.index.plot <- ggplot(filter(aw.tw.index, edr == "EDR  9 - South Central"), aes(periodyear, index, color = areaname)) +
    geom_smooth(se = FALSE, size = 2) +
  geom_hline(yintercept = 1, color = "black") +
  facet_wrap(~wage.type, ncol = 2, scales = "free_y") +
    geom_point_interactive(size = 3, aes(data_id = data_id, tooltip = paste(areaname, "\nYear: ", periodyear, "\nWages earned from ag industries: ", dollar(ag.wages), "\nWages as percent of 2003 levels: ", percent(index), "\nAg wages as a % of total wages: ", percent(aw.pct.tw), sep = ""))) +
    labs(x="", y = "", color="", title = "EDR 9 - Wages earned from ag-related industries as a percent of 2003 levels")+
    scale_y_continuous(labels=scales::percent)+
    scale_x_continuous(breaks = seq(1900, 2050, 2)) +
    theme_line+
    scale_color_discrete(guide = guide_legend(ncol = 3)) +
    theme(legend.position = "bottom",
          text = element_text(size = 12),
          axis.text.x = element_text(size = 10))

girafe( ggobj = aw.tw.9.index.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))
```
