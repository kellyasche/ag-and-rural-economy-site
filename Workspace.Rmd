---
title: "Workspace"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles, cache=TRUE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc))

edr.pr <- counties.regions %>%
  distinct(edr, .keep_all = TRUE) %>%
  select(5,6) %>%
  mutate(edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r master land value and net income objects, include=FALSE, cache=TRUE}
master.netinc.county <- read_csv("Data/Income and expenses/Master-farm-income-expenses.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  left_join(counties.regions[,c(1,2)], by = "countyfp") %>%
  filter(Name != "Minnesota")

master.lv.county <- read_csv("Data/Land values/Master-ag-land-values.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  rename(year = Year) %>%
  filter(County != "Minnesota") %>%
  rename(Name = County)

```

```{r prep net income and land values index, include=FALSE, cache=TRUE}
net.income.acre.ruca <- master.netinc.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.ruca <- master.lv.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.pr <- master.netinc.county %>%
  group_by(planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.pr <- master.lv.county %>%
  group_by(planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.edr <- master.netinc.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(edr, planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.edr <- master.lv.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

```

```{r prep year of peak net income, include=FALSE, cache=TRUE}
net.inc.peak.year.ruca <- net.income.acre.ruca %>%
  group_by(Dem_Desc) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.ruca <- land.value.acre.ruca %>%
  right_join(net.inc.peak.year.ruca[,c(1,2)], by = c("Dem_Desc", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.ruca <- net.income.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.ruca <- land.value.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.ruca <- net.inc.change.peak.year.ruca %>%
  left_join(land.value.change.peak.year.ruca[,c(1,4,5,9,10,11)], by = "Dem_Desc") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))


net.inc.peak.year.pr <- net.income.acre.pr %>%
  group_by(planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.pr <- land.value.acre.pr %>%
  right_join(net.inc.peak.year.pr[,c(1,2)], by = c("planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.pr <- net.income.acre.pr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.pr<- land.value.acre.pr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.pr <- net.inc.change.peak.year.pr %>%
  left_join(land.value.change.peak.year.pr[,c(1,4,5,9,10,11)], by = "planning.region") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"),
         planning.region = str_replace(planning.region, "Seven County Mpls-St Paul", "Seven County\nMpls-St Paul"))



net.inc.peak.year.edr <- net.income.acre.edr %>%
  group_by(edr, planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 3,
         net.income.peak = 4,
         total.acre.peak = 5,
         net.income.acre.peak = 6)

land.value.peak.year.edr <- land.value.acre.edr %>%
  right_join(net.inc.peak.year.edr[,c(1,2,3)], by = c("edr", "planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 3,
         total.acres.peak = 4,
         total.value.peak = 5,
         land.value.acre.peak = 6)

net.inc.change.peak.year.edr <- net.income.acre.edr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.edr<- land.value.acre.edr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.edr <- net.inc.change.peak.year.edr %>%
  left_join(land.value.change.peak.year.edr[,c(1,2,5, 6,10,11,12)], by = c("edr", "planning.region")) %>%
  gather(key = "income.land", value = "pct.change", 12, 17) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))

```

<br>

## Counties - land values most negatively impacted by farm incomes

As the previous charts have shown, land values have remained stubbornly high despite the massive change in net farm incomes. Most of the regions in the state actually have higher land values in 2018 than when net farm incomes peaked. This could be due to a slower response by land values, and they increased for a few years after net farm incomes peaked, but have been declining over the last few years but just happen to still be above values when incomes peaked. But our concern here is identifying counties where land values have decreased enough where they are below values when incomes peaked. 

The previous charts have provided us characteristics to look for in counties that are likely being negatively impacted by decreasing land values;

* 2018 agricultural land values that are below their values,
* likely in our most rural counties,
* and located in EDR 6W, EDR 8, and EDR 7E.

The maps below provide the change in net farm income since they peaked (most likely between 2012 - 2014) as well as the change in ag-land values since that peak year. 

Net farm incomes have declined between 50% and 100% since they peaked. There are a few counties that have declined more but those have occurred in counties not really considered "ag counties" such as in the central lakes area of the state.

On the flip side, most counties in Minnesota have higher ag-land values in 2018 than when net farm income peaked. In most cases, the values are 10% to 35% higher. However, this is not the case in Southwest Minnesota where land values are between 10% and 25% less in 2018 than when net incomes peaked.


```{r prep net income change vs. land value change since peak map, include = FALSE, cache=TRUE}
net.inc.lv.peak.county <- master.netinc.county %>%
  select(1,3,6,7) %>%
  mutate(net.income.acre = net.income / Total.acres) %>%
  group_by(countyfp) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  arrange(desc(year)) %>%
  distinct(countyfp, .keep_all = TRUE) %>%
  ungroup() %>%
  rename(peak.year = year,
         net.income.acre.peak = net.income.acre) %>%
  left_join(master.lv.county[,c(2,6,7)], by = c("peak.year" = "year", "countyfp"))

net.inc.lv.change.peak.county <- master.netinc.county %>%
  filter(year == 2018) %>%
  select(1,3,6,7,12) %>%
  mutate(net.income.acre = net.income / Total.acres) %>%
  rename(net.income.acre.2018 = net.income.acre) %>%
  left_join(master.lv.county[,c(2,6,7)], by = c("year", "countyfp")) %>%
  left_join(net.inc.lv.peak.county[,c(1,2,5,6)], by = "countyfp") %>%
  mutate(net.income.acre.change = (net.income.acre.2018 - net.income.acre.peak) / net.income.acre.peak,
         lv.acre.change = (Estimated.value.per.acre.x - Estimated.value.per.acre.y) / Estimated.value.per.acre.y,
         net.income.acre.change.bins = cut(net.income.acre.change,
                                           breaks = c(-10, -2, -1, 0, .5, 1, 10),
                                           labels = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%")),
         lv.acre.change.bins = cut(lv.acre.change,
                                   breaks = c(-10, -2, -1, 0, .5, 1, 10),
                                   labels = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```

<br>

```{r maps net income change vs. land value change since peak map, fig.width=9}

net.inc.change.peak.county.plot <- ggplot(net.inc.lv.change.peak.county) +
  geom_sf_interactive(aes(fill = net.income.acre.change.bins, tooltip = paste(Name, "\nPeak year of net farm income: ", peak.year, "\nNet income per acre in peak year: ", dollar(net.income.acre.peak), "\nValue of ag-land per acre in peak year: ", dollar(Estimated.value.per.acre.y), "\nNet income per acre in 2018: ", dollar(net.income.acre.2018), "\nChange in net farm income since peak year: ", percent(net.income.acre.change), "\nValue of ag-land per acre in 2018: ", dollar(Estimated.value.per.acre.x), "\nChange in land values since peak year: ", percent(lv.acre.change), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(breaks = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"),
                    values = c("Less than -200%" = "#bd0026", "-200% to -100%" = "#fd8d3c", "-100% to -0%" = "#ffffb2", "0% to 50%" = "#C7EF99", "50% to 100%" = "#6AC400", "Greater than 100%"="#076324"), drop = FALSE)+
  theme_sf+
  labs(title="Change in net farm income since peak year") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

lv.change.peak.county.plot <- ggplot(net.inc.lv.change.peak.county) +
  geom_sf_interactive(aes(fill = lv.acre.change.bins, tooltip = paste(Name, "\nPeak year of net farm income: ", peak.year, "\nNet income per acre in peak year: ", dollar(net.income.acre.peak), "\nValue of ag-land per acre in peak year: ", dollar(Estimated.value.per.acre.y), "\nNet income per acre in 2018: ", dollar(net.income.acre.2018), "\nChange in net farm income since peak year: ", percent(net.income.acre.change), "\nValue of ag-land per acre in 2018: ", dollar(Estimated.value.per.acre.x), "\nChange in land values since peak year: ", percent(lv.acre.change), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(breaks = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"),
                    values = c("Less than -200%" = "#bd0026", "-200% to -100%" = "#fd8d3c", "-100% to -0%" = "#ffffb2", "0% to 50%" = "#C7EF99", "50% to 100%" = "#6AC400", "Greater than 100%"="#076324"), drop = FALSE)+
  theme_sf+
  labs(title="Change in ag-land values since peak year") +
  theme(text = element_text(size = 10))

net.inc.change.peak.county.legend <- get_legend(net.inc.change.peak.county.plot + theme(legend.box.margin = margin(0,0,0,0)))

net.inc.change.peak.county.legend.bottom <- plot_grid(NULL, net.inc.change.peak.county.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))


girafe(ggobj = plot_grid(net.inc.change.peak.county.plot + theme(legend.position = "none"), lv.change.peak.county.plot + theme(legend.position = "none"), NULL, net.inc.change.peak.county.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

Here is a list of the counties where land values have been impacted the most by the downturn in the ag economy.

<br>

```{r table counties most impacted}
most.impacted.counties <- net.inc.lv.change.peak.county %>%
  left_join(counties.regions[,c(1,4,5,6)], by = "countyfp") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", "")) %>%
  select(5,16,17,18,8,9,6,11,10,7,12) %>%
  filter(lv.acre.change < 0,
         !planning.region %in% c("Seven County Mpls-St Paul", "Northeast")) %>%
  rename(RUCA = Dem_Desc,
         "Year net farm income peaked" = 5,
         "Net farm income in peak year"= 6,
         "Net farm income in 2018" = 7,
         "Change in net farm income" = 8,
         "Ag-land value in peak year" = 9,
         "Ag-land value in 2018" = 10,
         "Change in value of ag-land" = 11)

datatable(most.impacted.counties, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatCurrency(6:7, "$") %>%
  formatCurrency(9:10, "$") %>%
  formatPercentage(8) %>%
  formatPercentage(11)

```
