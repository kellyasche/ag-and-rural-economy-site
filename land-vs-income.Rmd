---
title: "Land values vs. net income"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<link rel="stylesheet" href="styles.css" type="text/css">


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
```

```{r loading jon docs and shapefiles}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        text = element_text(size = 15),
        plot.caption = element_text(hjust = 0.5, face = "italic"),
        legend.text = element_text(margin = margin(l = 2, r = 5)))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         edr = str_replace(edr, "  ", " "))

color.ruca <- c("Entirely rural" = "#5CA81F", "Town/rural mix" = "#C7EF99", "Urban/town/rural mix" = "#d8b365", "Entirely urban" = "#a6611a", "Minnesota" = "black")

color.pr <- c("Northwest" = "#810f7c","Northeast" = "#fe9929", "Central" = "#076324", "Seven County Mpls-St Paul" = "#d8b365", "Southwest" = "#1f78b4", "Southeast" = "#d7301f", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.counties <- scale_color_brewer(palette = "Dark2",
                       guide = guide_legend(ncol = 3))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE)
```

```{r master land value and net income objects, include=FALSE, cache=TRUE}
master.netinc.county <- read_csv("Data/Income and expenses/Master-farm-income-expenses.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  left_join(counties.regions[,c(1,2)], by = "countyfp") %>%
  filter(Name != "Minnesota")

master.lv.county <- read_csv("Data/Land values/Master-ag-land-values.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = str_replace(edr, "  ", " "),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota")) %>%
  rename(year = Year) %>%
  filter(County != "Minnesota") %>%
  rename(Name = County)

```

<br>

# Summary

Not surprisingly, the trend of net income from farming is the same as the price of crop commodities; increasing from the early 2000s to the early 2010s, followed by significant decreases. 

The value of agricultural land follows the increases of net incomes from farming from the early 2000s, but does not experience significant decreases since peaking in the early 2010s. Although the increases have plateaued, only our most rural areas have experienced any sort of decrease in their ag-land values.

At the EDR level, 7E - East Central, 6W - Upper Minnesota Valley, and 8 - Southwest all have lower land values in 2018 than when net farm incomes peaked (typically between 2012 and 2014). Everywhere else, agricultural land values are typically 15% to 40% higher than when net farm incomes peaked.

The counties that seem to be most significantly impacted by the downturn in prices of crop commodities are;

<br>
 
```{r most impacted counties summary table}
most.impacted.counties.summary.table <- read_csv("Data/Land values/most-impacted-counties-table.csv") %>%
  select(1,2,3,4,8,11)

datatable(most.impacted.counties.summary.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatPercentage(5:6)
```

<br>


# Definitions

**Definition of net income**: Net income is calculated by adding the cash receipts from marketings to other income and subtracting the production expenses.

**Definition of cash receipts from marketings**: consists of the gross revenue received by farmers from the sale of crops, livestock, and livestock products and of the value of defaulted loans made by Commodity Credit Corporation (CCC) and secured by crops.

**Definition of other income**: comprised of Government Payments and Imputed and miscellaneous income received.

**Definition of production expenses**: Farm production expenses consist of purchases of feed, livestock and poultry, seed, fertilizer, agricultural chemicals and lime, and petroleum products; labor expenses; machinery rental and custom work; animal health costs; and all other expenses including depreciation. BEA adjusts the USDA state estimates of production expenses to account for methodological differences in the treatment of depreciation and to conform to BEA definitions and classifications.

**Definition of class 2a agricultural land**: The estimated land values are taking from the University of Minnesota - Land Economics program. The estimates used are based estimates provided by county assessors and is for Class 2a agricultural land. This is all land that can be cultivated for row crops or grains.

<br> 

# Analysis

This analysis examines the changes in net farm incomes and the value of agriculture land. We do this through the following sections;

**Net income from farming per acre vs. land value per acre**: We would expect that the value of agricultural land would increase and decrease in a similar fashion to net farm incomes. These charts will show us where this is true or not.

**Changes in net income vs. changes in land values since the year of peak net farm incomes**: It is expected that the net incomes from farming have likely decreased since the prices of commodities peaked between 2012 and 2014. These charts will examine the change in farm incomes as well as the change in land values since the year net incomes peaked in each region.

**Counties - land values most negatively impacted by farm incomes**: The previous sections will help us identify specific regions where the downturn in crop commodity prices are impacted the value of agricultural land. This section attempts to identify specific counties where the impacts might be most intense.

<br>

```{r prep net income and land values index, include=FALSE, cache=TRUE}
net.income.acre.ruca <- master.netinc.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.ruca <- master.lv.county %>%
  group_by(Dem_Desc, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(Dem_Desc) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.pr <- master.netinc.county %>%
  group_by(planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.pr <- master.lv.county %>%
  group_by(planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

net.income.acre.edr <- master.netinc.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(net.income = sum(net.income, na.rm = TRUE),
            total.acres = sum(Total.acres, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(net.income.acre = net.income / total.acres) %>%
  group_by(edr, planning.region) %>%
  mutate(net.income.acre.index = net.income.acre / net.income.acre[year == 2001]) %>%
  ungroup()

land.value.acre.edr <- master.lv.county %>%
  group_by(edr, planning.region, year) %>%
  summarise(total.acres = sum(Total.acres, na.rm = TRUE),
            total.value = sum(Total.estimated.value, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(land.value.acre = total.value / total.acres) %>%
  group_by(planning.region) %>%
  mutate(land.value.acre.index = land.value.acre / land.value.acre[year == 2001]) %>%
  ungroup()

```

## Net income from farming per acre vs. land value per acre {.tabset}

When comparing the net income from farming and the land values, the most striking trend is that land values significantly increased along with net income during the late 2000’s and early 2010’s. However, now that net income is significantly lower, below breaking even in some places, land values have barely decreased. Interestingly, land values in our more metro areas of the state have stayed significantly higher than traditional agricultural regions due to residential and commercial development pressures.

The highest values, outside of the seven county metro, are found in the Southwest and Southeast parts of the state. Surprisingly, land values in Northwest Minnesota have remained significantly lower than other parts of the state.

<br>

### RUCA

The trend of net incomes for farms across the county groups is not surprising. It's pretty easy to see where the crop commodity boom began and ended. Every region across the state saw a spike in farm land values during this time frame. Land values are beginning to drop slightly across the state but nowhere near the rate of decline experienced in net incomes. In addition, the Entirely urban counties aren't really seeing much of a decline, likely due to those land values being driven by commercial and residential development pressure.

<br>

```{r chart net income and land value index ruca, fig.width=8}

net.income.acre.ruca.plot <- ggplot(net.income.acre.ruca, aes(year, net.income.acre, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = net.income.acre.index, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nTotal farm net income: ", dollar(net.income), "\nTotal acres: ", comma(total.acres), "\nNet income per acre: ", dollar(net.income.acre), "\nNet income per acre indexed to 2001 levels: ", percent(net.income.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Net income per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

land.value.acre.ruca.plot <- ggplot(land.value.acre.ruca, aes(year, land.value.acre, color = Dem_Desc)) +
  geom_smooth(se = FALSE, size = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = land.value.acre, tooltip = paste(Dem_Desc, "\nYear: ", year, "\nTotal acres: ", comma(total.acres), "\nTotal estimated land value: ", dollar(total.value),  "\nLand value per acre: ", dollar(land.value.acre), "\nLand value per acre indexed to 2001 levels: ", percent(land.value.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Land value per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  coord_cartesian(ylim = seq(-250,7000, 200)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

net.income.acre.ruca.plot.legend <- get_legend(net.income.acre.ruca.plot + theme(legend.box.margin = margin(0,0,0,0)))

net.income.acre.ruca.plot.legend.bottom <- plot_grid(NULL, net.income.acre.ruca.plot.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe(ggobj = plot_grid(net.income.acre.ruca.plot + theme(legend.position = "none"), land.value.acre.ruca.plot + theme(legend.position = "none"), NULL, net.income.acre.ruca.plot.legend.bottom, ncol = 2, rel_heights = c(1, .1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Regions where land values seem to be reacting the most to farm net incomes are the Southwest and Southeast. Interestingly, land in the Northwest isn't as high as expected. But maybe we will see more nuance there when broken down by EDR.

In the Southwest region, land values peaked in 2014 at $7,670 per acre and have dropped over $1,000 to $6,365. 

The Southeast region had land values peak in 2014 as well at $6,642 and have dropped over $500 per acre to $6,091.

<br>

```{r chart net income and land value index pr, fig.width=8}

net.income.acre.pr.plot <- ggplot(net.income.acre.pr, aes(year, net.income.acre, color = planning.region)) +
  geom_smooth(se = FALSE, size = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = net.income.acre.index, tooltip = paste(planning.region, "\nYear: ", year, "\nTotal farm net income: ", dollar(net.income), "\nTotal acres: ", comma(total.acres), "\nNet income per acre: ", dollar(net.income.acre), "\nNet income per acre indexed to 2001 levels: ", percent(net.income.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Net income per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

land.value.acre.pr.plot <- ggplot(land.value.acre.pr, aes(year, land.value.acre, color = planning.region)) +
  geom_smooth(se = FALSE, size = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = land.value.acre, tooltip = paste(planning.region, "\nYear: ", year, "\nTotal acres: ", comma(total.acres), "\nTotal estimated land value: ", dollar(total.value),  "\nLand value per acre: ", dollar(land.value.acre), "\nLand value per acre indexed to 2001 levels: ", percent(land.value.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Land value per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  coord_cartesian(ylim = seq(-3250,13000, 2500)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10))

net.income.acre.pr.plot.legend <- get_legend(net.income.acre.pr.plot + theme(legend.box.margin = margin(0,0,0,0)))

net.income.acre.pr.plot.legend.bottom <- plot_grid(NULL, net.income.acre.pr.plot.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe(ggobj = plot_grid(net.income.acre.pr.plot + theme(legend.position = "none"), land.value.acre.pr.plot + theme(legend.position = "none"), NULL, net.income.acre.pr.plot.legend.bottom, ncol = 2, rel_heights = c(1, .1)), width_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR

In the Northwest region, the trend line for land values in EDR 4 - West Central indicates some decline over the last few years and are likely being impacted by falling net incomes.

In Central MN, land values in EDR 6E - Southwest Central have declined over the last few years indicating impacts from falling net farm incomes.

All the EDRs in Southwest MN show declines in land values over the last few years. This is also where the highest land values are found among agriculture regions.



<br>

```{r chart net income and land value index edr, fig.height=10}

net.income.acre.edr.plot <- ggplot(net.income.acre.edr, aes(year, net.income.acre, color = edr)) +
  geom_smooth(se = FALSE, size = 1) +
  facet_wrap(~planning.region, ncol = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = net.income.acre.index, tooltip = paste(edr, "\nYear: ", year, "\nTotal farm net income: ", dollar(net.income), "\nTotal acres: ", comma(total.acres), "\nNet income per acre: ", dollar(net.income.acre), "\nNet income per acre indexed to 2001 levels: ", percent(net.income.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Net income per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.x = element_text(size = 6))

land.value.acre.edr.plot <- ggplot(land.value.acre.edr, aes(year, land.value.acre, color = edr)) +
  geom_smooth(se = FALSE, size = 1) +
  facet_wrap(~planning.region, ncol = 1) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 2, aes(data_id = land.value.acre, tooltip = paste(edr, "\nYear: ", year, "\nTotal acres: ", comma(total.acres), "\nTotal estimated land value: ", dollar(total.value),  "\nLand value per acre: ", dollar(land.value.acre), "\nLand value per acre indexed to 2001 levels: ", percent(land.value.acre.index), sep = ""))) +
  labs(x="", y = "", color="", title = "Land value per farm acre")+
  scale_y_continuous(labels=scales::dollar)+
  coord_cartesian(ylim = seq(-3250,13000, 2500)) +
  scale_x_continuous(breaks = seq(1900, 2050, 2)) +
  theme_line+
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 4)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.x = element_text(size = 6))

net.income.acre.edr.plot.legend <- get_legend(net.income.acre.edr.plot + theme(legend.box.margin = margin(0,0,0,0)))

net.income.acre.edr.plot.legend.bottom <- plot_grid(NULL, net.income.acre.edr.plot.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))

girafe(ggobj = plot_grid(net.income.acre.edr.plot + theme(legend.position = "none"), land.value.acre.edr.plot + theme(legend.position = "none"), NULL, net.income.acre.edr.plot.legend.bottom, ncol = 2, rel_heights = c(1, .1)), height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Changes in net income vs. changes in land values since year of peak net incomes {.tabset}

In the charts below, land value per acre represents agricultural 2a land. 

The charts provide a comparison of the change in net farm income since the year when net incomes were the highest in each region (which is typically between 2012 and 2014) and the change in agricultural land values since that same year. With the downturn in crop commodities, we would expect land values to be below what they were when net farm income peaked. However, as the previous charts have shown, that may not be the case. 

Interestingly, agricultural land values are higher in 2018 then they were when net farm incomes peaked in nearly all regions across the state. The only areas where this doesn't seem to be the case are in our most rural areas of the state. At the EDR level, 7E - East Central, 6W - Upper Minnesota Valley, and 8 - Southwest all have lower land values in 2018 than when net farm incomes peaked.

Everywhere else, agricultural land values are typically 15% to 40% higher than when net farm incomes peaked.

<br>

```{r prep year of peak net income, include=FALSE, cache=TRUE}
net.inc.peak.year.ruca <- net.income.acre.ruca %>%
  group_by(Dem_Desc) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.ruca <- land.value.acre.ruca %>%
  right_join(net.inc.peak.year.ruca[,c(1,2)], by = c("Dem_Desc", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.ruca <- net.income.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.ruca <- land.value.acre.ruca %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.ruca[,c(1,2,3,4,5)], by = "Dem_Desc") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.ruca <- net.inc.change.peak.year.ruca %>%
  left_join(land.value.change.peak.year.ruca[,c(1,4,5,9,10,11)], by = "Dem_Desc") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))


net.inc.peak.year.pr <- net.income.acre.pr %>%
  group_by(planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 2,
         net.income.peak = 3,
         total.acre.peak = 4,
         net.income.acre.peak = 5)

land.value.peak.year.pr <- land.value.acre.pr %>%
  right_join(net.inc.peak.year.pr[,c(1,2)], by = c("planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 2,
         total.acres.peak = 3,
         total.value.peak = 4,
         land.value.acre.peak = 5)


net.inc.change.peak.year.pr <- net.income.acre.pr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.pr<- land.value.acre.pr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.pr[,c(1,2,3,4,5)], by = "planning.region") %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.pr <- net.inc.change.peak.year.pr %>%
  left_join(land.value.change.peak.year.pr[,c(1,4,5,9,10,11)], by = "planning.region") %>%
  gather(key = "income.land", value = "pct.change", 11, 16) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"),
         planning.region = str_replace(planning.region, "Seven County Mpls-St Paul", "Seven County\nMpls-St Paul"))



net.inc.peak.year.edr <- net.income.acre.edr %>%
  group_by(edr, planning.region) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  ungroup() %>%
  rename(peak.year = 3,
         net.income.peak = 4,
         total.acre.peak = 5,
         net.income.acre.peak = 6)

land.value.peak.year.edr <- land.value.acre.edr %>%
  right_join(net.inc.peak.year.edr[,c(1,2,3)], by = c("edr", "planning.region", "year" = "peak.year")) %>%
  rename(peak.year = 3,
         total.acres.peak = 4,
         total.value.peak = 5,
         land.value.acre.peak = 6)

net.inc.change.peak.year.edr <- net.income.acre.edr %>%
  filter(year == 2018) %>%
  left_join(net.inc.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.net.income.acre = (net.income.acre - net.income.acre.peak) / net.income.acre.peak)

land.value.change.peak.year.edr<- land.value.acre.edr %>%
  filter(year == 2018) %>%
  left_join(land.value.peak.year.edr[,c(1,2,3,4,5,6)], by = c("planning.region", "edr")) %>%
  mutate(pct.change.land.value.acre = (land.value.acre - land.value.acre.peak) / land.value.acre.peak)

net.inc.land.value.change.peak.year.edr <- net.inc.change.peak.year.edr %>%
  left_join(land.value.change.peak.year.edr[,c(1,2,5, 6,10,11,12)], by = c("edr", "planning.region")) %>%
  gather(key = "income.land", value = "pct.change", 12, 17) %>%
  mutate(income.land = ifelse(income.land == "pct.change.net.income.acre", "Change in net farm income per acre", "Change in land value per farm acre"))

```

### RUCA

Net farm income peaked in 2013 in entirely rural counties and since that time net income has decreased by 80%, while land values have only decreased 3.4%. 

The rest of the county groups had their net farm income per acre peak in 2012 and since that time have had their net incomes drop a similar amount to entirely rural counties while land value per acre is 25% to 30% higher in 2018 than in 2012. 

<br>

```{r chart change in net inc and land value since peak year rucA}

net.inc.land.value.change.peak.year.ruca.plot <- ggplot(net.inc.land.value.change.peak.year.ruca, aes(x = Dem_Desc, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 3,aes(data_id = Dem_Desc, tooltip = paste(Dem_Desc, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank())+
        scale_color_manual(values = c("#8c510a", "#076324"))


girafe(ggobj = net.inc.land.value.change.peak.year.ruca.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### Planning Region

Overall, net farm income per acre peaked between 2012 - 2014 for all planning regions and have decreased between 70% and 95%. Across most regions, land values per acre are still 2% to 40% higher than they were during the peak farm income years. Land values have decreased, however, in Southwest Minnesota where they are 8% of the value they were in 2013, the peak farm income year.


<br>

```{r chart change in net inc and land value since peak year pr}

net.inc.land.value.change.peak.year.pr.plot <- ggplot(net.inc.land.value.change.peak.year.pr, aes(x = planning.region, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point_interactive(size = 3,aes(data_id = planning.region, tooltip = paste(planning.region, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank())+
        scale_color_manual(values = c("#8c510a", "#076324"))


girafe(ggobj = net.inc.land.value.change.peak.year.pr.plot, width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

### EDR

Except for EDRs 7E - East Central, 6W - Upper Minnesota Valley, and 8 - Southwest, all other EDRs have slightly higher land values in 2018 than they did when net farm incomes peaked. 

<br>

```{r chart change in net inc and land value since peak year edr, fig.height=10}

net.inc.land.value.change.peak.year.edr.plot <- ggplot(net.inc.land.value.change.peak.year.edr, aes(x = edr, y = pct.change, color = income.land)) +
  geom_hline(yintercept = 0, color = "black") +
  facet_wrap(~planning.region, ncol = 2, scales = "free_x") +
  geom_point_interactive(size = 3,aes(data_id = edr, tooltip = paste(edr, "\nYear of peak net farm income: ", peak.year, "\nNet income per acre during peak year: ", dollar(net.income.acre.peak), "\nLand value per acre during peak year: ", dollar(land.value.acre.peak), "\nNet income per acre in 2018: ", dollar(net.income.acre), "\nLand value per acre in 2018: ", dollar(land.value.acre), "\n", income.land, ": ", percent(pct.change), sep = ""))) +
  labs(x="", y = "", title = "Percent change in net farm income and land value per acre\nsince net farm income peaked")+
        scale_y_continuous(labels=scales::percent)+
        theme_bar+
        theme(legend.position = "bottom",
              legend.title = element_blank(),
              text = element_text(size = 10),
              axis.text.x = element_text(size = 6, angle = 15, vjust = .8))+
        scale_color_manual(values = c("#8c510a", "#076324"))

girafe(ggobj = net.inc.land.value.change.peak.year.edr.plot, height_svg = 9) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

## Counties - land values most negatively impacted by farm incomes

As the previous charts have shown, land values have remained stubbornly high despite the massive change in net farm incomes. Most of the regions in the state actually have higher land values in 2018 than when net farm incomes peaked. This could be due to a slower response by land values, and they increased for a few years after net farm incomes peaked, but have been declining over the last few years but just happen to still be above values when incomes peaked. But our concern here is identifying counties where land values have decreased enough where they are below values when incomes peaked. 

The previous charts have provided us characteristics to look for in counties that are likely being negatively impacted by decreasing land values;

* 2018 agricultural land values that are below their values,
* likely in our most rural counties,
* and located in EDR 6W, EDR 8, and EDR 7E.

The maps below provide the change in net farm income since they peaked (most likely between 2012 - 2014) as well as the change in ag-land values since that peak year. 

Net farm incomes have declined between 50% and 100% since they peaked. There are a few counties that have declined more but those have occurred in counties not really considered "ag counties" such as in the central lakes area of the state.

On the flip side, most counties in Minnesota have higher ag-land values in 2018 than when net farm income peaked. In most cases, the values are 10% to 35% higher. However, this is not the case in Southwest Minnesota where land values are between 10% and 25% less in 2018 than when net incomes peaked.


```{r prep net income change vs. land value change since peak map, include = FALSE, cache=TRUE}
net.inc.lv.peak.county <- master.netinc.county %>%
  select(1,3,6,7) %>%
  mutate(net.income.acre = net.income / Total.acres) %>%
  group_by(countyfp) %>%
  top_n(n = 1, wt = net.income.acre) %>%
  arrange(desc(year)) %>%
  distinct(countyfp, .keep_all = TRUE) %>%
  ungroup() %>%
  rename(peak.year = year,
         net.income.acre.peak = net.income.acre) %>%
  left_join(master.lv.county[,c(2,6,7)], by = c("peak.year" = "year", "countyfp"))

net.inc.lv.change.peak.county <- master.netinc.county %>%
  filter(year == 2018) %>%
  select(1,3,6,7,12) %>%
  mutate(net.income.acre = net.income / Total.acres) %>%
  rename(net.income.acre.2018 = net.income.acre) %>%
  left_join(master.lv.county[,c(2,6,7)], by = c("year", "countyfp")) %>%
  left_join(net.inc.lv.peak.county[,c(1,2,5,6)], by = "countyfp") %>%
  mutate(net.income.acre.change = (net.income.acre.2018 - net.income.acre.peak) / net.income.acre.peak,
         lv.acre.change = (Estimated.value.per.acre.x - Estimated.value.per.acre.y) / Estimated.value.per.acre.y,
         net.income.acre.change.bins = cut(net.income.acre.change,
                                           breaks = c(-10, -2, -1, 0, .5, 1, 10),
                                           labels = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%")),
         lv.acre.change.bins = cut(lv.acre.change,
                                   breaks = c(-10, -2, -1, 0, .5, 1, 10),
                                   labels = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"))) %>%
  left_join(mn_counties[,c(4,7)], by = c("countyfp" = "FIPS_CODE"))

```

<br>

```{r maps net income change vs. land value change since peak map, fig.width=9}

net.inc.change.peak.county.plot <- ggplot(net.inc.lv.change.peak.county) +
  geom_sf_interactive(aes(fill = net.income.acre.change.bins, tooltip = paste(Name, "\nPeak year of net farm income: ", peak.year, "\nNet income per acre in peak year: ", dollar(net.income.acre.peak), "\nValue of ag-land per acre in peak year: ", dollar(Estimated.value.per.acre.y), "\nNet income per acre in 2018: ", dollar(net.income.acre.2018), "\nChange in net farm income since peak year: ", percent(net.income.acre.change), "\nValue of ag-land per acre in 2018: ", dollar(Estimated.value.per.acre.x), "\nChange in land values since peak year: ", percent(lv.acre.change), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(breaks = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"),
                    values = c("Less than -200%" = "#bd0026", "-200% to -100%" = "#fd8d3c", "-100% to -0%" = "#ffffb2", "0% to 50%" = "#C7EF99", "50% to 100%" = "#6AC400", "Greater than 100%"="#076324"), drop = FALSE)+
  theme_sf+
  labs(title="Change in net farm income since peak year") +
  theme(text = element_text(size = 10),
        legend.position = "bottom")

lv.change.peak.county.plot <- ggplot(net.inc.lv.change.peak.county) +
  geom_sf_interactive(aes(fill = lv.acre.change.bins, tooltip = paste(Name, "\nPeak year of net farm income: ", peak.year, "\nNet income per acre in peak year: ", dollar(net.income.acre.peak), "\nValue of ag-land per acre in peak year: ", dollar(Estimated.value.per.acre.y), "\nNet income per acre in 2018: ", dollar(net.income.acre.2018), "\nChange in net farm income since peak year: ", percent(net.income.acre.change), "\nValue of ag-land per acre in 2018: ", dollar(Estimated.value.per.acre.x), "\nChange in land values since peak year: ", percent(lv.acre.change), sep = ""), data_id = Name, geometry = geometry)) +
  scale_fill_manual(breaks = c("Less than -200%", "-200% to -100%", "-100% to -0%", "0% to 50%", "50% to 100%", "Greater than 100%"),
                    values = c("Less than -200%" = "#bd0026", "-200% to -100%" = "#fd8d3c", "-100% to -0%" = "#ffffb2", "0% to 50%" = "#C7EF99", "50% to 100%" = "#6AC400", "Greater than 100%"="#076324"), drop = FALSE)+
  theme_sf+
  labs(title="Change in ag-land values since peak year") +
  theme(text = element_text(size = 10))

net.inc.change.peak.county.legend <- get_legend(net.inc.change.peak.county.plot + theme(legend.box.margin = margin(0,0,0,0)))

net.inc.change.peak.county.legend.bottom <- plot_grid(NULL, net.inc.change.peak.county.legend, NULL, ncol = 3, rel_widths = c(0,.5,3))


girafe(ggobj = plot_grid(net.inc.change.peak.county.plot + theme(legend.position = "none"), lv.change.peak.county.plot + theme(legend.position = "none"), NULL, net.inc.change.peak.county.legend.bottom, ncol = 2, rel_heights = c(1,.1)), width_svg = 8) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE) ,
                 opts_sizing(rescale = FALSE))

```

<br>

Here is a list of the counties where land values have been impacted the most by the downturn in the ag economy.

<br>

```{r table counties most impacted}
most.impacted.counties <- net.inc.lv.change.peak.county %>%
  left_join(counties.regions[,c(1,4,5,6)], by = "countyfp") %>%
  mutate(planning.region = str_replace(planning.region, " Minnesota", "")) %>%
  select(5,16,17,18,8,9,6,11,10,7,12) %>%
  filter(lv.acre.change < 0,
         !planning.region %in% c("Seven County Mpls-St Paul", "Northeast")) %>%
  rename(RUCA = Dem_Desc,
         "Year net farm income peaked" = 5,
         "Net farm income in peak year"= 6,
         "Net farm income in 2018" = 7,
         "Change in net farm income" = 8,
         "Ag-land value in peak year" = 9,
         "Ag-land value in 2018" = 10,
         "Change in value of ag-land" = 11)


datatable(most.impacted.counties, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(scrollX = TRUE)) %>%
  formatCurrency(6:7, "$") %>%
  formatCurrency(9:10, "$") %>%
  formatPercentage(8) %>%
  formatPercentage(11)

```




